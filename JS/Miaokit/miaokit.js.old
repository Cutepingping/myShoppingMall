"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var AEdgeType,ATexture=function(){function t(e){_classCallCheck(this,t),this.m_mAttachment=new Handle(Attachment,0),this.m_mOffset=new Vector2(0,0),this.m_mScale=new Vector2(0,0),this.m_nRotate=0,this.m_pDesc=null,this.m_bUpdated=!1,this.desc=e}return _createClass(t,[{key:"Remap",value:function(t){this.m_mAttachment.Heap=t}},{key:"Apply",value:function(){this.m_bUpdated&&(this.m_bUpdated=!1)}},{key:"Destroy",value:function(){this.m_bUpdated=!1,this.m_pDesc=null}},{key:"Clear",value:function(){}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){t.ReadUInt32();this.m_mAttachment.Number=t.ReadUInt32(),this.m_mOffset.x=t.ReadSingle(),this.m_mOffset.y=t.ReadSingle(),this.m_mScale.x=t.ReadSingle(),this.m_mScale.y=t.ReadSingle(),this.m_nRotate=t.ReadSingle(),501347081!=t.ReadInt32()&&alert("ATexture.UnSerialize(): Bad end!"),this.m_bUpdated=!0}},{key:"Inherit",value:function(t){var e=t;return this.rotate=e.rotate,!0}},{key:"version",get:function(){return 1e3}},{key:"type",get:function(){return EntityType.Collection}},{key:"attachment",get:function(){return this.m_mAttachment.Object},set:function(t){this.m_mAttachment.Number=t.handle.Number,this.m_bUpdated=!0}},{key:"displayType",get:function(){return DisplayType.Normal},set:function(t){}},{key:"resource",get:function(){return this.texture}},{key:"collectionType",get:function(){return CollectionType.ATexture}},{key:"desc",set:function(t){null==this.m_pDesc&&(this.offset=new Vector2(0,0),this.scale=new Vector2(1,1),this.rotate=0,this.m_pDesc=t,this.m_bUpdated=!0)}},{key:"offset",get:function(){return new Vector2(this.m_mOffset.x,this.m_mOffset.y)},set:function(t){this.m_mOffset.x=t.x,this.m_mOffset.y=t.y}},{key:"scale",get:function(){return new Vector2(this.m_mScale.x,this.m_mScale.y)},set:function(t){this.m_mScale.x=t.x,this.m_mScale.y=t.y}},{key:"rotate",get:function(){return this.m_nRotate},set:function(t){this.m_nRotate=t}},{key:"texture",get:function(){return null==this.m_pDesc?null:this.m_pDesc.m_pTexture}},{key:"textureSize",get:function(){return null==this.m_pDesc?new Vector2(0,0):new Vector2(this.m_pDesc.m_mSize.x,this.m_pDesc.m_mSize.x)}}]),t}(),ATextureDesc=function(){function t(){_classCallCheck(this,t),this.m_nID=0,this.m_nCategoryID=0,this.m_pName=null,this.m_mSize=new Vector2(0,0),this.m_pTextureUrl=null,this.m_pIconUrl=null,this.m_pTexture=null,this.m_pModelType=null}return _createClass(t,[{key:"Init",value:function(t){}},{key:"Destory",value:function(){this.m_pTexture=null}},{key:"Load",value:function(t,e){if(null==this.m_pTextureUrl||this.m_pTextureUrl.length<1)e(null);else{var n=this;MiaokitDC.DC.m_pAssetsLoader.LoadTexture(this.m_pTextureUrl,function(t){n.m_pTexture=t,e(null)})}}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){var e=t.ReadUInt32();if(this.m_nID=t.ReadInt32(),this.m_nCategoryID=t.ReadInt32(),this.m_pName=t.ReadString(),this.m_mSize.x=t.ReadSingle(),this.m_mSize.y=t.ReadSingle(),this.m_pTextureUrl=t.ReadString(),this.m_pIconUrl=t.ReadString(),this.m_pModelType=t.ReadString(),e>1e3&&(this.m_pTextureUrl=t.ReadString()),e>1001)t.ReadString();else;501347081!=t.ReadInt32()&&alert("ATexture.Desc.UnSerialize(): Bad end!")}},{key:"version",get:function(){return 1001}},{key:"id",get:function(){return this.m_nID}},{key:"typeId",get:function(){return this.m_nCategoryID}},{key:"name",get:function(){return this.m_pName}},{key:"desc",get:function(){return""}},{key:"iconUrl",get:function(){return this.m_pIconUrl}},{key:"resource",get:function(){return this.m_pTexture}}]),t}(),AHoleModel=function(){function t(e){_classCallCheck(this,t),this.m_mAttachment=new Handle(Attachment,0),this.m_bEnabled=!1,this.m_bFlip=!1,this.m_mOffset=new Vector3(0,0,0),this.m_mPosition=new Vector3(0,0,0),this.m_mEulerAngles=new Vector3(0,0,0),this.m_mLocalScale=new Vector3(0,0,0),this.m_pModel=null,this.m_pPatch=null,this.m_pDesc=null,this.m_bUpdated=!1,this.desc=e,this.m_bEnabled=!0,this.m_bFlip=!1,this.m_mOffset=new Vector3(0,null==this.m_pDesc?0:this.m_pDesc.m_nDefaultHeight,0),this.m_mLocalScale=new Vector3(1,1,1)}return _createClass(t,[{key:"Remap",value:function(t){this.m_mAttachment.Heap=t}},{key:"Apply",value:function(){if(this.m_bUpdated){var t=null!=this.attachment&&this.attachment.active;null!=this.model&&this.model.SetActive(t),this.m_bUpdated=!1}}},{key:"Destroy",value:function(){this.m_bUpdated=!1,this.m_pModel=null,this.m_pPatch.Destroy(),this.m_pPatch=null}},{key:"Clear",value:function(){}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){t.ReadUInt32();this.m_mAttachment.Number=t.ReadUInt32(),this.m_bEnabled=t.ReadBoolean(),this.m_bFlip=t.ReadBoolean(),this.m_mOffset.x=t.ReadSingle(),this.m_mOffset.y=t.ReadSingle(),this.m_mOffset.z=t.ReadSingle(),this.m_mPosition.x=t.ReadSingle(),this.m_mPosition.y=t.ReadSingle(),this.m_mPosition.z=t.ReadSingle(),this.m_mEulerAngles.x=t.ReadSingle(),this.m_mEulerAngles.y=t.ReadSingle(),this.m_mEulerAngles.z=t.ReadSingle(),this.m_mLocalScale.x=t.ReadSingle(),this.m_mLocalScale.y=t.ReadSingle(),this.m_mLocalScale.z=t.ReadSingle(),501347081!=t.ReadInt32()&&alert("ATexture.UnSerialize(): Bad end!"),this.m_bUpdated=!0}},{key:"Inherit",value:function(t){var e=t;return this.enabled=e.enabled,this.flip=e.flip,this.size=e.size,this.offset=e.offset,this.Apply(),!0}},{key:"CreateObject",value:function(t,e){if(null==this.m_pModel||null!=t){this.m_pModel=this.m_pDesc.m_pModel.CloneModel();var n=this.m_pModel.AddHook();n.attachment=this.attachment,n.SetLayer(),this.attachment.hook=n}null!=this.model&&(this.position=this.position,this.eulerAngles=this.eulerAngles,null!=t&&(this.model.parent=t),this.model.SetActive(!0))}},{key:"version",get:function(){return 1e3}},{key:"type",get:function(){return EntityType.Collection}},{key:"attachment",get:function(){return this.m_mAttachment.Object},set:function(t){this.m_mAttachment.Number=t.handle.Number,this.m_bUpdated=!0}},{key:"displayType",get:function(){return DisplayType.Normal},set:function(t){}},{key:"resource",get:function(){return this.model}},{key:"collectionType",get:function(){return CollectionType.AHoleModel}},{key:"desc",set:function(t){null==this.m_pDesc&&(this.m_pDesc=t,this.m_bUpdated=!0)}},{key:"enabled",get:function(){return this.m_bEnabled},set:function(t){this.m_bEnabled=t,null!=this.model&&this.model.SetActive(this.m_bEnabled),null!=this.patch&&this.patch.SetActive(this.m_bEnabled)}},{key:"flip",get:function(){return this.m_bFlip},set:function(t){this.m_bFlip=t,this.eulerAngles=new Vector3(0,57.29578*(3.14159274-this.m_mOffset.z)+(this.m_bFlip?180:0),0)}},{key:"size",get:function(){return new Vector3(this.defaultSize.x*this.localScale.x,this.defaultSize.y*this.localScale.y,this.defaultSize.z*this.localScale.z)},set:function(t){this.localScale=new Vector3(t.x/this.defaultSize.x,t.y/this.defaultSize.y,t.z/this.defaultSize.z)}},{key:"defaultSize",get:function(){return null==this.m_pDesc?new Vector3(1,1,1):this.m_pDesc.m_mSize}},{key:"offset",get:function(){return new Vector3(this.m_mOffset.x,this.m_mOffset.y,this.m_mOffset.z)},set:function(t){this.m_mOffset.x=t.x,this.m_mOffset.y=t.y,this.m_mOffset.z=t.z,this.m_mEulerAngles=new Vector3(0,57.29578*(3.14159274-this.m_mOffset.z)+(this.m_bFlip?180:0),0)}},{key:"position",get:function(){return new Vector3(this.m_mPosition.x,this.m_mPosition.y,this.m_mPosition.z)},set:function(t){this.m_mPosition.x=t.x,this.m_mPosition.y=t.y,this.m_mPosition.z=t.z,null!=this.model&&(this.model.position=this.m_mPosition),this.m_bUpdated=!0}},{key:"eulerAngles",get:function(){return new Vector3(this.m_mEulerAngles.x,this.m_mEulerAngles.y,this.m_mEulerAngles.z)},set:function(t){this.m_mEulerAngles.x=t.x,this.m_mEulerAngles.y=t.y,this.m_mEulerAngles.z=t.z,null!=this.model&&(this.model.eulerAngles=this.m_mEulerAngles),this.m_bUpdated=!0}},{key:"localScale",get:function(){return new Vector3(this.m_mLocalScale.x,this.m_mLocalScale.y,this.m_mLocalScale.z)},set:function(t){this.m_mLocalScale.x=t.x,this.m_mLocalScale.y=t.y,this.m_mLocalScale.z=t.z,null!=this.model&&(this.model.localScale=this.m_mLocalScale),this.m_bUpdated=!0}},{key:"model",get:function(){return this.m_pModel}},{key:"patch",get:function(){return this.m_pPatch},set:function(t){this.m_pPatch=t}}]),t}(),AHoleModelDesc=function(){function t(){_classCallCheck(this,t),this.m_nID=0,this.m_nCategoryID=0,this.m_pName=null,this.m_nDefaultHeight=0,this.m_mSize=new Vector3(0,0,0),this.m_pModelUrl=null,this.m_pIconUrl=null,this.m_pModel=null,this.m_pModelType=null}return _createClass(t,[{key:"Init",value:function(t){}},{key:"Destory",value:function(){this.m_pModel=null}},{key:"Load",value:function(t,e){if(null==this.m_pModelUrl||this.m_pModelUrl.length<1)e(null);else{var n=this;MiaokitDC.DC.m_pAssetsLoader.LoadModel(n.m_pModelUrl,function(t){n.m_pModel=t,n.m_pModel.m_pName=n.m_pName,e()})}}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){var e=t.ReadUInt32();if(this.m_nID=t.ReadInt32(),this.m_nCategoryID=t.ReadInt32(),this.m_pName=t.ReadString(),this.m_nDefaultHeight=t.ReadSingle(),this.m_mSize.x=t.ReadSingle(),this.m_mSize.y=t.ReadSingle(),this.m_mSize.z=t.ReadSingle(),this.m_pModelUrl=t.ReadString(),this.m_pIconUrl=t.ReadString(),this.m_pModelType=t.ReadString(),e>1e3&&(this.m_pModelUrl=t.ReadString()),e>1001)t.ReadString();else;501347081!=t.ReadInt32()&&alert("AHoleModel.Desc.UnSerialize(): Bad end!")}},{key:"version",get:function(){return 1001}},{key:"id",get:function(){return this.m_nID}},{key:"typeId",get:function(){return this.m_nCategoryID}},{key:"name",get:function(){return this.m_pName}},{key:"desc",get:function(){return""}},{key:"iconUrl",get:function(){return this.m_pIconUrl}},{key:"resource",get:function(){return this.m_pModel}}]),t}(),Handle=function(){function t(e,n){_classCallCheck(this,t),this.m_nDataID=0,this.CLASS=void 0,this.m_nDataID=n,this.CLASS=e}return _createClass(t,[{key:"Destroy",value:function(){var t=this.CLASS.g_pContext.GetHeap(this.m_nDataID);null!=t&&t.Delete(this.m_nDataID)}},{key:"Transfer",value:function(t){var e=this.CLASS.g_pContext.GetHeap(this.m_nDataID);return null!=e&&e.Transfer(this.m_nDataID,t.Number)}},{key:"Equals",value:function(t){return null!=t?this.Number==t.Number:null}},{key:"Heap",set:function(t){0!=this.m_nDataID&&(this.m_nDataID=(4294967040&this.m_nDataID)+(255&t.Number))}},{key:"Object",get:function(){var t=this.CLASS.g_pContext.GetHeap(this.m_nDataID);return null!=t?t.Get(this.m_nDataID):null}},{key:"Number",get:function(){return this.m_nDataID},set:function(t){this.m_nDataID=t}}]),t}(),ListHandle=function(){function t(e,n){_classCallCheck(this,t),this.m_nListID=0,this.CLASS=void 0,this.m_nListID=n,this.CLASS=e}return _createClass(t,[{key:"CreateData",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=this.CLASS.g_pContext.GetHeap(this.m_nListID),i=0;return null!=n&&(i=n.CreateData(this.m_nListID,t,e)),new Handle(this.CLASS,i)}},{key:"Destroy",value:function(){var t=this.CLASS.g_pContext.GetHeap(this.m_nListID);null!=t&&this.m_nListID>256&&t.Delete(this.m_nListID)}},{key:Symbol.iterator,value:function(){var t=this.CLASS.g_pContext.GetHeap(this.m_nListID),e=null!=t?t.m_aEntries:null,n=null==e?0:e[this.m_nListID>>8].m_nNext,i=0;return{next:function(){return null!=e&&(i=0==i?n:e[i].m_nNext)>0?{value:e[i].m_pData,done:!1}:{value:void 0,done:!0}}}}},{key:"Heap",set:function(t){0!=this.m_nListID&&(this.m_nListID=(4294967040&this.m_nListID)+(255&t.Number))}},{key:"Count",get:function(){var t=this.CLASS.g_pContext.GetHeap(this.m_nListID);return null!=t?t.Count(this.m_nListID):0}},{key:"Valid",get:function(){var t=this.CLASS.g_pContext.GetHeap(this.m_nListID);return null!=t&&t.Valid(this.m_nListID)}},{key:"Number",get:function(){return this.m_nListID},set:function(t){this.m_nListID=t}}]),t}(),HeapHandle=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;_classCallCheck(this,t),this.m_nHeapID=0,this.m_pHeap=null,this.CLASS=void 0,this.m_nHeapID=255&n,this.m_pHeap=null,this.CLASS=e}return _createClass(t,[{key:"InitHeap",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return 0==this.m_nHeapID>>8&&(this.m_nHeapID=this.CLASS.g_pContext.CreateHeap(this.m_nHeapID)),this.m_nHeapID>4294967040&&(this.m_pHeap=this.CLASS.g_pContext.InitHeap(this.m_nHeapID,t),!0)}},{key:"CreateData",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=0;return null!=this.m_pHeap&&(n=this.m_pHeap.CreateData(0,t,e)),new Handle(this.CLASS,n)}},{key:"CreateList",value:function(){var t=0;return null!=this.m_pHeap&&(t=this.m_pHeap.CreateList()),new ListHandle(this.CLASS,t)}},{key:"GetDefaultList",value:function(){return new ListHandle(this.CLASS,255&this.m_nHeapID)}},{key:"Serialize",value:function(t){null!=this.m_pHeap&&this.m_pHeap.Serialize(t)}},{key:"Destroy",value:function(){null!=this.m_pHeap&&(this.m_pHeap.Destroy(),this.m_pHeap=null)}},{key:Symbol.iterator,value:function(){var t=null!=this.m_pHeap?this.m_pHeap.m_aEntries:null,e=0;return{next:function(){if(null!=t)for(e++;e<t.length;){if(null!=t[e].m_pData)return{value:t[e].m_pData,done:!1};e++}return{value:void 0,done:!0}}}}},{key:"Count",get:function(){return null!=this.m_pHeap?this.m_pHeap.m_nDataNum:0}},{key:"ListCount",get:function(){return null!=this.m_pHeap?this.m_pHeap.m_nListNum:0}},{key:"Number",get:function(){return this.m_nHeapID},set:function(t){this.m_nHeapID=255&t,this.m_pHeap=null}}]),t}(),HeapContext=function(){function t(e){_classCallCheck(this,t),this.m_nHeapNum=0,this.m_aHeap=new Array(256),this.CLASS=e}return _createClass(t,[{key:"CreateHeap",value:function(t){if(t&=255,255==this.m_nHeapNum)return 4294967040;if(0!=t&&null==this.m_aHeap[t])return this.m_aHeap[t]=this.NewHeap(),this.m_nHeapNum++,(t|=4294967040)>>>0;t>0&&console.warn("HeapContext.CreateHeap(): !nExpectID.",t);for(var e=1;e<256;++e)if(null==this.m_aHeap[e])return this.m_aHeap[e]=this.NewHeap(),this.m_nHeapNum++,4294967040+e>>>0;return 4294967040}},{key:"InitHeap",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;t&=255;var n=this.m_aHeap[t];if(null!=n){if(0==n.m_nHeapID)return n.m_nHeapID=t,n.UnSerialize(e),n;if(t==n.m_nHeapID)return n.m_nCurID=1,n.m_nCapacity=1,n.m_nDataNum=0,n.m_nListNum=0,n.m_aEntries=null,n.UnSerialize(e),n}return null}},{key:"GetHeap",value:function(t){return this.m_aHeap[255&t]}},{key:"SwitchState",value:function(t){null==t&&(t=new Array(256));var e=this.m_aHeap;this.m_aHeap=t,this.m_nHeapNum=0;for(var n=0;n<256;n++)null!=this.m_aHeap[n]&&++this.m_nHeapNum;return e}},{key:"NewObject",value:function(){return new this.CLASS}},{key:"NewHeap",value:function(){return new ObjectHeap(this)}}]),t}(),ObjectHeap=function(){function t(e){_classCallCheck(this,t),this.m_nHeapID=0,this.m_nCurID=1,this.m_nCapacity=1,this.m_nDataNum=0,this.m_nListNum=1,this.m_aEntries=null,this.m_pContext=null,this.m_pContext=e}return _createClass(t,[{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){if(null!=t)if(this.m_nHeapID!=t.ReadUInt32()&&console.info("ObjectHeap.UnSerialize(): m_nHeapID != pReader.ReadUInt32()"),this.m_nCurID=t.ReadUInt32(),this.m_nCapacity=t.ReadUInt32(),this.m_nDataNum=t.ReadInt32(),this.m_nListNum=t.ReadInt32(),1!=this.m_nCapacity){this.m_aEntries=new Array(this.m_nCapacity);for(var e=0;e<this.m_nCapacity;e++)this.m_aEntries[e]=new HeapEntry;for(var n=0,i=t.ReadUInt32();4294967295!=i;)this.m_aEntries[i].m_nIndex=t.ReadUInt32(),this.m_aEntries[i].m_nLast=t.ReadUInt32(),this.m_aEntries[i].m_nNext=t.ReadUInt32(),4294967295!=this.m_aEntries[i].m_nLast&&(this.m_aEntries[i].m_pData=this.m_pContext.NewObject(),this.m_aEntries[i].m_pData.UnSerialize(t),this.m_aEntries[i].m_pData.OnEmploy(this.m_nHeapID+(i<<8))),++n,i=t.ReadUInt32();n!=this.m_nDataNum+this.m_nListNum&&alert("ObjectHeap.UnSerialize(): nCount != this.m_nDataNum + this.m_nListNum.");for(var a=1;a<this.m_nCapacity;a++)if(4294967295!=this.m_aEntries[a].m_nLast&&null==this.m_aEntries[a].m_pData){var o=a;this.m_nCurID=a;for(var s=a+1;s<this.m_nCapacity;s++)4294967295!=this.m_aEntries[s].m_nLast&&null==this.m_aEntries[s].m_pData&&(this.m_aEntries[o].m_nIndex=s,o=s);this.m_aEntries[o].m_nIndex=this.m_nCapacity;break}}else 4294967295!=t.ReadUInt32()&&alert("ObjectHeap.UnSerialize(): 0xFFFFFFFF != pReader.ReadUInt32()")}},{key:"Destroy",value:function(){this.m_pContext.m_aHeap[this.m_nHeapID]==this?(this.m_pContext.m_aHeap[this.m_nHeapID]=null,this.m_pContext.m_nHeapNum--):alert("ObjectHeap.Destroy(): this.m_pContext.m_aHeap[this.m_nHeapID] != this.")}},{key:"Get",value:function(t){return(t>>=8)<this.m_nCapacity&&4294967295!=this.m_aEntries[t].m_nLast?this.m_aEntries[t].m_pData:null}},{key:"Count",value:function(t){return(t>>=8)<this.m_nCapacity&&null!=this.m_aEntries&&4294967295==this.m_aEntries[t].m_nLast?this.m_aEntries[t].m_nIndex:0}},{key:"Valid",value:function(t){return(t>>=8)<this.m_nCapacity&&4294967295==this.m_aEntries[t].m_nLast}},{key:"CreateData",value:function(t,e,n){if(0!=(t>>=8)&&(t>=this.m_nCapacity||4294967295!=this.m_aEntries[t].m_nLast))return 0;var i=this.CreateID(t,e),a=this.m_nHeapID+(i<<8);return null==n&&(n=this.m_pContext.NewObject()).OnCreate(a),this.m_aEntries[i].m_pData=n,n.OnEmploy(a),this.m_nDataNum++,a}},{key:"CreateList",value:function(){var t=this.CreateID(4294967295,0),e=this.m_nHeapID+(t<<8);return this.m_nListNum++,e}},{key:"Delete",value:function(t){if((t>>=8)<this.m_nCapacity&&(null!=this.m_aEntries[t].m_pData||4294967295==this.m_aEntries[t].m_nLast))if(4294967295==this.m_aEntries[t].m_nLast){for(var e=this.m_aEntries[t].m_nNext;0<e;)this.m_aEntries[e].m_pData.OnUnemploy(),this.DeleteID(e),this.m_nDataNum--,e=this.m_aEntries[t].m_nNext;this.DeleteID(t),this.m_nListNum--}else this.m_aEntries[t].m_pData.OnUnemploy(),this.DeleteID(t),this.m_nDataNum--}},{key:"Transfer",value:function(t,e){if(this.m_nHeapID==(255&e)&&(t>>=8,(e>>=8)<this.m_nCapacity&&4294967295==this.m_aEntries[e].m_nLast&&t<this.m_nCapacity&&4294967295!=this.m_aEntries[t].m_nLast)){var n=this.m_aEntries[t].m_nLast,i=this.m_aEntries[t].m_nIndex,a=this.m_aEntries[t].m_nNext;return this.m_aEntries[n].m_nNext=a,a>0&&(this.m_aEntries[a].m_nLast=n),this.m_aEntries[i].m_nIndex--,n=i=e,(a=this.m_aEntries[n].m_nNext)>0&&(this.m_aEntries[a].m_nLast=t),this.m_aEntries[n].m_nNext=t,this.m_aEntries[t].m_nIndex=i,this.m_aEntries[t].m_nLast=n,this.m_aEntries[t].m_nNext=a,this.m_aEntries[i].m_nIndex++,!0}return!1}},{key:"CreateID",value:function(t,e){if(this.m_nCurID==this.m_nCapacity){if(null==this.m_aEntries&&1==this.m_nCapacity){var n=new HeapEntry;n.m_nIndex=0,n.m_nLast=4294967295,n.m_nNext=0,this.m_aEntries=new Array,this.m_aEntries.push(n)}var i=new HeapEntry;i.m_nIndex=this.m_nCapacity+1,this.m_aEntries.push(i),this.m_nCapacity++}var a=this.m_nCurID;if(this.m_nCurID=this.m_aEntries[a].m_nIndex,4294967295!=t){for(var o=t,s=this.m_aEntries[o].m_nNext;0<e&&s>0;)o=s,s=this.m_aEntries[o].m_nNext;s>0&&(this.m_aEntries[s].m_nLast=a),this.m_aEntries[o].m_nNext=a,this.m_aEntries[a].m_nIndex=t,this.m_aEntries[a].m_nLast=o,this.m_aEntries[a].m_nNext=s,this.m_aEntries[t].m_nIndex++}else this.m_aEntries[a].m_nIndex=0,this.m_aEntries[a].m_nLast=4294967295,this.m_aEntries[a].m_nNext=0;return a}},{key:"DeleteID",value:function(t){var e=this.m_aEntries[t].m_nLast;if(4294967295!=e){var n=this.m_aEntries[t].m_nIndex,i=this.m_aEntries[t].m_nNext;this.m_aEntries[e].m_nNext=i,i>0&&(this.m_aEntries[i].m_nLast=e),this.m_aEntries[n].m_nIndex--}this.m_aEntries[t].m_pData=null,this.m_aEntries[t].m_nIndex=this.m_nCurID,this.m_aEntries[t].m_nLast=0,this.m_aEntries[t].m_nNext=0,this.m_nCurID=t}}]),t}(),HeapEntry=function t(){_classCallCheck(this,t),this.m_pData=null,this.m_nIndex=0,this.m_nLast=0,this.m_nNext=0};!function(t){t[t.Default=0]="Default",t[t.Model=1]="Model",t[t.Virtual=2]="Virtual"}(AEdgeType||(AEdgeType={}));var APoint=function(){function t(){_classCallCheck(this,t),this.m_mHandle=new Handle(t,0),this.m_mAdjoinList=new ListHandle(AAdjoin,0),this.m_mPosition=new Vector3(0,0,0),this.m_nDegrees=0}return _createClass(t,[{key:"OnCreate",value:function(t){}},{key:"OnEmploy",value:function(e){this.m_mHandle=new Handle(t,e)}},{key:"OnUnemploy",value:function(){}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){t.ReadUInt32();this.m_mHandle.Number=t.ReadUInt32(),this.m_mAdjoinList.Number=t.ReadUInt32(),this.m_mPosition.x=t.ReadSingle(),this.m_mPosition.y=t.ReadSingle(),this.m_mPosition.z=t.ReadSingle(),this.m_nDegrees=t.ReadInt32(),501347081!=t.ReadInt32()&&alert("APoint.UnSerialize(): Bad end!")}},{key:"version",get:function(){return 1e3}}]),t}();APoint.g_pContext=new HeapContext(APoint);var AAdjoin=function(){function t(){_classCallCheck(this,t),this.m_mHandle=new Handle(t,0),this.m_mAdjPoint=new Handle(APoint,0),this.m_mEdge=new Handle(AEdge,0),this.m_mLastAdjoin=new Handle(t,0),this.m_mNextAdjoin=new Handle(t,0)}return _createClass(t,[{key:"OnCreate",value:function(t){}},{key:"OnEmploy",value:function(e){this.m_mHandle=new Handle(t,e)}},{key:"OnUnemploy",value:function(){}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){t.ReadUInt32();this.m_mHandle.Number=t.ReadUInt32(),this.m_mAdjPoint.Number=t.ReadUInt32(),this.m_mEdge.Number=t.ReadUInt32(),this.m_mLastAdjoin.Number=t.ReadUInt32(),this.m_mNextAdjoin.Number=t.ReadUInt32(),this.m_nAngle=t.ReadSingle(),501347081!=t.ReadInt32()&&alert("AAdjoin.UnSerialize(): Bad end!")}},{key:"version",get:function(){return 1e3}}]),t}();AAdjoin.g_pContext=new HeapContext(AAdjoin);var AEdge=function(){function t(){_classCallCheck(this,t),this.m_mHandle=new Handle(t,0),this.m_eType=AEdgeType.Default,this.m_nAngle=0,this.m_mScale=new Vector3(0,0,0),this.m_mCenter=new Vector3(0,0,0),this.m_mShadeInfo=new Vector4(0,0,0,0),this.m_mLeftPoint=new Handle(APoint,0),this.m_mRightPoint=new Handle(APoint,0),this.m_aTextures=[new Handle(Attachment,0),new Handle(Attachment,0)],this.m_mEdgeModel=new Handle(Attachment,0),this.m_mHoleList=new ListHandle(Attachment,0),this.m_pSketch=null,this.m_pMesh=null}return _createClass(t,[{key:"OnCreate",value:function(t){this.m_pSketch=new Sketch,this.m_pMesh=new AEdgeMesh(this)}},{key:"OnEmploy",value:function(e){this.m_mHandle=new Handle(t,e)}},{key:"OnUnemploy",value:function(){}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){var e=t.ReadUInt32();this.m_mHandle.Number=t.ReadUInt32(),this.m_eType=t.ReadInt32(),this.m_nAngle=t.ReadSingle(),this.m_mScale.x=t.ReadSingle(),this.m_mScale.y=t.ReadSingle(),this.m_mScale.z=t.ReadSingle(),this.m_mCenter.x=t.ReadSingle(),this.m_mCenter.y=t.ReadSingle(),this.m_mCenter.z=t.ReadSingle(),this.m_mLeftPoint.Number=t.ReadUInt32(),this.m_mRightPoint.Number=t.ReadUInt32(),this.m_aTextures[0].Number=t.ReadUInt32(),this.m_aTextures[1].Number=t.ReadUInt32(),this.m_mEdgeModel.Number=t.ReadUInt32(),this.m_mHoleList.Number=t.ReadUInt32(),1==t.ReadBoolean()&&(this.m_pSketch=new Sketch,this.m_pSketch.UnSerialize(t)),this.m_pMesh=new AEdgeMesh(this),e>1e3?(this.m_mShadeInfo.x=t.ReadSingle(),this.m_mShadeInfo.y=t.ReadSingle(),this.m_mShadeInfo.z=t.ReadSingle(),this.m_mShadeInfo.w=t.ReadSingle()):this.m_mShadeInfo=new Vector4(0,1,0,1),501347081!=t.ReadInt32()&&alert("AEdge.UnSerialize(): Bad end!")}},{key:"CreateGeometry",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.m_pMesh.CreateGeometry(t,e)}},{key:"version",get:function(){return 1001}}]),t}();AEdge.g_pContext=new HeapContext(AEdge);var Sketch=function(){function t(){_classCallCheck(this,t),this.m_aTop=null,this.m_aBottom=null,this.m_aTop=[null,null,null,null,null,null],this.m_aBottom=[null,null,null,null,null,null];for(var e=0;e<6;e++)this.m_aTop[e]=new Vector3(0,0,0),this.m_aBottom[e]=new Vector3(0,0,0)}return _createClass(t,[{key:"version",value:function(){return 1e3}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){t.ReadUInt32();for(var e=0;e<6;e++)this.m_aTop[e].x=t.ReadSingle(),this.m_aTop[e].y=t.ReadSingle(),this.m_aTop[e].z=t.ReadSingle(),this.m_aBottom[e].x=t.ReadSingle(),this.m_aBottom[e].y=t.ReadSingle(),this.m_aBottom[e].z=t.ReadSingle();501347081!=t.ReadInt32()&&alert("Sketch.UnSerialize(): Bad end!")}}]),t}(),AMeshData=function t(){_classCallCheck(this,t),this.m_aPosition=null,this.m_aNormal=null,this.m_aTexUV=null,this.m_nCount=0},AMeshBuilder=function(){function t(){_classCallCheck(this,t),this.m_nSize=0,this.m_nCapacity=0,this.m_aPosition=null,this.m_aNormal=null,this.m_aTexUV=null}return _createClass(t,[{key:"Clear",value:function(){this.m_nSize=0}},{key:"PushTriangle",value:function(t,e,n){this.Extend();for(var i=0;i<3;i++){var a=3*this.m_nSize;this.m_aPosition[a]=t[i].x,this.m_aPosition[a+1]=t[i].y,this.m_aPosition[a+2]=t[i].z,this.m_aNormal[a]=e[i].x,this.m_aNormal[a+1]=e[i].y,this.m_aNormal[a+2]=e[i].z,a=2*this.m_nSize,this.m_aTexUV[a]=n[i].x,this.m_aTexUV[a+1]=n[i].y,this.m_nSize++}}},{key:"GetMeshData",value:function(){var t=null;return this.m_nSize>0&&((t=new AMeshData).m_aPosition=this.m_aPosition.slice(0,3*this.m_nSize),t.m_aNormal=this.m_aNormal.slice(0,3*this.m_nSize),t.m_aTexUV=this.m_aTexUV.slice(0,2*this.m_nSize),t.m_nCount=this.m_nSize),t}},{key:"Extend",value:function(){if(this.m_nSize==this.m_nCapacity){var t=this.m_nCapacity+768,e=new Float32Array(3*t);null!=this.m_aPosition&&e.set(this.m_aPosition),this.m_aPosition=e;var n=new Float32Array(3*t);null!=this.m_aNormal&&n.set(this.m_aNormal),this.m_aNormal=n;var i=new Float32Array(2*t);null!=this.m_aTexUV&&i.set(this.m_aTexUV),this.m_aTexUV=i,this.m_nCapacity=t}}}]),t}(),AEdgeMesh=function(){function t(e){_classCallCheck(this,t),this.m_pEdge=null,this.m_aMeshData=[null,null,null,null,null],this.m_pModels=null,this.m_pMesh=null,this.m_pPatchRoot=null,this.m_aSubMesh=null,this.m_aSubMaterial=[null,null,null,null,null],this.m_pEdge=e}return _createClass(t,[{key:"CreateGeometry",value:function(t){!(arguments.length>1&&void 0!==arguments[1])||arguments[1];var e=this.m_pEdge;if(null!=e){this.m_pPatchRoot=t.m_pPatchRoot;var n=e.m_pSketch,i=e.m_mHoleList.Count>0?this.GetHoleSketch(e.m_mHoleList,e.m_nAngle):null;null!=i?e.m_eType==AEdgeType.Model||e.m_eType==AEdgeType.Default&&(this.BuildFrontMesh2(n,i,ALiner.g_aMeshBuilder[0]),this.BuildBackMesh2(n,i,ALiner.g_aMeshBuilder[1]),this.BuildBorderMesh(n,ALiner.g_aMeshBuilder[2]),this.BuildInborderMesh(n,i,ALiner.g_aMeshBuilder[3]),this.BuildShadowMesh(e,ALiner.g_aMeshBuilder[4])):e.m_eType==AEdgeType.Model||e.m_eType==AEdgeType.Default&&(this.BuildFrontMesh(n,ALiner.g_aMeshBuilder[0]),this.BuildBackMesh(n,ALiner.g_aMeshBuilder[1]),this.BuildBorderMesh(n,ALiner.g_aMeshBuilder[2]),this.BuildInborderMesh(n,null,ALiner.g_aMeshBuilder[3]),this.BuildShadowMesh(e,ALiner.g_aMeshBuilder[4]))}}},{key:"PlaceHole",value:function(t,e){var n=this.m_pEdge,i=!0,a=!1,o=void 0;try{for(var s,r=function(){var i=s.value,a=i.entity;if(null!=a&&a.enabled){var o=a.offset;o.z=n.m_nAngle,a.offset=o;var r=i.menuItem.Object;null!=r&&r.LoadAndSet(null,function(n){a.CreateObject(t,e)})}},m=n.m_mHoleList[Symbol.iterator]();!(i=(s=m.next()).done);i=!0)r()}catch(t){a=!0,o=t}finally{try{!i&&m.return&&m.return()}finally{if(a)throw o}}}},{key:"CreateMeshObject",value:function(t){alert("AEdgeMesh.CreateMeshObject(): Discarded."),null==this.m_aSubMesh&&(this.m_aSubMesh=[null,null,null,null,null],this.m_aSubMaterial[0]=new Material(MaterialType.Edge),this.m_aSubMaterial[1]=new Material(MaterialType.Edge),this.m_aSubMaterial[2]=new Material(MaterialType.Border),this.m_aSubMaterial[3]=new Material(MaterialType.Inborder),this.m_aSubMaterial[4]=new Material(MaterialType.AreaBottomShadow),this.m_aSubMaterial[0].SetTextureOffset(1,{x:this.m_pEdge.m_mShadeInfo.x,y:0}),this.m_aSubMaterial[0].SetTextureScale(1,{x:this.m_pEdge.m_mShadeInfo.y,y:-1}),this.m_aSubMaterial[1].SetTextureOffset(1,{x:this.m_pEdge.m_mShadeInfo.z,y:0}),this.m_aSubMaterial[1].SetTextureScale(1,{x:this.m_pEdge.m_mShadeInfo.w,y:-1})),null!=t&&(this.m_pMesh=new GameObject("----Edge: "+(this.m_pEdge.m_mHandle.Number>>8),GameObjectType.Empty),this.m_pMesh.parent=t.m_pEdgeRoot,this.m_aSubMesh[0]=new GameObject("Front",GameObjectType.Mesh),this.m_aSubMesh[1]=new GameObject("Back",GameObjectType.Mesh),this.m_aSubMesh[2]=new GameObject("Border",GameObjectType.Mesh),this.m_aSubMesh[3]=new GameObject("Inborder",GameObjectType.Mesh),this.m_aSubMesh[4]=new GameObject("Shadow",GameObjectType.Mesh),this.m_aSubMesh[0].parent=this.m_pMesh,this.m_aSubMesh[1].parent=this.m_pMesh,this.m_aSubMesh[2].parent=this.m_pMesh,this.m_aSubMesh[3].parent=this.m_pMesh,this.m_aSubMesh[4].parent=this.m_pMesh);for(var e=0;e<5;e++)null!=this.m_aMeshData[e]?(this.m_aSubMesh[e].SetGeometry(this.m_aMeshData[e],this.m_aSubMaterial[e]),this.m_aSubMesh[e].SetActive(!0)):this.m_aSubMesh[e].SetActive(!1)}},{key:"GetHoleSketch",value:function(t,e){var n=new Array,i=Mathf.Sin(e),a=Mathf.Cos(e),o=!0,s=!1,r=void 0;try{for(var m,l=t[Symbol.iterator]();!(o=(m=l.next()).done);o=!0){var h=m.value.entity;if(null!=h&&h.enabled){var _=h.size,u=h.position,c=new Vector3(_.x/2,_.y/2,_.z/2),p=new Sketch;p.m_aBottom[1].x=a*-c.x-i*c.z,p.m_aBottom[1].y=-c.y,p.m_aBottom[1].z=i*-c.x+a*c.z,p.m_aBottom[1].x+=u.x,p.m_aBottom[1].y+=u.y,p.m_aBottom[1].z+=u.z,p.m_aBottom[2].x=a*c.x-i*c.z,p.m_aBottom[2].y=-c.y,p.m_aBottom[2].z=i*c.x+a*c.z,p.m_aBottom[2].x+=u.x,p.m_aBottom[2].y+=u.y,p.m_aBottom[2].z+=u.z,p.m_aBottom[4].x=a*c.x-i*-c.z,p.m_aBottom[4].y=-c.y,p.m_aBottom[4].z=i*c.x+a*-c.z,p.m_aBottom[4].x+=u.x,p.m_aBottom[4].y+=u.y,p.m_aBottom[4].z+=u.z,p.m_aBottom[5].x=a*-c.x-i*-c.z,p.m_aBottom[5].y=-c.y,p.m_aBottom[5].z=i*-c.x+a*-c.z,p.m_aBottom[5].x+=u.x,p.m_aBottom[5].y+=u.y,p.m_aBottom[5].z+=u.z,p.m_aTop[1]=Vector3.Clone(p.m_aBottom[1]),p.m_aTop[1].y+=_.y,p.m_aTop[2]=Vector3.Clone(p.m_aBottom[2]),p.m_aTop[2].y+=_.y,p.m_aTop[4]=Vector3.Clone(p.m_aBottom[4]),p.m_aTop[4].y+=_.y,p.m_aTop[5]=Vector3.Clone(p.m_aBottom[5]),p.m_aTop[5].y+=_.y,n.push(p)}}}catch(t){s=!0,r=t}finally{try{!o&&l.return&&l.return()}finally{if(s)throw r}}return n.length>0?n:null}},{key:"BuildFrontMesh",value:function(e,n){var i=[null,null,null],a=[null,null,null],o=[null,null,null];null==n&&(n=t.g_pMeshBuilder).Clear(),i[0]=Vector3.Clone(e.m_aBottom[5]),i[1]=Vector3.Clone(e.m_aTop[5]),i[2]=Vector3.Clone(e.m_aTop[4]),a[0]=Vector3.Cross(Vector3.Sub(i[1],i[0]),Vector3.Sub(i[2],i[0])),a[1]=Vector3.Clone(a[0]),a[2]=Vector3.Clone(a[1]),o[0]={x:0,y:1},o[1]={x:0,y:0},o[2]={x:1,y:0},n.PushTriangle(i,a,o),i[0]=Vector3.Clone(e.m_aBottom[5]),i[1]=Vector3.Clone(e.m_aTop[4]),i[2]=Vector3.Clone(e.m_aBottom[4]),o[0]={x:0,y:1},o[1]={x:1,y:0},o[2]={x:1,y:1},n.PushTriangle(i,a,o),n==t.g_pMeshBuilder&&(this.m_aMeshData[0]=n.GetMeshData())}},{key:"BuildFrontMesh2",value:function(e,n,i){var a=[null,null,null],o=[null,null,null],s=[null,null,null];null==i&&(i=t.g_pMeshBuilder).Clear(),o[0]=Vector3.Cross(Vector3.Sub(e.m_aTop[5],e.m_aBottom[5]),Vector3.Sub(e.m_aTop[4],e.m_aBottom[5])),o[1]=Vector3.Clone(o[0]),o[2]=Vector3.Clone(o[0]);var r=e.m_aTop[5].y,m=Vector3.Clone(e.m_aBottom[5]),l=Vector3.Clone(e.m_aBottom[4]),h=Vector3.Distance(l,m),_=[null,null,null,null],u=[null,null,null,null];_[0]=Vector3.Clone(e.m_aBottom[5]),_[1]=Vector3.Clone(e.m_aTop[5]),u[0]={x:0,y:1},u[1]={x:0,y:0};for(var c=0;c<n.length;c++){var p=n[c],d=Vector3.Distance(p.m_aBottom[5],m)/h,y=Vector3.Distance(p.m_aBottom[4],m)/h,C=1-p.m_aTop[5].y/r,v=1-p.m_aBottom[5].y/r;_[2]=Vector3.Clone(p.m_aBottom[5]),_[2].y=_[1].y,_[3]=Vector3.Clone(_[2]),_[3].y=0,u[2]={x:d,y:0},u[3]={x:d,y:1},a[0]=Vector3.Clone(_[0]),a[1]=Vector3.Clone(_[1]),a[2]=Vector3.Clone(_[2]),s[0]=Vector2.Clone(u[0]),s[1]=Vector2.Clone(u[1]),s[2]=Vector2.Clone(u[2]),i.PushTriangle(a,o,s),a[0]=Vector3.Clone(_[0]),a[1]=Vector3.Clone(_[2]),a[2]=Vector3.Clone(_[3]),s[0]=Vector2.Clone(u[0]),s[1]=Vector2.Clone(u[2]),s[2]=Vector2.Clone(u[3]),i.PushTriangle(a,o,s),_[0]=Vector3.Clone(p.m_aTop[5]),_[3]=Vector3.Clone(p.m_aTop[4]),_[1]=Vector3.Clone(_[0]),_[1].y=r,_[2]=Vector3.Clone(_[3]),_[2].y=r,u[0]={x:d,y:C},u[1]={x:d,y:0},u[2]={x:y,y:0},u[3]={x:y,y:C},a[0]=Vector3.Clone(_[0]),a[1]=Vector3.Clone(_[1]),a[2]=Vector3.Clone(_[2]),s[0]=Vector2.Clone(u[0]),s[1]=Vector2.Clone(u[1]),s[2]=Vector2.Clone(u[2]),i.PushTriangle(a,o,s),a[0]=Vector3.Clone(_[0]),a[1]=Vector3.Clone(_[2]),a[2]=Vector3.Clone(_[3]),s[0]=Vector2.Clone(u[0]),s[1]=Vector2.Clone(u[2]),s[2]=Vector2.Clone(u[3]),i.PushTriangle(a,o,s),_[1]=Vector3.Clone(p.m_aBottom[5]),_[2]=Vector3.Clone(p.m_aBottom[4]),_[0]=Vector3.Clone(_[1]),_[0].y=0,_[3]=Vector3.Clone(_[2]),_[3].y=0,u[0]={x:d,y:1},u[1]={x:d,y:v},u[2]={x:y,y:v},u[3]={x:y,y:1},a[0]=Vector3.Clone(_[0]),a[1]=Vector3.Clone(_[1]),a[2]=Vector3.Clone(_[2]),s[0]=Vector2.Clone(u[0]),s[1]=Vector2.Clone(u[1]),s[2]=Vector2.Clone(u[2]),i.PushTriangle(a,o,s),a[0]=Vector3.Clone(_[0]),a[1]=Vector3.Clone(_[2]),a[2]=Vector3.Clone(_[3]),s[0]=Vector2.Clone(u[0]),s[1]=Vector2.Clone(u[2]),s[2]=Vector2.Clone(u[3]),i.PushTriangle(a,o,s),_[0]=Vector3.Clone(_[3]),_[1]=Vector3.Clone(_[3]),_[1].y=r,u[0]={x:y,y:1},u[1]={x:y,y:0}}_[2]=e.m_aTop[4],_[3]=e.m_aBottom[4],u[2]={x:1,y:0},u[3]={x:1,y:1},a[0]=Vector3.Clone(_[0]),a[1]=Vector3.Clone(_[1]),a[2]=Vector3.Clone(_[2]),s[0]=Vector2.Clone(u[0]),s[1]=Vector2.Clone(u[1]),s[2]=Vector2.Clone(u[2]),i.PushTriangle(a,o,s),a[0]=Vector3.Clone(_[0]),a[1]=Vector3.Clone(_[2]),a[2]=Vector3.Clone(_[3]),s[0]=Vector2.Clone(u[0]),s[1]=Vector2.Clone(u[2]),s[2]=Vector2.Clone(u[3]),i.PushTriangle(a,o,s),i==t.g_pMeshBuilder&&(this.m_aMeshData[0]=i.GetMeshData())}},{key:"BuildBackMesh",value:function(e,n){var i=[null,null,null],a=[null,null,null],o=[null,null,null];null==n&&(n=t.g_pMeshBuilder).Clear(),i[0]=Vector3.Clone(e.m_aBottom[2]),i[1]=Vector3.Clone(e.m_aTop[2]),i[2]=Vector3.Clone(e.m_aTop[1]),a[0]=Vector3.Cross(Vector3.Sub(i[1],i[0]),Vector3.Sub(i[2],i[0])),a[1]=Vector3.Clone(a[0]),a[2]=Vector3.Clone(a[0]),o[0]={x:0,y:1},o[1]={x:0,y:0},o[2]={x:1,y:0},n.PushTriangle(i,a,o),i[0]=Vector3.Clone(e.m_aBottom[2]),i[1]=Vector3.Clone(e.m_aTop[1]),i[2]=Vector3.Clone(e.m_aBottom[1]),o[0]={x:0,y:1},o[1]={x:1,y:0},o[2]={x:1,y:1},n.PushTriangle(i,a,o),n==t.g_pMeshBuilder&&(this.m_aMeshData[1]=n.GetMeshData())}},{key:"BuildBackMesh2",value:function(e,n,i){var a=[null,null,null],o=[null,null,null],s=[null,null,null];null==i&&(i=t.g_pMeshBuilder).Clear(),o[0]=Vector3.Cross(Vector3.Sub(e.m_aTop[2],e.m_aBottom[2]),Vector3.Sub(e.m_aTop[1],e.m_aBottom[2])),o[1]=Vector3.Clone(o[0]),o[2]=Vector3.Clone(o[0]);var r=e.m_aTop[2].y,m=Vector3.Clone(e.m_aBottom[2]),l=Vector3.Clone(e.m_aBottom[1]),h=Vector3.Distance(l,m),_=[null,null,null,null],u=[null,null,null,null];_[0]=Vector3.Clone(e.m_aBottom[2]),_[1]=Vector3.Clone(e.m_aTop[2]),u[0]={x:0,y:1},u[1]={x:0,y:0};for(var c=n.length-1;c>-1;c--){var p=n[c],d=Vector3.Distance(p.m_aBottom[2],m)/h,y=Vector3.Distance(p.m_aBottom[1],m)/h,C=1-p.m_aTop[2].y/r,v=1-p.m_aBottom[2].y/r;_[2]=Vector3.Clone(p.m_aBottom[2]),_[2].y=_[1].y,_[3]=Vector3.Clone(_[2]),_[3].y=0,u[2]={x:d,y:0},u[3]={x:d,y:1},a[0]=Vector3.Clone(_[0]),a[1]=Vector3.Clone(_[1]),a[2]=Vector3.Clone(_[2]),s[0]=Vector2.Clone(u[0]),s[1]=Vector2.Clone(u[1]),s[2]=Vector2.Clone(u[2]),i.PushTriangle(a,o,s),a[0]=Vector3.Clone(_[0]),a[1]=Vector3.Clone(_[2]),a[2]=Vector3.Clone(_[3]),s[0]=Vector2.Clone(u[0]),s[1]=Vector2.Clone(u[2]),s[2]=Vector2.Clone(u[3]),i.PushTriangle(a,o,s),_[0]=Vector3.Clone(p.m_aTop[2]),_[3]=Vector3.Clone(p.m_aTop[1]),_[1]=Vector3.Clone(_[0]),_[1].y=r,_[2]=Vector3.Clone(_[3]),_[2].y=r,u[0]={x:d,y:C},u[1]={x:d,y:0},u[2]={x:y,y:0},u[3]={x:y,y:C},a[0]=Vector3.Clone(_[0]),a[1]=Vector3.Clone(_[1]),a[2]=Vector3.Clone(_[2]),s[0]=Vector2.Clone(u[0]),s[1]=Vector2.Clone(u[1]),s[2]=Vector2.Clone(u[2]),i.PushTriangle(a,o,s),a[0]=Vector3.Clone(_[0]),a[1]=Vector3.Clone(_[2]),a[2]=Vector3.Clone(_[3]),s[0]=Vector2.Clone(u[0]),s[1]=Vector2.Clone(u[2]),s[2]=Vector2.Clone(u[3]),i.PushTriangle(a,o,s),_[1]=Vector3.Clone(p.m_aBottom[2]),_[2]=Vector3.Clone(p.m_aBottom[1]),_[0]=Vector3.Clone(_[1]),_[0].y=0,_[3]=Vector3.Clone(_[2]),_[3].y=0,u[0]={x:d,y:1},u[1]={x:d,y:v},u[2]={x:y,y:v},u[3]={x:y,y:1},a[0]=Vector3.Clone(_[0]),a[1]=Vector3.Clone(_[1]),a[2]=Vector3.Clone(_[2]),s[0]=Vector2.Clone(u[0]),s[1]=Vector2.Clone(u[1]),s[2]=Vector2.Clone(u[2]),i.PushTriangle(a,o,s),a[0]=Vector3.Clone(_[0]),a[1]=Vector3.Clone(_[2]),a[2]=Vector3.Clone(_[3]),s[0]=Vector2.Clone(u[0]),s[1]=Vector2.Clone(u[2]),s[2]=Vector2.Clone(u[3]),i.PushTriangle(a,o,s),_[0]=Vector3.Clone(_[3]),_[1]=Vector3.Clone(_[3]),_[1].y=r,u[0]={x:y,y:1},u[1]={x:y,y:0}}_[2]=e.m_aTop[1],_[3]=e.m_aBottom[1],u[2]={x:1,y:0},u[3]={x:1,y:1},a[0]=Vector3.Clone(_[0]),a[1]=Vector3.Clone(_[1]),a[2]=Vector3.Clone(_[2]),s[0]=Vector2.Clone(u[0]),s[1]=Vector2.Clone(u[1]),s[2]=Vector2.Clone(u[2]),i.PushTriangle(a,o,s),a[0]=Vector3.Clone(_[0]),a[1]=Vector3.Clone(_[2]),a[2]=Vector3.Clone(_[3]),s[0]=Vector2.Clone(u[0]),s[1]=Vector2.Clone(u[2]),s[2]=Vector2.Clone(u[3]),i.PushTriangle(a,o,s),i==t.g_pMeshBuilder&&(this.m_aMeshData[1]=i.GetMeshData())}},{key:"BuildBorderMesh",value:function(e,n){var i=[null,null,null],a=[null,null,null],o=[null,null,null];null==n&&(n=t.g_pMeshBuilder).Clear(),i[0]=Vector3.Clone(e.m_aBottom[0]),i[1]=Vector3.Clone(e.m_aBottom[5]),i[2]=Vector3.Clone(e.m_aBottom[4]),a[0]={x:0,y:-1,z:0},a[1]={x:0,y:-1,z:0},a[2]={x:0,y:-1,z:0},o[0]={x:0,y:.5},o[1]={x:0,y:0},o[2]={x:1,y:0},n.PushTriangle(i,a,o),i[0]=Vector3.Clone(e.m_aBottom[0]),i[1]=Vector3.Clone(e.m_aBottom[4]),i[2]=Vector3.Clone(e.m_aBottom[3]),o[0]={x:0,y:.5},o[1]={x:1,y:0},o[2]={x:1,y:.5},n.PushTriangle(i,a,o),i[0]=Vector3.Clone(e.m_aBottom[0]),i[1]=Vector3.Clone(e.m_aBottom[3]),i[2]=Vector3.Clone(e.m_aBottom[2]),o[0]={x:0,y:.5},o[1]={x:1,y:.5},o[2]={x:1,y:1},n.PushTriangle(i,a,o),i[0]=Vector3.Clone(e.m_aBottom[0]),i[1]=Vector3.Clone(e.m_aBottom[2]),i[2]=Vector3.Clone(e.m_aBottom[1]),o[0]={x:0,y:.5},o[1]={x:1,y:1},o[2]={x:0,y:1},n.PushTriangle(i,a,o),i[0]=Vector3.Clone(e.m_aTop[0]),i[1]=Vector3.Clone(e.m_aTop[1]),i[2]=Vector3.Clone(e.m_aTop[2]),a[0]={x:0,y:1,z:0},a[1]={x:0,y:1,z:0},a[2]={x:0,y:1,z:0},o[0]={x:0,y:.5},o[1]={x:0,y:0},o[2]={x:1,y:0},n.PushTriangle(i,a,o),i[0]=Vector3.Clone(e.m_aTop[0]),i[1]=Vector3.Clone(e.m_aTop[2]),i[2]=Vector3.Clone(e.m_aTop[3]),o[0]={x:0,y:.5},o[1]={x:1,y:0},o[2]={x:1,y:.5},n.PushTriangle(i,a,o),i[0]=Vector3.Clone(e.m_aTop[0]),i[1]=Vector3.Clone(e.m_aTop[3]),i[2]=Vector3.Clone(e.m_aTop[4]),o[0]={x:0,y:.5},o[1]={x:1,y:.5},o[2]={x:1,y:1},n.PushTriangle(i,a,o),i[0]=Vector3.Clone(e.m_aTop[0]),i[1]=Vector3.Clone(e.m_aTop[4]),i[2]=Vector3.Clone(e.m_aTop[5]),o[0]={x:0,y:.5},o[1]={x:1,y:1},o[2]={x:0,y:1},n.PushTriangle(i,a,o),n==t.g_pMeshBuilder&&(this.m_aMeshData[2]=n.GetMeshData())}},{key:"BuildInborderMesh",value:function(e,n,i){var a=[null,null,null],o=[null,null,null],s=[null,null,null];if(null==i&&(i=t.g_pMeshBuilder).Clear(),null!=n){var r=!0,m=!1,l=void 0;try{for(var h,_=n[Symbol.iterator]();!(r=(h=_.next()).done);r=!0){var u=h.value;a[0]=Vector3.Clone(u.m_aBottom[5]),a[1]=Vector3.Clone(u.m_aTop[5]),a[2]=Vector3.Clone(u.m_aTop[1]),o[0]=Vector3.Cross(Vector3.Sub(a[1],a[0]),Vector3.Sub(a[2],a[0])),o[1]=Vector3.Clone(o[0]),o[2]=Vector3.Clone(o[0]),s[0]={x:0,y:1},s[1]={x:0,y:0},s[2]={x:1,y:0},i.PushTriangle(a,o,s),a[0]=Vector3.Clone(u.m_aBottom[5]),a[1]=Vector3.Clone(u.m_aTop[1]),a[2]=Vector3.Clone(u.m_aBottom[1]),o[0]=Vector3.Cross(Vector3.Sub(a[1],a[0]),Vector3.Sub(a[2],a[0])),o[1]=Vector3.Clone(o[0]),o[2]=Vector3.Clone(o[0]),s[0]={x:0,y:1},s[1]={x:1,y:0},s[2]={x:1,y:1},i.PushTriangle(a,o,s),a[0]=Vector3.Clone(u.m_aBottom[2]),a[1]=Vector3.Clone(u.m_aTop[2]),a[2]=Vector3.Clone(u.m_aTop[4]),o[0]=Vector3.Cross(Vector3.Sub(a[1],a[0]),Vector3.Sub(a[2],a[0])),o[1]=Vector3.Clone(o[0]),o[2]=Vector3.Clone(o[0]),s[0]={x:0,y:1},s[1]={x:0,y:0},s[2]={x:1,y:0},i.PushTriangle(a,o,s),a[0]=Vector3.Clone(u.m_aBottom[2]),a[1]=Vector3.Clone(u.m_aTop[4]),a[2]=Vector3.Clone(u.m_aBottom[4]),o[0]=Vector3.Cross(Vector3.Sub(a[1],a[0]),Vector3.Sub(a[2],a[0])),o[1]=Vector3.Clone(o[0]),o[2]=Vector3.Clone(o[0]),s[0]={x:0,y:1},s[1]={x:1,y:0},s[2]={x:1,y:1},i.PushTriangle(a,o,s),a[0]=Vector3.Clone(u.m_aBottom[5]),a[1]=Vector3.Clone(u.m_aBottom[1]),a[2]=Vector3.Clone(u.m_aBottom[2]),o[0]=Vector3.Cross(Vector3.Sub(a[1],a[0]),Vector3.Sub(a[2],a[0])),o[1]=Vector3.Clone(o[0]),o[2]=Vector3.Clone(o[0]),s[0]={x:0,y:0},s[1]={x:0,y:0},s[2]={x:0,y:0},i.PushTriangle(a,o,s),a[0]=Vector3.Clone(u.m_aBottom[5]),a[1]=Vector3.Clone(u.m_aBottom[2]),a[2]=Vector3.Clone(u.m_aBottom[4]),o[0]=Vector3.Cross(Vector3.Sub(a[1],a[0]),Vector3.Sub(a[2],a[0])),o[1]=Vector3.Clone(o[0]),o[2]=Vector3.Clone(o[0]),s[0]={x:0,y:0},s[1]={x:0,y:0},s[2]={x:0,y:0},i.PushTriangle(a,o,s),a[0]=Vector3.Clone(u.m_aTop[1]),a[1]=Vector3.Clone(u.m_aTop[5]),a[2]=Vector3.Clone(u.m_aTop[4]),o[0]=Vector3.Cross(Vector3.Sub(a[1],a[0]),Vector3.Sub(a[2],a[0])),o[1]=Vector3.Clone(o[0]),o[2]=Vector3.Clone(o[0]),s[0]={x:1,y:1},s[1]={x:1,y:1},s[2]={x:1,y:1},i.PushTriangle(a,o,s),a[0]=Vector3.Clone(u.m_aTop[1]),a[1]=Vector3.Clone(u.m_aTop[4]),a[2]=Vector3.Clone(u.m_aTop[2]),o[0]=Vector3.Cross(Vector3.Sub(a[1],a[0]),Vector3.Sub(a[2],a[0])),o[1]=Vector3.Clone(o[0]),o[2]=Vector3.Clone(o[0]),s[0]={x:1,y:1},s[1]={x:1,y:1},s[2]={x:1,y:1},i.PushTriangle(a,o,s)}}catch(t){m=!0,l=t}finally{try{!r&&_.return&&_.return()}finally{if(m)throw l}}}a[0]=Vector3.Clone(e.m_aBottom[0]),a[1]=Vector3.Clone(e.m_aBottom[1]),a[2]=Vector3.Clone(e.m_aTop[1]),o[0]=Vector3.Cross(Vector3.Sub(a[1],a[0]),Vector3.Sub(a[2],a[0])),o[1]=Vector3.Clone(o[0]),o[2]=Vector3.Clone(o[0]),s[0]={x:.5,y:1},s[1]={x:0,y:1},s[2]={x:0,y:0},i.PushTriangle(a,o,s),a[0]=Vector3.Clone(e.m_aBottom[0]),a[1]=Vector3.Clone(e.m_aTop[1]),a[2]=Vector3.Clone(e.m_aTop[0]),s[0]={x:.5,y:1},s[1]={x:0,y:0},s[2]={x:.5,y:0},i.PushTriangle(a,o,s),a[0]=Vector3.Clone(e.m_aBottom[0]),a[1]=Vector3.Clone(e.m_aTop[0]),a[2]=Vector3.Clone(e.m_aTop[5]),s[0]={x:.5,y:1},s[1]={x:.5,y:0},s[2]={x:1,y:0},i.PushTriangle(a,o,s),a[0]=Vector3.Clone(e.m_aBottom[0]),a[1]=Vector3.Clone(e.m_aTop[5]),a[2]=Vector3.Clone(e.m_aBottom[5]),s[0]={x:.5,y:1},s[1]={x:1,y:0},s[2]={x:1,y:1},i.PushTriangle(a,o,s),a[0]=Vector3.Clone(e.m_aBottom[3]),a[1]=Vector3.Clone(e.m_aBottom[4]),a[2]=Vector3.Clone(e.m_aTop[4]),o[0]=Vector3.Cross(Vector3.Sub(a[1],a[0]),Vector3.Sub(a[2],a[0])),o[1]=Vector3.Clone(o[0]),o[2]=Vector3.Clone(o[0]),s[0]={x:.5,y:1},s[1]={x:0,y:1},s[2]={x:0,y:0},i.PushTriangle(a,o,s),a[0]=Vector3.Clone(e.m_aBottom[3]),a[1]=Vector3.Clone(e.m_aTop[4]),a[2]=Vector3.Clone(e.m_aTop[3]),s[0]={x:.5,y:1},s[1]={x:0,y:0},s[2]={x:.5,y:0},i.PushTriangle(a,o,s),a[0]=Vector3.Clone(e.m_aBottom[3]),a[1]=Vector3.Clone(e.m_aTop[3]),a[2]=Vector3.Clone(e.m_aTop[2]),s[0]={x:.5,y:1},s[1]={x:.5,y:0},s[2]={x:1,y:0},i.PushTriangle(a,o,s),a[0]=Vector3.Clone(e.m_aBottom[3]),a[1]=Vector3.Clone(e.m_aTop[2]),a[2]=Vector3.Clone(e.m_aBottom[2]),s[0]={x:.5,y:1},s[1]={x:1,y:0},s[2]={x:1,y:1},i.PushTriangle(a,o,s),i==t.g_pMeshBuilder&&(this.m_aMeshData[3]=i.GetMeshData())}},{key:"BuildShadowMesh",value:function(e,n){var i=[null,null,null],a=[null,null,null],o=[null,null,null];a[0]={x:0,y:1,z:0},a[1]={x:0,y:1,z:0},a[2]={x:0,y:1,z:0},null==n&&(n=t.g_pMeshBuilder).Clear();var s=e.m_mLeftPoint.Object,r=e.m_mRightPoint.Object,m=Vector3.Sub(r.m_mPosition,s.m_mPosition),l=Vector3.Cross(m,{x:0,y:1,z:0}),h=Vector3.Clone(l),_=Vector3.Clone(l),u={x:-l.x,y:-l.y,z:-l.z},c={x:-l.x,y:-l.y,z:-l.z},p=e.m_pSketch,d=new Vector3(p.m_aBottom[1].x,.005,p.m_aBottom[1].z),y=new Vector3(p.m_aBottom[2].x,.005,p.m_aBottom[2].z),C=new Vector3(p.m_aBottom[4].x,.005,p.m_aBottom[4].z),v=new Vector3(p.m_aBottom[5].x,.005,p.m_aBottom[5].z),f=Vector3.Dot(l,h),g=Vector3.Dot(l,_),T=Vector3.Dot({x:-l.x,y:-l.y,z:-l.z},u),k=Vector3.Dot({x:-l.x,y:-l.y,z:-l.z},c),S=0==f?5:.15/f,x=0==g?5:.15/g,M=0==T?5:.15/T,D=0==k?5:.15/k,b=Vector3.Add(d,Vector3.Scale(S,h)),P=Vector3.Add(y,Vector3.Scale(x,_)),R=Vector3.Add(C,Vector3.Scale(M,u)),E=Vector3.Add(v,Vector3.Scale(D,c));i[0]=Vector3.Clone(d),i[1]=Vector3.Clone(b),i[2]=Vector3.Clone(P),o[0]={x:0,y:1},o[1]={x:0,y:0},o[2]={x:1,y:0},n.PushTriangle(i,a,o),i[0]=Vector3.Clone(d),i[1]=Vector3.Clone(P),i[2]=Vector3.Clone(y),o[0]={x:0,y:1},o[1]={x:1,y:0},o[2]={x:1,y:1},n.PushTriangle(i,a,o),i[0]=Vector3.Clone(E),i[1]=Vector3.Clone(v),i[2]=Vector3.Clone(C),o[0]={x:0,y:0},o[1]={x:0,y:1},o[2]={x:1,y:1},n.PushTriangle(i,a,o),i[0]=Vector3.Clone(E),i[1]=Vector3.Clone(C),i[2]=Vector3.Clone(R),o[0]={x:0,y:0},o[1]={x:1,y:1},o[2]={x:1,y:0},n.PushTriangle(i,a,o),n==t.g_pMeshBuilder&&(this.m_aMeshData[4]=n.GetMeshData())}},{key:"MapTexture",value:function(t){}}]),t}();AEdgeMesh.g_pMeshBuilder=null;var AAreaMesh=function(){function t(){_classCallCheck(this,t),this.m_mInnerPoint=new Vector3(0,0,0),this.m_pBottomData=null,this.m_pBottomMesh=null}return _createClass(t,[{key:"version",value:function(){return 1e3}},{key:"CreateGeometry",value:function(t){this.m_pBottomMesh=new GameObject("m_pBottomMesh",GameObjectType.Mesh),this.m_pBottomMesh.parent=t,this.m_pBottomMesh.SetGeometry(this.m_pBottomData,new Material(MaterialType.AreaBottom)),this.m_pBottomMesh.SetActive(!0)}},{key:"MapTexture",value:function(t,e){var n=this.m_pBottomMesh;if(null!=e){var i=e.entity,a=e.menuItem.Object;if(null!=i&&null!=a)return void ALinerDC.DC.m_pLayerMgr.m_pDelegateList.push(function(){a.LoadAndSet(null,function(t){i.scale=i.textureSize,n.m_pMaterial.SetTexture(0,i.texture),n.m_pMaterial.SetTextureOffset(0,new Vector2(0,0)),n.m_pMaterial.SetTextureScale(0,i.scale)})})}n.m_pMaterial.SetTexture(0,null)}},{key:"UnSerialize",value:function(t){t.ReadUInt32();this.m_mInnerPoint.x=t.ReadSingle(),this.m_mInnerPoint.y=t.ReadSingle(),this.m_mInnerPoint.z=t.ReadSingle();var e=t.ReadInt32();if(e>0){var n=new AMeshData;e=t.ReadInt32(),n.m_aPosition=new Float32Array(3*e);for(var i=0;i<3*e;i++)n.m_aPosition[i]=t.ReadSingle();e=t.ReadInt32(),n.m_aNormal=new Float32Array(3*e);for(var a=0;a<3*e;a++)n.m_aNormal[a]=t.ReadSingle();e=t.ReadInt32(),n.m_aTexUV=new Float32Array(2*e);for(var o=0;o<2*e;o++)n.m_aTexUV[o]=t.ReadSingle();this.m_pBottomData=n}501347081!=t.ReadInt32()&&alert("AAreaMesh.UnSerialize(): Bad end!")}},{key:"CollideBottom",value:function(t){t.y=0;for(var e=[null,null,null],n=0,i=0;i<this.m_pBottomData.m_aPosition.length/3;i++){var a=3*i;if(e[n]=new Vector3(this.m_pBottomData.m_aPosition[a],0,this.m_pBottomData.m_aPosition[a+2]),3==++n){var o=this.CalTriangleArea(e[0],e[1],e[2]),s=this.CalTriangleArea(e[0],e[1],t),r=this.CalTriangleArea(e[1],e[2],t),m=this.CalTriangleArea(e[2],e[0],t);if(Math.abs(o-(s+r+m))<1e-4)return!0;n=0}}return!1}},{key:"CalTriangleArea",value:function(t,e,n){return Math.abs((t.x*e.z+e.x*n.z+n.x*t.z-e.x*t.z-n.x*e.z-t.x*n.z)/2)}}]),t}(),AAreaLabel=function(){function t(){_classCallCheck(this,t),this.m_pName="",this.m_mPosition=new Vector3(0,0,0),this.m_mBottomTexture=new Handle(Attachment,0),this.m_mTopTexture=new Handle(Attachment,0),this.m_pArea=null,this.m_mFloor=new Handle(Attachment,0)}return _createClass(t,[{key:"version",value:function(){return 1001}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){var e=t.ReadUInt32();(this.m_pName=t.ReadString(),this.m_mPosition.x=t.ReadSingle(),this.m_mPosition.y=t.ReadSingle(),this.m_mPosition.z=t.ReadSingle(),this.m_mBottomTexture.Number=t.ReadUInt32(),this.m_mTopTexture.Number=t.ReadUInt32(),e>1e3)&&(t.ReadInt32()>0&&(this.m_pArea=new AAreaMesh,this.m_pArea.UnSerialize(t)));e>1001&&(t.ReadBoolean()&&(new CameraState).UnSerialize(t));501347081!=t.ReadInt32()&&alert("AAreaLabel.UnSerialize(): Bad end!")}}]),t}(),ALinerDC=function(){function t(e,n){_classCallCheck(this,t),this.m_pLayerMgr=null,this.m_mTempPointHeap=null,this.m_mTempAdjoinHeap=null,this.m_mTempEdgeHeap=null;if(this.m_pLayerMgr=new ALinerMgr(e),this.m_mTempPointHeap=new HeapHandle(APoint,255),this.m_mTempAdjoinHeap=new HeapHandle(AAdjoin,255),this.m_mTempEdgeHeap=new HeapHandle(AEdge,255),this.ResetTempHeap(),null!=n){var i=t.DC;t.DC=this,this.UnSerialize(n),t.DC=i}}return _createClass(t,[{key:"Update",value:function(){}},{key:"OnGUI",value:function(){}},{key:"OnViewModeChange",value:function(){this.m_pLayerMgr.FitViewMode()}},{key:"ActiveLayer",value:function(t){this.ResetTempHeap(),this.m_pLayerMgr.ActiveLayer(t)}},{key:"version",value:function(){return 1e3}},{key:"Active",value:function(t){t&&null==this.m_pLayerMgr.m_pSceneRoot&&this.m_pLayerMgr.BuildScene(),this.m_pLayerMgr.Active(t)}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){t.ReadUInt32();this.m_pLayerMgr.UnSerialize(t),501347081!=t.ReadInt32()&&alert("ALinerDC.UnSerialize(): Bad end!")}},{key:"ResetTempHeap",value:function(){this.m_mTempPointHeap.InitHeap(null),this.m_mTempAdjoinHeap.InitHeap(null),this.m_mTempEdgeHeap.InitHeap(null)}}]),t}();ALinerDC.DC=null;var EntityType,CollectionType,ComponentType,DisplayType,GroupType,ProgressState,ALinerMgr=function(){function t(e){_classCallCheck(this,t),this.m_nWork=0,this.m_pSceneRoot=null,this.m_pLayerList=null,this.m_pDelegateList=null,this.m_nWork=e,this.m_pActiveLayer=null,this.m_pSceneRoot=null,this.m_pLayerList=new Array,this.m_pDelegateList=new Array}return _createClass(t,[{key:"version",value:function(){return 1e3}},{key:"Active",value:function(t){null!=this.m_pSceneRoot&&this.m_pSceneRoot.SetActive(t)}},{key:"ActiveLayer",value:function(t){var e=this.m_pLayerList[t];null!=this.m_pActiveLayer&&null!=this.m_pActiveLayer.m_pLayerRoot&&this.m_pActiveLayer.m_pLayerRoot.SetActive(!1),this.m_pActiveLayer=e,null!=this.m_pSceneRoot&&null!=this.m_pActiveLayer.m_pLayerRoot&&(this.m_pActiveLayer.m_pLayerRoot.SetActive(!0),this.FitViewMode())}},{key:"GetLayer",value:function(t){return t<this.m_pLayerList.length?this.m_pLayerList[t]:null}},{key:"GetLayersLenth",value:function(){return this.m_pLayerList.length}},{key:"BuildScene",value:function(){console.warn("ALinerMgr.BuildScene(): Invalid.")}},{key:"FitViewMode",value:function(){null!=this.m_pSceneRoot&&null!=this.m_pActiveLayer&&this.m_pActiveLayer.m_pPatchRoot.SetActive(MiaokitDC.DC.viewMode==ViewMode.View2D)}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){this.m_pSceneRoot=new GameObject("-ALiner Root",GameObjectType.Empty),this.m_pSceneRoot.parent=MiaokitDC.DC.GetWork(this.m_nWork).m_pWorkRoot;t.ReadUInt32();for(var e=t.ReadInt32(),n=0;n<e;n++){var i=ALiner.Create(t);i.m_nWork=this.m_nWork,i.m_nIndex=n,i.BuildScene(this.m_pSceneRoot),this.m_pLayerList.push(i)}var a=this.m_pDelegateList;MiaokitDC.DC.m_pAssetsLoader.PushDelegate(this.m_nWork,function(){var t=!0,e=!1,n=void 0;try{for(var i,o=a[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){(0,i.value)()}}catch(t){e=!0,n=t}finally{try{!t&&o.return&&o.return()}finally{if(e)throw n}}}),501347081!=t.ReadInt32()&&alert("ALinerMgr.UnSerialize(): Bad end!")}}]),t}(),ALiner=function(){function t(){_classCallCheck(this,t),this.m_mPointHeap=new HeapHandle(APoint,0),this.m_mAdjoinHeap=new HeapHandle(AAdjoin,0),this.m_mEdgeHeap=new HeapHandle(AEdge,0),this.m_mMenuItemHeap=new HeapHandle(MenuItem,0),this.m_mAttachmentHeap=new HeapHandle(Attachment,0),this.m_pLabelList=new Array,this.m_pLayerRoot=null,this.m_pPointRoot=null,this.m_pPatchRoot=null,this.m_pEdgeRoot=null,this.m_pBottomRoot=null,this.m_pTopRoot=null,this.m_aEdgeMeshData=null,this.m_aEdgeMesh=null}return _createClass(t,[{key:"version",value:function(){return 1e3}},{key:"Rebuild",value:function(){if(0!=this.m_mMenuItemHeap.Count){var t=!0,e=!1,n=void 0;try{for(var i,a=this.m_mMenuItemHeap[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;MiaokitDC.DC.BindMenuType(o)?o.type.Add(o,this):(o.type=MiaokitDC.DC.m_pCategories,o.type.Add(o,this)),MiaokitDC.DC.m_pAssetsLoader.PushItem(o)}}catch(t){e=!0,n=t}finally{try{!t&&a.return&&a.return()}finally{if(e)throw n}}}if(0!=this.m_mAttachmentHeap.Count){var s=!0,r=!1,m=void 0;try{for(var l,h=this.m_mAttachmentHeap[Symbol.iterator]();!(s=(l=h.next()).done);s=!0){var _=l.value;null==this.Construct(_)&&(_.valid=!1,console.warn("ALiner.Rebuild(): Construct(pAttachment) == null"))}}catch(t){r=!0,m=t}finally{try{!s&&h.return&&h.return()}finally{if(r)throw m}}}}},{key:"Construct",value:function(t){var e=t.menuItem.Object;if(null!=e){var n=t.entity;if(null!=n){switch(n.collectionType){case CollectionType.ATexture:case CollectionType.AHoleModel:case CollectionType.AEdgeModel:n.desc=e.collectionDesc;break;default:t=null,alert("ALiner.Construct(): !pEntity.collectionType.")}return null!=t&&e.refCount++,t}alert("ALiner.Construct(): pEntity == null.")}else alert("ALiner.Construct(): pItem == null.");return null}},{key:"BuildScene",value:function(e){if(null!=e){var n=this;if(this.m_pLayerRoot=new GameObject("--LayerRoot",GameObjectType.Empty),this.m_pPointRoot=new GameObject("--PointRoot",GameObjectType.Empty),this.m_pPatchRoot=new GameObject("--PatchRoot",GameObjectType.Empty),this.m_pEdgeRoot=new GameObject("---EdgeRoot",GameObjectType.Empty),this.m_pBottomRoot=new GameObject("---BottomRoot",GameObjectType.Empty),this.m_pTopRoot=new GameObject("---TopRoot",GameObjectType.Empty),this.m_pLayerRoot.parent=e,this.m_pPointRoot.parent=this.m_pLayerRoot,this.m_pPointRoot.position=new Vector3(0,10,0),this.m_pPatchRoot.parent=this.m_pLayerRoot,this.m_pPatchRoot.position=new Vector3(0,10,0),this.m_pEdgeRoot.parent=this.m_pLayerRoot,this.m_pBottomRoot.parent=this.m_pLayerRoot,this.m_pTopRoot.parent=this.m_pLayerRoot,this.m_pLayerRoot.SetActive(!1),null==t.g_aMeshBuilder){t.g_aMeshBuilder=[null,null,null,null,null];for(var i=0;i<5;i++)t.g_aMeshBuilder[i]=new AMeshBuilder}for(var a=0;a<5;a++)t.g_aMeshBuilder[a].Clear();var o=this.m_mEdgeHeap.GetDefaultList(),s=!0,r=!1,m=void 0;try{for(var l,h=o[Symbol.iterator]();!(s=(l=h.next()).done);s=!0){l.value.CreateGeometry(this)}}catch(t){r=!0,m=t}finally{try{!s&&h.return&&h.return()}finally{if(r)throw m}}this.BuildEdgeMesh();var _=!0,u=!1,c=void 0;try{for(var p,d=this.m_pLabelList[Symbol.iterator]();!(_=(p=d.next()).done);_=!0){var y=p.value;null!=y.m_pArea&&(y.m_pArea.CreateGeometry(this.m_pBottomRoot),y.m_pArea.MapTexture(0,y.m_mBottomTexture.Object))}}catch(t){u=!0,c=t}finally{try{!_&&d.return&&d.return()}finally{if(u)throw c}}ALinerDC.DC.m_pLayerMgr.m_pDelegateList.push(function(){var t=!0,e=!1,i=void 0;try{for(var a,s=o[Symbol.iterator]();!(t=(a=s.next()).done);t=!0){var r=a.value;null!=r.m_pMesh&&r.m_pMesh.PlaceHole(n.m_pEdgeRoot,n.m_pPatchRoot)}}catch(t){e=!0,i=t}finally{try{!t&&s.return&&s.return()}finally{if(e)throw i}}})}}},{key:"BuildEdgeMesh",value:function(){null==this.m_aEdgeMeshData&&null==this.m_aEdgeMesh||alert("ALiner.BuildEdgeMesh(): this.m_aEdgeMeshData != null || this.m_aEdgeSubMesh != null."),this.m_aEdgeMeshData=[null,null,null,null,null],this.m_aEdgeMesh=[null,null,null,null,null];for(var e=[MaterialType.Edge,MaterialType.Edge,MaterialType.Border,MaterialType.Inborder,MaterialType.AreaBottomShadow],n=0;n<5;n++)this.m_aEdgeMeshData[n]=t.g_aMeshBuilder[n].GetMeshData(),this.m_aEdgeMesh[n]=new GameObject("Edge: "+n,GameObjectType.Mesh),this.m_aEdgeMesh[n].parent=this.m_pEdgeRoot,null!=this.m_aEdgeMeshData[n]?(this.m_aEdgeMesh[n].SetGeometry(this.m_aEdgeMeshData[n],new Material(e[n])),this.m_aEdgeMesh[n].SetActive(!0)):this.m_aEdgeMesh[n].SetActive(!1),t.g_aMeshBuilder[n].Clear()}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){t.ReadUInt32();this.m_mPointHeap.Number=t.ReadUInt32(),this.m_mAdjoinHeap.Number=t.ReadUInt32(),this.m_mEdgeHeap.Number=t.ReadUInt32(),this.m_mMenuItemHeap.Number=t.ReadUInt32(),this.m_mAttachmentHeap.Number=t.ReadUInt32(),this.m_mPointHeap.InitHeap(t),this.m_mAdjoinHeap.InitHeap(t),this.m_mEdgeHeap.InitHeap(t),this.m_mMenuItemHeap.InitHeap(t),this.m_mAttachmentHeap.InitHeap(t);var e=t.ReadInt32();null==this.m_pLabelList&&(this.m_pLabelList=new Array);for(var n=0;n<e;n++){var i=new AAreaLabel;i.UnSerialize(t),this.m_pLabelList.push(i)}501347081!=t.ReadInt32()&&alert("ALiner.UnSerialize(): Bad end!"),this.Rebuild()}}],[{key:"Create",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=new t;return null!=e?n.UnSerialize(e):(n.m_mPointHeap=new HeapHandle(APoint,0),n.m_mAdjoinHeap=new HeapHandle(AAdjoin,0),n.m_mEdgeHeap=new HeapHandle(AEdge,0),n.m_mMenuItemHeap=new HeapHandle(MenuItem,0),n.m_mAttachmentHeap=new HeapHandle(Attachment,0),n.m_mPointHeap.InitHeap(),n.m_mAdjoinHeap.InitHeap(),n.m_mEdgeHeap.InitHeap(),n.m_mMenuItemHeap.InitHeap(),n.m_mAttachmentHeap.InitHeap()),n}}]),t}();ALiner.g_aMeshBuilder=null,function(t){t[t.Invalid=0]="Invalid",t[t.Group=1]="Group",t[t.Collection=2]="Collection",t[t.Component=3]="Component",t[t.Placeholder=4]="Placeholder"}(EntityType||(EntityType={})),function(t){t[t.Invalid=0]="Invalid",t[t.ProjectFile=1]="ProjectFile",t[t.ATexture=101]="ATexture",t[t.AHoleModel=102]="AHoleModel",t[t.AEdgeModel=103]="AEdgeModel",t[t.ETexture=201]="ETexture",t[t.EBuildingModel=202]="EBuildingModel",t[t.EStoreyModel=203]="EStoreyModel",t[t.EFurnitureModel=204]="EFurnitureModel",t[t.EAssetsModel=205]="EAssetsModel"}(CollectionType||(CollectionType={})),function(t){t[t.Invalid=0]="Invalid",t[t.Panel=1]="Panel",t[t.Edge=3]="Edge",t[t.AreaBottom=4]="AreaBottom",t[t.AreaTop=5]="AreaTop"}(ComponentType||(ComponentType={})),function(t){t[t.Normal=0]="Normal",t[t.Transparent=1]="Transparent",t[t.FrameModel=2]="FrameModel",t[t.Hide=3]="Hide"}(DisplayType||(DisplayType={})),function(t){t[t.Invalid=0]="Invalid",t[t.Layer=1]="Layer",t[t.Area=2]="Area",t[t.Group=3]="Group"}(GroupType||(GroupType={})),function(t){t[t.Preparing=0]="Preparing",t[t.Loading=1]="Loading",t[t.Processing=2]="Processing",t[t.Abort=3]="Abort",t[t.Exited=4]="Exited"}(ProgressState||(ProgressState={}));var MenuType=function(){function t(){_classCallCheck(this,t),this.m_nID=0,this.m_pName=null,this.m_pDesc=null,this.m_pIconUrl=null,this.m_pIcon=null}return _createClass(t,[{key:"SetParent",value:function(t){null==this.m_pParent?(this.m_pParent=t,null!=this.m_pParent&&this.m_pParent.AddChild(this)):alert("MenuType.SetParent(): m_pParent != null.")}},{key:"AddChild",value:function(t){null!=t&&(null==this.m_pChildren&&(this.m_pChildren=new Array),this.m_pChildren.push(t))}},{key:"Add",value:function(t,e){null==this.m_pElements&&(this.m_pElements=new Array),t.holder=e,this.m_pElements.push(t)}},{key:"Remove",value:function(t){this.m_pElements.splice(this.m_pElements.indexOf(t),1),0==this.m_pElements.length&&(this.m_pElements=null)}},{key:"Search",value:function(t,e){if(null!=this.m_pElements){var n=!0,i=!1,a=void 0;try{for(var o,s=this.m_pElements[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var r=o.value;if(r.id==t.id&&r.holder==e)return r}}catch(t){i=!0,a=t}finally{try{!n&&s.return&&s.return()}finally{if(i)throw a}}}return null}},{key:"Clear",value:function(t){if(null!=this.m_pElements)if(null==t)this.m_pElements=null;else{for(var e=0;e<this.m_pElements.length;)this.m_pElements[e].holder==t?this.m_pElements.splice(e,1):e++;0==this.m_pElements.length&&(this.m_pElements=null)}}},{key:"uiName",get:function(){return this.m_pName}},{key:"uiDesc",get:function(){return this.m_pDesc}},{key:"uiSprite",get:function(){return this.m_pIcon}},{key:"parent",get:function(){return this.m_pParent}},{key:"children",get:function(){return this.m_pChildren}},{key:"elements",get:function(){return this.m_pElements}}]),t}(),MenuItem=function(){function t(){_classCallCheck(this,t),this.m_mHandle=new Handle(t,0),this.m_eCollectionType=CollectionType.Invalid,this.m_pCollectionDesc=null,this.m_pType=null,this.m_nLoading=0,this.m_nRefCount=0,this.m_pIcon=null,this.m_pAsyncList=null,this.m_pHolder=null}return _createClass(t,[{key:"OnCreate",value:function(t){}},{key:"OnEmploy",value:function(e){this.m_mHandle=new Handle(t,e)}},{key:"OnUnemploy",value:function(){}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){t.ReadUInt32();this.m_mHandle.Number=t.ReadUInt32(),this.m_eCollectionType=t.ReadInt32();var e=MiaokitDC.DC.DescriptorFactory(this.m_eCollectionType);e.UnSerialize(t),this.m_pCollectionDesc=e,this.m_pType=null,this.m_nLoading=0,this.m_nRefCount=0,this.m_pIcon=null,this.m_pAsyncList=null,501347081!=t.ReadInt32()&&alert("MenuItem.UnSerialize(): Bad end!")}},{key:"Remap",value:function(t){this.m_mHandle.Heap=t}},{key:"Init",value:function(e,n){null!=this.m_pCollectionDesc&&alert("MenuItem.Init(): m_pCollectionDesc != null."),this.m_mHandle=new Handle(t,0),this.m_eCollectionType=e;var i=MiaokitDC.DC.DescriptorFactory(this.m_eCollectionType);i.Init(n),this.m_pCollectionDesc=i,this.m_pType=null,this.m_nLoading=0,this.m_nRefCount=0,this.m_pIcon=null,this.m_pAsyncList=null}},{key:"Reinit",value:function(t){t(this)}},{key:"LoadAndSet",value:function(t,e){null!=this.collectionDesc&&(1==this.loading?(null!=t&&(t.state=ProgressState.Processing),e(this)):0==this.loading?null==this.m_pAsyncList?(null!=t&&(t.state=ProgressState.Loading),this.m_pAsyncList=new Array,this.m_pAsyncList.push(new Delegate(t,e)),this.StartLoad(t)):(null!=t&&(t.loader=this.m_pAsyncList[0].m_pProgress.loader,t.state=ProgressState.Loading),this.m_pAsyncList.push(new Delegate(t,e))):(null!=t&&(t.state=ProgressState.Abort),e(null)))}},{key:"StartLoad",value:function(t){var e=this;this.collectionDesc.Load(t,function(t){if(null==t){if(e.loading=1,null!=e.m_pAsyncList){var n=!0,i=!1,a=void 0;try{for(var o,s=e.m_pAsyncList[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var r=o.value;null!=r.m_pProgress&&(r.m_pProgress.state=ProgressState.Processing),r.m_pCallback(e)}}catch(t){i=!0,a=t}finally{try{!n&&s.return&&s.return()}finally{if(i)throw a}}}e.m_pAsyncList=null}else{if(console.warn("MenuItem.LoadAndSet(): ",t),e.loading=-1,null!=e.m_pAsyncList){var m=!0,l=!1,h=void 0;try{for(var _,u=e.m_pAsyncList[Symbol.iterator]();!(m=(_=u.next()).done);m=!0){var c=_.value;null!=c.m_pProgress&&(c.m_pProgress.state=ProgressState.Abort),c.m_pCallback(null)}}catch(t){l=!0,h=t}finally{try{!m&&u.return&&u.return()}finally{if(l)throw h}}}e.m_pAsyncList=null}})}},{key:"Destroy",value:function(){this.m_mHandle.Destroy(),null!=this.collectionDesc&&this.collectionDesc.Destory(),null!=this.type&&this.type.Remove(this),this.m_nLoading=0,this.m_nRefCount=0,this.m_pIcon=null,this.m_pAsyncList=null}},{key:"iconUrl",value:function(){return null==this.collectionDesc?"":this.collectionDesc.iconUrl}},{key:"uiName",get:function(){return null==this.collectionDesc?"未命名":this.collectionDesc.name}},{key:"uiDesc",get:function(){return null==this.collectionDesc?"":this.collectionDesc.desc}},{key:"uiSprite",get:function(){return this.m_pIcon}},{key:"version",get:function(){return 1e3}},{key:"handle",get:function(){return this.m_mHandle}},{key:"collectionType",get:function(){return this.m_eCollectionType}},{key:"collectionDesc",get:function(){return this.m_pCollectionDesc}},{key:"id",get:function(){return null==this.collectionDesc?-1:this.collectionDesc.id}},{key:"typeId",get:function(){return null==this.collectionDesc?-1:this.collectionDesc.typeId}},{key:"type",get:function(){return this.m_pType},set:function(t){this.m_pType=t}},{key:"loading",get:function(){return this.m_nLoading},set:function(t){this.m_nLoading=t}},{key:"refCount",get:function(){return this.m_nRefCount},set:function(t){this.m_nRefCount=t,0==this.m_nRefCount&&this.Destroy()}},{key:"holder",get:function(){return this.m_pHolder},set:function(t){this.m_pHolder=t}}]),t}();MenuItem.g_pContext=new HeapContext(MenuItem);var Attachment=function(){function t(){_classCallCheck(this,t),this.m_mHandle=new Handle(t,0),this.m_mMaster=new Handle(t,0),this.m_mParent=new Handle(t,0),this.m_mMenuItem=new Handle(MenuItem,0),this.m_pEntity=null,this.m_pBinding=null,this.m_nFlags=0,this.m_pName=null,this.m_nUserData=0,this.m_pHook=null}return _createClass(t,[{key:"OnCreate",value:function(t){}},{key:"OnEmploy",value:function(e){this.m_mHandle=new Handle(t,e)}},{key:"OnUnemploy",value:function(){}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){t.ReadUInt32();this.m_mHandle.Number=t.ReadUInt32(),this.m_mMaster.Number=t.ReadUInt32(),this.m_mParent.Number=t.ReadUInt32(),this.m_mMenuItem.Number=t.ReadUInt32(),this.m_pBinding=t.ReadString(),this.m_nFlags=t.ReadInt32(),this.m_pName=t.ReadString(),this.m_nUserData=t.ReadUInt32(),this.valid=!0;var e=t.ReadInt32();if(e==EntityType.Group){var n=t.ReadInt32();this.m_pEntity=MiaokitDC.DC.GroupFactory(n),this.m_pEntity.UnSerialize(t)}else if(e==EntityType.Collection){var i=t.ReadInt32();this.m_pEntity=MiaokitDC.DC.CollectionFactory(i,null),this.m_pEntity.UnSerialize(t)}else if(e==EntityType.Component){var a=t.ReadInt32();this.m_pEntity=MiaokitDC.DC.ComponentFactory(a),this.m_pEntity.UnSerialize(t)}else t.ReadInt32(),this.m_pEntity=null,alert("Attachment.UnSerialize(): Invalid type!"+e);t.ReadBoolean()&&(new CameraState).UnSerialize(t);501347081!=t.ReadInt32()&&alert("Attachment.UnSerialize(): Bad end!")}},{key:"version",get:function(){return 1e3}},{key:"handle",get:function(){return this.m_mHandle}},{key:"master",get:function(){return this.m_mMaster},set:function(t){this.m_mMaster.Number=t.Number}},{key:"parent",get:function(){return this.m_mParent},set:function(t){this.m_mParent.Number=t.Number,alert("此处未完全实现")}},{key:"menuItem",get:function(){return this.m_mMenuItem},set:function(t){this.m_mMenuItem.Number=t.Number}},{key:"entityType",get:function(){return null==this.m_pEntity?EntityType.Invalid:this.m_pEntity.type}},{key:"entity",get:function(){return this.m_pEntity},set:function(t){this.m_pEntity=t}},{key:"binding",get:function(){return null==this.m_pBinding?"":this.m_pBinding}},{key:"valid",get:function(){return(1&this.m_nFlags)>0},set:function(t){t?this.m_nFlags|=1:this.m_nFlags&=-2}},{key:"active",get:function(){return(2&this.m_nFlags)>0},set:function(t){t?this.m_nFlags|=2:this.m_nFlags&=-3}},{key:"enable",get:function(){return(4&this.m_nFlags)>0},set:function(t){t?this.m_nFlags|=4:this.m_nFlags&=-5}},{key:"builtin",get:function(){return(8&this.m_nFlags)>0},set:function(t){t?this.m_nFlags|=8:this.m_nFlags&=-9}},{key:"lockTransform",get:function(){return(16&this.m_nFlags)>0},set:function(t){t?this.m_nFlags|=16:this.m_nFlags&=-17}},{key:"name",get:function(){return this.m_pName},set:function(t){this.m_pName=t}},{key:"userData",get:function(){return this.m_nUserData},set:function(t){this.m_nUserData=t}},{key:"hook",get:function(){return this.m_pHook},set:function(t){this.m_pHook=t,null!=this.m_pHook&&(this.m_pBinding=this.m_pHook.name)}}]),t}();Attachment.g_pContext=new HeapContext(Attachment);var LayerType,AssetsLoader=function(){function t(){_classCallCheck(this,t),this.m_pMenuItemList=null,this.m_pIconList=null,this.m_pDelegateList=null,this.m_pCache=null,this.m_pZipFile=null,this.m_pZipLoader=null,this.m_pProgressBar1=null,this.m_pProgressBar2=null,this.m_pProgressBar=null,this.m_nFlushRate=0,this.m_nFlushScale=0,this.m_pMenuItemList=new Array,this.m_pIconList=new Array,this.m_pDelegateList=new Array,this.m_pCache=new Array}return _createClass(t,[{key:"PushItem",value:function(t){this.m_pMenuItemList.push(t)}},{key:"PushIcon",value:function(t){this.m_pIconList.push(t)}},{key:"PushDelegate",value:function(t,e){this.m_pDelegateList.push({m_nWork:t,m_pDelegate:e})}},{key:"Load",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=this,n=e.m_pMenuItemList.length;if(t==n){e.Flush(!0,.9,.1);var i=MiaokitDC.DC.m_nCurWork,a=!0,o=!1,s=void 0;try{for(var r,m=this.m_pDelegateList[Symbol.iterator]();!(a=(r=m.next()).done);a=!0){var l=r.value;MiaokitDC.DC.SwitchWork(l.m_nWork),l.m_pDelegate()}}catch(t){o=!0,s=t}finally{try{!a&&m.return&&m.return()}finally{if(o)throw s}}return this.Flush(!1,0,0),Engine.g_pInstance.project.SwitchWorkForIndex(i),Engine.g_pInstance.project.ActiveFloor(0),e.m_pProgressBar=e.m_pProgressBar2,void this.Load2(0)}e.Flush(!0,.6+t/n*.3,1/n*.3),t<n&&e.m_pMenuItemList[t].LoadAndSet(null,function(n){e.Load(t+1)})}},{key:"Load2",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=this,n=e.m_pIconList.length;if(t==n)return this.Flush(!1,0,0),MiaokitDC.g_pScene.updateMatrixWorld(!0),void(MiaokitDC.g_pScene.autoUpdate=!1);e.Flush(!0,t/n,1/n),t<n&&e.m_pIconList[t].Load(function(){e.Load2(t+1)})}},{key:"LoadModel",value:function(t,e){var n=this,i=!0,a=!1,o=void 0;try{for(var s,r=n.m_pCache[Symbol.iterator]();!(i=(s=r.next()).done);i=!0){var m=s.value;if(t==m.m_pUrl)return void e(m.m_pObject)}}catch(t){a=!0,o=t}finally{try{!i&&r.return&&r.return()}finally{if(a)throw o}}var l=n.m_pZipFile.file(t);void 0!=l&&null!=l?n.m_pZipFile.file(t).async("string").then(function(i){(new THREE.ObjectLoader).parse(JSON.parse(i),function(i){var a=new GameObject("",GameObjectType.Model);a.m_pObject=i,n.m_pCache.push({m_pUrl:t,m_pObject:a}),e(a)})},function(i){console.info("AssetsLoader.LoadModel(): error.",t),n.m_pCache.push({m_pUrl:t,m_pObject:null}),e(null)}):(console.info("AssetsLoader.LoadModel(): pFile == null.",t),n.m_pCache.push({m_pUrl:t,m_pObject:null}),e(null))}},{key:"LoadTexture",value:function(t,e){var n=this,i=!0,a=!1,o=void 0;try{for(var s,r=n.m_pCache[Symbol.iterator]();!(i=(s=r.next()).done);i=!0){var m=s.value;if(t==m.m_pUrl)return void e(m.m_pObject)}}catch(t){a=!0,o=t}finally{try{!i&&r.return&&r.return()}finally{if(a)throw o}}var l=n.m_pZipFile.file(t);void 0!=l&&null!=l?l.async("base64").then(function(i){var a=new THREE.Texture,o=new Image,s=t.substr(t.lastIndexOf(".")+1);o.src="data:image/"+s+";base64,"+i,a.image=o,a.format="jpg"===s||"jpeg"===s?THREE.RGBFormat:THREE.RGBAFormat,a.needsUpdate=!0,n.m_pCache.push({m_pUrl:t,m_pObject:a}),e(a)},function(i){console.info("AssetsLoader.LoadTexture(): error.",t),n.m_pCache.push({m_pUrl:t,m_pObject:null}),e(null)}):(console.info("AssetsLoader.LoadTexture(): pFile == null.",t),n.m_pCache.push({m_pUrl:t,m_pObject:null}),e(null))}},{key:"LoadIcon",value:function(t,e){var n=this,i=!0,a=!1,o=void 0;try{for(var s,r=this.m_pCache[Symbol.iterator]();!(i=(s=r.next()).done);i=!0){var m=s.value;if(t==m.m_pUrl)return void e(m.m_pObject)}}catch(t){a=!0,o=t}finally{try{!i&&r.return&&r.return()}finally{if(a)throw o}}var l=t.substring(t.lastIndexOf("/")+1);n.LoadTexture(l,function(i){if(null!=i){var a=new Material(MaterialType.Point);a.SetTexture(0,i),n.m_pCache.push({m_pUrl:t,m_pObject:a}),e(a)}else n.m_pCache.push({m_pUrl:t,m_pObject:null}),e(null)})}},{key:"LoadProject",value:function(t,e){var n=this;n.m_pProgressBar=n.m_pProgressBar1,n.LoadResources(function(){n.Flush(!0,.4,.2),n.m_pZipFile.file("project.bin").async("arraybuffer").then(function(t){n.Flush(!0,.45,1.5),e(t)},function(t){n.Flush(!0,.45,1.5),e(null)})})}},{key:"LoadResources",value:function(t){var e=this;e.Flush(!0,0,.3),e.m_pZipLoader(function(n){e.Flush(!0,.3,.05),e.m_pZipFile=n,e.LoadTexture("lightmap.png",function(n){e.Flush(!0,.35,.05),n.wrapS=THREE.RepeatWrapping,n.wrapT=THREE.RepeatWrapping,n.repeat.set(1,-1),Material.g_aMaterial[1]=new THREE.MeshBasicMaterial({map:n}),Material.g_aMaterial[3]=Material.g_aMaterial[1],e.LoadTexture("shadow.png",function(e){e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping,e.repeat.set(1,1),Material.g_aMaterial[5]=new THREE.MeshBasicMaterial({map:e,opacity:.5}),Material.g_aMaterial[5].transparent=!0,Material.g_aMaterial[0]=new THREE.MeshBasicMaterial,Material.g_aMaterial[2]=new THREE.MeshBasicMaterial({color:16777215}),Material.g_aMaterial[4]=new THREE.MeshBasicMaterial({color:16448250,map:null}),Material.g_aMaterial[6]=new THREE.MeshBasicMaterial({color:26265,side:THREE.DoubleSide}),Material.g_aMaterial[7]=new THREE.PointsMaterial({size:20,sizeAttenuation:!1,map:null,alphaTest:0,transparent:!0}),t()})})})}},{key:"Flush",value:function(t,e,n){this.m_nFlushRate=e,this.m_nFlushScale=n,this.m_pProgressBar(t,e)}},{key:"FlushRate",value:function(t){this.m_pProgressBar(!0,this.m_nFlushRate+this.m_nFlushScale*t.loaded/t.total)}}]),t}(),Delegate=function t(e,n){_classCallCheck(this,t),this.m_pProgress=null,this.m_pCallback=null,this.m_pProgress=e,this.m_pCallback=n},CameraState=function(){function t(){_classCallCheck(this,t),this.m_mPerspectPos=new Vector3(0,0,0),this.m_nVRotated=0,this.m_nHRotated=0,this.m_nForwardMoved=0,this.m_mOrthoPos=new Vector3(0,0,0),this.m_nOrthoScaled=0,this.m_nZRotated=0}return _createClass(t,[{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){t.ReadUInt32();this.m_mPerspectPos.x=t.ReadSingle(),this.m_mPerspectPos.y=t.ReadSingle(),this.m_mPerspectPos.z=t.ReadSingle(),this.m_nVRotated=t.ReadSingle(),this.m_nHRotated=t.ReadSingle(),this.m_mOrthoPos.x=t.ReadSingle(),this.m_mOrthoPos.y=t.ReadSingle(),this.m_mOrthoPos.z=t.ReadSingle(),this.m_nOrthoScaled=t.ReadSingle(),this.m_nZRotated=t.ReadSingle(),this.m_nForwardMoved=t.ReadSingle(),501347081!=t.ReadInt32()&&alert("CameraCtrl.Config.UnSerialize(): Bad end!")}},{key:"version",get:function(){return 1e3}}]),t}(),Hook=function(){function t(e){_classCallCheck(this,t),this.m_pObject=null,this.m_pAttachment=null,this.m_pObject=e}return _createClass(t,[{key:"SetLayer",value:function(){}},{key:"name",get:function(){return this.gameObject.name}},{key:"gameObject",get:function(){return this.m_pObject}},{key:"attachment",get:function(){return this.m_pAttachment},set:function(t){this.m_pAttachment=t}}],[{key:"LayerEnumToLayer",value:function(t){return t-LayerType.Invalid}},{key:"EntityEnumToLayer",value:function(t){var e=LayerType.Invalid;switch(t){case CollectionType.AHoleModel:e=LayerType.AHoleModel;break;case CollectionType.AEdgeModel:e=LayerType.AEdgeModel;break;case CollectionType.EBuildingModel:e=LayerType.EBuildingModel;break;case CollectionType.EStoreyModel:e=LayerType.EStoreyModel;break;case CollectionType.EFurnitureModel:e=LayerType.EFurnitureModel;break;case CollectionType.EAssetsModel:e=LayerType.EAssetsModel;break;default:alert("Hook.EntityEnumToLayer(): !eType "+t)}return this.LayerEnumToLayer(e)}},{key:"EntityEnumToLayer2",value:function(t){var e=LayerType.Invalid;switch(t){case ComponentType.Panel:e=LayerType.EPanel;break;case ComponentType.Edge:e=LayerType.AEdge;break;case ComponentType.AreaBottom:e=LayerType.AAreaBottom;break;case ComponentType.AreaTop:e=LayerType.AAreaTop;break;default:alert("Hook.EntityEnumToLayer(): !eType "+t)}return this.LayerEnumToLayer(e)}},{key:"LayerToEntityEnum",value:function(t){var e={m_eEntity:0,m_eType:0};switch(t+LayerType.Invalid){case LayerType.AEdge:e.m_eEntity=EntityType.Component,e.m_eType=ComponentType.Edge;break;case LayerType.AAreaBottom:e.m_eEntity=EntityType.Component,e.m_eType=ComponentType.AreaBottom;break;case LayerType.AAreaTop:e.m_eEntity=EntityType.Component,e.m_eType=ComponentType.AreaTop;break;case LayerType.AHoleModel:e.m_eEntity=EntityType.Collection,e.m_eType=CollectionType.AHoleModel;break;case LayerType.AEdgeModel:e.m_eEntity=EntityType.Collection,e.m_eType=CollectionType.AEdgeModel;break;case LayerType.EBuildingModel:e.m_eEntity=EntityType.Collection,e.m_eType=CollectionType.EBuildingModel;break;case LayerType.EStoreyModel:e.m_eEntity=EntityType.Collection,e.m_eType=CollectionType.EStoreyModel;break;case LayerType.EFurnitureModel:e.m_eEntity=EntityType.Collection,e.m_eType=CollectionType.EFurnitureModel;break;case LayerType.EAssetsModel:e.m_eEntity=EntityType.Collection,e.m_eType=CollectionType.EAssetsModel;break;case LayerType.EPanel:e.m_eEntity=EntityType.Component,e.m_eType=ComponentType.Panel;break;case LayerType.EGroup:e.m_eEntity=EntityType.Group,e.m_eType=GroupType.Group;break;case LayerType.EPlaceholder:e.m_eEntity=EntityType.Placeholder,e.m_eType=0}return e}}]),t}();!function(t){t[t.Invalid=-8]="Invalid",t[t.Horizontal=1]="Horizontal",t[t.TransformCtrl=2]="TransformCtrl",t[t.AEdge=3]="AEdge",t[t.AAreaBottom=4]="AAreaBottom",t[t.AAreaTop=5]="AAreaTop",t[t.AHoleModel=6]="AHoleModel",t[t.AEdgeModel=7]="AEdgeModel",t[t.EBuildingModel=8]="EBuildingModel",t[t.EStoreyModel=9]="EStoreyModel",t[t.EFurnitureModel=10]="EFurnitureModel",t[t.EAssetsModel=11]="EAssetsModel",t[t.EPanel=12]="EPanel",t[t.EGroup=13]="EGroup",t[t.EPlaceholder=14]="EPlaceholder",t[t.ELayerBounds=15]="ELayerBounds",t[t.WarningBoard=16]="WarningBoard"}(LayerType||(LayerType={}));var MiaokitDC=function(){function t(){_classCallCheck(this,t),this.DescriptorFactory=null,this.GroupFactory=null,this.CollectionFactory=null,this.ComponentFactory=null,this.m_bEnabled=!1,this.m_eViewMode=ViewMode.Invalid,this.m_nCurWork=0,this.m_aWork=null,this.m_aWorkData=null,this.m_pAssetsLoader=null,this.m_pNavigator=null,this.m_pCategories=null,this.m_pProjectRoot=null,this.m_pBaseUrl="project/",this.m_pServerUrl="http://115.28.168.123:8015/",this.m_pCategories=new MenuType,this.m_pProjectRoot=new GameObject("MiaokitDC",GameObjectType.Empty),this.m_pNavigator=new NNavigator,this.m_pAssetsLoader=new AssetsLoader,t.g_pScene.add(this.m_pProjectRoot.m_pObject)}return _createClass(t,[{key:"Update",value:function(){NavChartDC.DC.Update()}},{key:"InitWorks",value:function(t,e){this.m_bEnabled&&(this.Reset(),this.m_bEnabled=!1),this.m_aWorkData=t,this.m_aWork=new Array(256);for(var n=0;n<256;n++)null!=this.m_aWorkData[n]&&(this.m_aWork[n]=new Work(n,this.m_aWorkData[n]));e(null)}},{key:"SwitchWork",value:function(t){null!=this.m_aWork[t]?(this.m_aWork[t].Active(),this.m_nCurWork=t,this.m_bEnabled=!0):alert("MiaokitDC.SwitchWork(): m_aWork[nIndex] == null.")}},{key:"GetWork",value:function(t){return this.m_aWork[t]}},{key:"Reset",value:function(){for(var t=0;t<256;t++)null!=this.m_aWork[t]&&this.m_aWork[t].Destroy(),this.m_aWorkData[t]=null;this.m_aWork=new Work[256],ALinerDC.DC=null,NavChartDC.DC=null,APoint.g_pContext.SwitchState(null),AAdjoin.g_pContext.SwitchState(null),AEdge.g_pContext.SwitchState(null),MenuItem.g_pContext.SwitchState(null),Attachment.g_pContext.SwitchState(null),NPoint.g_pContext.SwitchState(null),NAdjoin.g_pContext.SwitchState(null),NEdge.g_pContext.SwitchState(null),NLandmark.g_pContext.SwitchState(null),NavChart.g_pContext.SwitchState(null)}},{key:"ActiveLayer",value:function(t){ALinerDC.DC.ActiveLayer(t),NavChartDC.DC.ActiveLayer(t),EyejiaDC.DC.ActiveLayer(t)}},{key:"BindMenuType",value:function(t){return this.BindMenuType2(this.m_pCategories,t)}},{key:"BindMenuType2",value:function(t,e){if(null!=t){if(e.typeId==t.m_nID)return e.type=t,!0;if(null!=t.children){var n=!0,i=!1,a=void 0;try{for(var o,s=t.children[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var r=o.value;if(this.BindMenuType2(r,e))return!0}}catch(t){i=!0,a=t}finally{try{!n&&s.return&&s.return()}finally{if(i)throw a}}}}return!1}},{key:"viewMode",get:function(){return this.m_eViewMode},set:function(t){switch(this.m_eViewMode=t,t){case ViewMode.View2D:Engine.g_pInstance.SetViewMode(0);break;case ViewMode.View3D:Engine.g_pInstance.SetViewMode(1)}}}]),t}();MiaokitDC.g_pScene=null,MiaokitDC.DC=null;var ViewMode,Work=function(){function t(e,n){if(_classCallCheck(this,t),this.m_pALinerDC=null,this.m_pEyejiaDC=null,this.m_pNavChartDC=null,this.m_pPointHeapState=null,this.m_pAdjoinHeapState=null,this.m_pEdgeHeapState=null,this.m_pMenuItemHeapState=null,this.m_pAttachmentHeapState=null,this.m_nIndex=0,this.m_pID=null,this.m_aData=null,this.m_pWorkRoot=null,MiaokitDC.DC.m_aWork[e]=this,this.m_pPointHeapState=APoint.g_pContext.SwitchState(null),this.m_pAdjoinHeapState=AAdjoin.g_pContext.SwitchState(null),this.m_pEdgeHeapState=AEdge.g_pContext.SwitchState(null),this.m_pMenuItemHeapState=MenuItem.g_pContext.SwitchState(null),this.m_pAttachmentHeapState=Attachment.g_pContext.SwitchState(null),this.m_pID="",this.m_nIndex=e,this.m_aData=n,this.m_pWorkRoot=new GameObject("Work "+e,GameObjectType.Empty),this.m_pWorkRoot.parent=MiaokitDC.DC.m_pProjectRoot,null==this.m_aData)this.m_pALinerDC=new ALinerDC(this.m_nIndex,null),this.m_pEyejiaDC=new EyejiaDC(this.m_nIndex,null),this.m_pNavChartDC=new NavChartDC(this.m_nIndex,null);else{var i=new BinaryReader(this.m_aData);this.UnSerialize(i)}console.log("为路点绑定房间");var a=!0,o=!1,s=void 0;try{for(var r,m=this.m_pALinerDC.m_pLayerMgr.m_pLayerList[Symbol.iterator]();!(a=(r=m.next()).done);a=!0){var l=r.value,h=!0,_=!1,u=void 0;try{for(var c,p=l.m_pLabelList[Symbol.iterator]();!(h=(c=p.next()).done);h=!0){var d=c.value,y=!0,C=!1,v=void 0;try{for(var f,g=this.m_pNavChartDC.m_pLayerMgr.GetLayer(l.m_nIndex).m_mLandmarkList[Symbol.iterator]();!(y=(f=g.next()).done);y=!0){var T=f.value;null!=d.m_pArea&&null!=T.m_mPoint&&(d.m_pArea.CollideBottom(T.m_mPoint.Object.m_mPosition)&&(T.m_pAAreaLabel=d))}}catch(t){C=!0,v=t}finally{try{!y&&g.return&&g.return()}finally{if(C)throw v}}}}catch(t){_=!0,u=t}finally{try{!h&&p.return&&p.return()}finally{if(_)throw u}}}}catch(t){o=!0,s=t}finally{try{!a&&m.return&&m.return()}finally{if(o)throw s}}this.m_pPointHeapState=APoint.g_pContext.SwitchState(this.m_pPointHeapState),this.m_pAdjoinHeapState=AAdjoin.g_pContext.SwitchState(this.m_pAdjoinHeapState),this.m_pEdgeHeapState=AEdge.g_pContext.SwitchState(this.m_pEdgeHeapState),this.m_pMenuItemHeapState=MenuItem.g_pContext.SwitchState(this.m_pMenuItemHeapState),this.m_pAttachmentHeapState=Attachment.g_pContext.SwitchState(this.m_pAttachmentHeapState)}return _createClass(t,[{key:"version",value:function(){return 1e3}},{key:"Update",value:function(){}},{key:"Active",value:function(){null!=ALinerDC.DC&&ALinerDC.DC.Active(!1),null!=EyejiaDC.DC&&EyejiaDC.DC.Active(!1),null!=NavChartDC.DC&&NavChartDC.DC.Active(!1),APoint.g_pContext.SwitchState(this.m_pPointHeapState),AAdjoin.g_pContext.SwitchState(this.m_pAdjoinHeapState),AEdge.g_pContext.SwitchState(this.m_pEdgeHeapState),MenuItem.g_pContext.SwitchState(this.m_pMenuItemHeapState),Attachment.g_pContext.SwitchState(this.m_pAttachmentHeapState),ALinerDC.DC=this.m_pALinerDC,EyejiaDC.DC=this.m_pEyejiaDC,NavChartDC.DC=this.m_pNavChartDC,ALinerDC.DC.Active(!0),EyejiaDC.DC.Active(!0),NavChartDC.DC.Active(!0)}},{key:"Destroy",value:function(){console.warn("Work.Destroy(): Invalid.")}},{key:"UnSerialize",value:function(t){t.ReadUInt32();for(this.m_pID=t.ReadString();;){var e=t.ReadInt32(),n=t.ReadInt64();switch(e){case 0:break;case 1:this.m_pALinerDC=new ALinerDC(this.m_nIndex,t);break;case 2:this.m_pNavChartDC=new NavChartDC(this.m_nIndex,t);break;case 3:this.m_pEyejiaDC=new EyejiaDC(this.m_nIndex,t);break;default:return void alert("Work.UnSerialize(): Invalid module."+e)}if(0==e&&4294967295==n)break}501347081!=t.ReadInt32()&&alert("Work.UnSerialize(): Bad end!")}}]),t}();!function(t){t[t.Invalid=0]="Invalid",t[t.View2D=1]="View2D",t[t.View3D=2]="View3D",t[t.Fps=3]="Fps"}(ViewMode||(ViewMode={}));var GameObjectType,MaterialType,BinaryWriter=function t(){_classCallCheck(this,t)},BinaryReader=function(){function t(e){_classCallCheck(this,t),this.m_pBuffer=null,this.m_pReader=null,this.m_nPosition=0,this.m_pBuffer=e,this.m_pReader=new DataView(e),this.m_nPosition=0}return _createClass(t,[{key:"ReadBoolean",value:function(){var t=this.m_pReader.getInt8(this.m_nPosition);return this.m_nPosition+=1,t>0}},{key:"ReadInt32",value:function(){var t=this.m_pReader.getInt32(this.m_nPosition,!0);return this.m_nPosition+=4,t}},{key:"ReadUInt32",value:function(){var t=this.m_pReader.getUint32(this.m_nPosition,!0);return this.m_nPosition+=4,t>>>0}},{key:"ReadInt64",value:function(){var t=this.ReadUInt32(),e=this.ReadUInt32();return 2147483647==e&&4294967295==t?4294967295:(e<<32)+t}},{key:"ReadSingle",value:function(){var t=this.m_pReader.getFloat32(this.m_nPosition,!0);return this.m_nPosition+=4,t}},{key:"ReadString",value:function(){var t=this.m_pReader.getUint8(this.m_nPosition);if(this.m_nPosition+=1,t>128){var e=this.m_pReader.getUint8(this.m_nPosition);this.m_nPosition+=1,t+=256*e}var n=new Int8Array(this.m_pBuffer,this.m_nPosition,t);return this.m_nPosition+=t,this.ByteToString(n)}},{key:"ReadBytes",value:function(t){var e=this.m_pBuffer.slice(this.m_nPosition,this.m_nPosition+t);return this.m_nPosition+=t,e}},{key:"ByteToString",value:function(t){for(var e="",n=0;n<t.length;){var i=t[n],a=0;i>>>7==0?(e+=String.fromCharCode(t[n]),n+=1):252==(252&i)?(a=(3&t[n])<<30,a|=(63&t[n+1])<<24,a|=(63&t[n+2])<<18,a|=(63&t[n+3])<<12,a|=(63&t[n+4])<<6,a|=63&t[n+5],e+=String.fromCharCode(a),n+=6):248==(248&i)?(a=(7&t[n])<<24,a|=(63&t[n+1])<<18,a|=(63&t[n+2])<<12,a|=(63&t[n+3])<<6,a|=63&t[n+4],e+=String.fromCharCode(a),n+=5):240==(240&i)?(a=(15&t[n])<<18,a|=(63&t[n+1])<<12,a|=(63&t[n+2])<<6,a|=63&t[n+3],e+=String.fromCharCode(a),n+=4):224==(224&i)?(a=(31&t[n])<<12,a|=(63&t[n+1])<<6,a|=63&t[n+2],e+=String.fromCharCode(a),n+=3):192==(192&i)?(a=(63&t[n])<<6,a|=63&t[n+1],e+=String.fromCharCode(a),n+=2):(e+=String.fromCharCode(t[n]),n+=1)}return e}},{key:"Position",set:function(t){this.m_nPosition=t}}]),t}(),GameObject=function(){function t(e,n){switch(_classCallCheck(this,t),this.m_nLayer=0,this.m_pName=null,this.m_eType=GameObjectType.Empty,this.m_pObject=null,this.m_pMaterial=null,this.m_pHook=null,this.m_pName=e,this.m_eType=n,n){case GameObjectType.Empty:this.m_pObject=new THREE.Group;break;case GameObjectType.Mesh:this.m_pObject=new THREE.Mesh;break;case GameObjectType.Model:this.m_pObject=null;break;case GameObjectType.Line:this.m_pObject=new THREE.Line;break;case GameObjectType.Point:this.m_pObject=new THREE.Points;break;default:alert("GameObject.constructor(): !eType.")}null!=this.m_pObject&&(this.m_pObject.name=this.m_pName,this.m_pObject.userData=this)}return _createClass(t,[{key:"SetActive",value:function(t){this.m_pObject.visible=t}},{key:"Destroy",value:function(){if(null!=this.m_pObject.parent)return this.m_pObject.parent.remove(this.m_pObject);this.m_pObject.userData=null,this.m_pObject=null,this.m_pMaterial=null}},{key:"SetGeometry",value:function(t,e){var n=new THREE.BufferGeometry;n.addAttribute("position",new THREE.BufferAttribute(t.m_aPosition,3)),n.addAttribute("normal",new THREE.BufferAttribute(t.m_aNormal,3)),n.addAttribute("uv",new THREE.BufferAttribute(t.m_aTexUV,2)),this.m_pMaterial=e,this.m_pObject.geometry=n,this.m_pObject.material=e.m_pMaterial}},{key:"SetText",value:function(t,e){var n=new THREE.BufferGeometry,i=Material.g_pFont.generateShapes(t,.5,2),a=new THREE.ShapeGeometry(i);a.computeBoundingBox();var o=-.5*(a.boundingBox.max.x-a.boundingBox.min.x);a.translate(o,0,0),n.fromGeometry(a),this.m_pMaterial=e,this.m_pObject.geometry=a,this.m_pObject.material=e.m_pMaterial,this.m_pObject.rotateX(1.5708)}},{key:"SetLine",value:function(t){var e=new THREE.Geometry,n=e.vertices,i=[],a=null,o=0,s=!0,r=!1,m=void 0;try{for(var l,h=t[Symbol.iterator]();!(s=(l=h.next()).done);s=!0){var _=l.value,u=new THREE.Vector3(_.x,.5,_.z);null!=a&&(o+=a.distanceTo(u)),a=u,n.push(u)}}catch(t){r=!0,m=t}finally{try{!s&&h.return&&h.return()}finally{if(r)throw m}}var c=!0,p=!1,d=void 0;try{for(var y,C=t[Symbol.iterator]();!(c=(y=C.next()).done);c=!0){var v=y.value,f=new THREE.Color(16777215);f.setHSL(.3333*(o-v.x)/o,1,.5),i.push(f)}}catch(t){p=!0,d=t}finally{try{!c&&C.return&&C.return()}finally{if(p)throw d}}e.colors=i;var g=new THREE.LineBasicMaterial({color:16777215,opacity:1,linewidth:20,vertexColors:THREE.VertexColors});this.m_pObject.geometry=e,this.m_pObject.material=g}},{key:"SetPoint",value:function(t,e){var n=new THREE.Geometry;n.vertices=t,this.m_pMaterial=e,this.m_pObject.geometry=n,this.m_pObject.material=e.m_pMaterial,this.m_pObject.renderOrder=999,this.m_pObject.onBeforeRender=function(t){t.clearDepth()}}},{key:"AddHook",value:function(){return null==this.m_pHook&&(this.m_pHook=new Hook(this)),this.m_pHook}},{key:"FindChild",value:function(e){for(var n=this.m_pObject.children,i=n.length,a=0;a<i;a++){var o=n[a],s=_typeof(this);if(o.name===e){if(null==o.userData||s!==t){var r=new t("pName",GameObjectType.Model);r.m_pObject=o,o.userData=r}return o.userData}}return null}},{key:"CloneModel",value:function(){var e=new t(this.name,this.m_eType);return e.m_pObject=this.m_pObject.clone(),e.m_pObject.name=this.m_pName,e.m_pObject.userData=e,e.m_pObject.needUpdate=!0,e}},{key:"name",get:function(){return this.m_pObject.name}},{key:"layer",get:function(){return this.m_nLayer},set:function(t){this.m_nLayer=t}},{key:"parent",get:function(){return null!=this.m_pObject.parent?this.m_pObject.parent.userData:null},set:function(t){null!=t&&t.m_pObject.add(this.m_pObject)}},{key:"position",get:function(){return new Vector3(this.m_pObject.position.x,this.m_pObject.position.y,this.m_pObject.position.z)},set:function(t){this.m_pObject.position.set(t.x,t.y,t.z)}},{key:"eulerAngles",get:function(){return new Vector3(this.m_pObject.rotation.x,this.m_pObject.rotation.y,this.m_pObject.rotation.z)},set:function(t){this.m_pObject.rotation.set(.0174533*t.x,.0174533*t.y,.0174533*t.z)}},{key:"localScale",get:function(){return new Vector3(this.m_pObject.scale.x,this.m_pObject.scale.y,this.m_pObject.scale.z)},set:function(t){this.m_pObject.scale.set(t.x,t.y,t.z)}}]),t}(),Material=function(){function t(e){switch(_classCallCheck(this,t),this.m_pMaterial=null,this.m_aTexture=[null,null],e){case MaterialType.Edge:this.m_pMaterial=t.g_aMaterial[1];break;case MaterialType.Border:this.m_pMaterial=t.g_aMaterial[2];break;case MaterialType.Inborder:this.m_pMaterial=t.g_aMaterial[1];break;case MaterialType.AreaBottom:this.m_pMaterial=t.g_aMaterial[4].clone();break;case MaterialType.AreaBottomShadow:this.m_pMaterial=t.g_aMaterial[5];break;case MaterialType.Text:this.m_pMaterial=t.g_aMaterial[6];break;case MaterialType.Point:this.m_pMaterial=t.g_aMaterial[7].clone();break;default:alert("Material.constructor(): !eType."),this.m_pMaterial=t.g_aMaterial[0]}}return _createClass(t,[{key:"SetTexture",value:function(t,e){0==t?(this.m_aTexture[0]=e,this.m_pMaterial.map=e):(this.m_aTexture[1]=e,this.m_pMaterial.map=e)}},{key:"SetTextureOffset",value:function(t,e){0==t?null!=this.m_aTexture[0]&&this.m_aTexture[0].offset.set(e.x,e.y):null!=this.m_aTexture[1]&&this.m_aTexture[1].offset.set(e.x,e.y)}},{key:"SetTextureScale",value:function(t,e){0==t?null!=this.m_aTexture[0]&&this.m_aTexture[0].repeat.set(e.x,e.y):null!=this.m_aTexture[1]&&this.m_aTexture[1].repeat.set(e.x,e.y)}}]),t}();Material.g_aMaterial=[null,null,null,null,null,null,null,null],Material.g_pFont=null,function(t){t[t.Empty=0]="Empty",t[t.Mesh=1]="Mesh",t[t.Model=2]="Model",t[t.Line=3]="Line",t[t.Point=4]="Point"}(GameObjectType||(GameObjectType={})),function(t){t[t.Default=0]="Default",t[t.Edge=1]="Edge",t[t.Border=2]="Border",t[t.Inborder=3]="Inborder",t[t.AreaBottom=4]="AreaBottom",t[t.AreaBottomShadow=5]="AreaBottomShadow",t[t.Text=6]="Text",t[t.Point=7]="Point"}(MaterialType||(MaterialType={}));var Vector4=function t(e,n,i,a){_classCallCheck(this,t),this.x=0,this.y=0,this.z=0,this.w=0,this.x=e,this.y=n,this.z=i},Vector3=function(){function t(e,n,i){_classCallCheck(this,t),this.x=0,this.y=0,this.z=0,this.x=e,this.y=n,this.z=i}return _createClass(t,null,[{key:"Cross",value:function(t,e){var n=new THREE.Vector3(t.x,t.y,t.z),i=new THREE.Vector3(e.x,e.y,e.z),a=n.cross(i).normalize();return{x:a.x,y:a.y,z:a.z}}},{key:"Dot",value:function(t,e){var n=new THREE.Vector3(t.x,t.y,t.z),i=new THREE.Vector3(e.x,e.y,e.z);return n.dot(i)}},{key:"Sub",value:function(t,e){return{x:t.x-e.x,y:t.y-e.y,z:t.z-e.z}}},{key:"Add",value:function(t,e){return{x:t.x+e.x,y:t.y+e.y,z:t.z+e.z}}},{key:"Scale",value:function(t,e){return{x:e.x*t,y:e.y*t,z:e.z*t}}},{key:"Distance",value:function(t,e){return new THREE.Vector3(t.x,t.y,t.z).distanceTo(new THREE.Vector3(e.x,e.y,e.z))}},{key:"Normalize",value:function(t){var e=new THREE.Vector3(t.x,t.y,t.z).normalize();return{x:e.x,y:e.y,z:e.z}}},{key:"Length",value:function(t){return new THREE.Vector3(t.x,t.y,t.z).length()}},{key:"Clone",value:function(t){return{x:t.x,y:t.y,z:t.z}}},{key:"LerpVectors",value:function(t,e,n){var i=(new THREE.Vector3).lerpVectors(new THREE.Vector3(t.x,t.y,t.z),new THREE.Vector3(e.x,e.y,e.z),n);return{x:i.x,y:i.y,z:i.z}}},{key:"AngleTo",value:function(t,e){var n=new THREE.Vector3(t.x,t.y,t.z),i=new THREE.Vector3(e.x,e.y,e.z);return n.angleTo(i)}}]),t}(),Vector2=function(){function t(e,n){_classCallCheck(this,t),this.x=0,this.y=0,this.x=e,this.y=n}return _createClass(t,null,[{key:"Clone",value:function(t){return{x:t.x,y:t.y}}},{key:"Sub",value:function(t,e){return{x:t.x-e.x,y:t.y-e.y}}},{key:"AngleTo",value:function(t,e){var n,i,a,o=t.x,s=e.x,r=t.y,m=e.y,l=Math.acos(-1);if(r/=n=Math.sqrt(o*o+r*r),i=(o/=n)*(s/=n=Math.sqrt(s*s+m*m))+r*(m/=n),Math.abs(i-1)<=1e-6)a=0;else if(Math.abs(i+1)<=1e-6)a=l;else{a=Math.acos(i),o*m-s*r<0&&(a=2*l-a)}return 180*a/l}}]),t}(),Rect=function(){function t(e,n,i,a){_classCallCheck(this,t),this.x=0,this.y=0,this.width=0,this.height=0,this.x=e,this.y=n,this.width=i,this.height=a}return _createClass(t,null,[{key:"CrossArea",value:function(t,e){return t.x>e.x+e.width?0:t.x+t.width<e.x?0:t.y-t.height>e.y?0:t.y<e.y-e.height?0:Math.abs(Math.min(t.x+t.width,e.x+e.width)-Math.max(t.x,e.x))*Math.abs(Math.min(t.y,e.y)-Math.max(t.y-t.height,e.y-e.height))}},{key:"Clone",value:function(t){return{x:t.x,y:t.y,width:t.width,height:t.height}}}]),t}(),Mathf=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"Sin",value:function(t){return Math.sin(t)}},{key:"Cos",value:function(t){return Math.cos(t)}},{key:"Lerp",value:function(t,e,n){return THREE.Math.lerp(t,e,n)}}]),t}(),Engine=function(){function t(){_classCallCheck(this,t),this.m_pCameraCtrl=null,this.m_bActive=!1,this.m_pRenderer=null,this.m_pScene=null,this.m_pCamera=null,this.m_pStats=null,this.m_pProject=null,this.m_nCavasScale=null,this.pTestText="",this.pTestTextArr=[],this.nDisPointer=0,this.index=0,this.distanCount=0,this.nArrowsAnimationOffet=0,this.pPath=[],this.TextRectArr=[],this.pTouchNavPoint=null,this.m_pBluePos=null,null==t.g_pInstance?t.g_pInstance=this:alert("Engine.constructor(): Engine.g_pInstance != null.")}return _createClass(t,[{key:"Init",value:function(t,e,n,i,a,o,s,r,m,l,h,_,u,c,p,d,y,C,v,f,g){this.m_pScene=new THREE.Scene,this.m_pScene.scale.z=-this.m_pScene.scale.z,this.m_pScene.background=new THREE.Color(.9219,.8945,.8242);var T=new THREE.DirectionalLight(16777215,.5);T.position.set(-1,-1,1),this.m_pScene.add(T),this.m_pScene.add(new THREE.AmbientLight(16777215,1.5));var k=document.getElementById("webgl_container");this.m_pRenderer=new THREE.WebGLRenderer,this.m_pRenderer.setPixelRatio(window.devicePixelRatio),this.m_pRenderer.setSize(h,_),this.m_pRenderer.setFaceCulling(THREE.CullFaceFront,THREE.FrontFaceDirectionCCW),this.m_pRenderer.domElement.id="Scene",this.m_pRenderer.domElement.style.top="0rem",this.m_pRenderer.domElement.style.bottom="0rem",this.m_pRenderer.domElement.style.left="0rem",this.m_pRenderer.domElement.style.right="0rem",this.m_pRenderer.domElement.style.position="absolute",k.appendChild(this.m_pRenderer.domElement),this.m_nCavasScale=new Vector2(Number.parseFloat(this.m_pRenderer.domElement.style.width.replace("px",""))/this.m_pRenderer.domElement.width,Number.parseFloat(this.m_pRenderer.domElement.style.height.replace("px",""))/this.m_pRenderer.domElement.height),this.m_pTextCanvas=document.createElement("canvas"),this.m_pTextCanvas.height=this.m_pRenderer.domElement.height,this.m_pTextCanvas.width=this.m_pRenderer.domElement.width,this.m_pTextCanvas.style.height=this.m_pRenderer.domElement.style.height,this.m_pTextCanvas.style.width=this.m_pRenderer.domElement.style.width,this.m_pTextCanvas.style.top="0rem",this.m_pTextCanvas.style.bottom="0rem",this.m_pTextCanvas.style.left="0rem",this.m_pTextCanvas.style.right="0rem",this.m_pTextCanvas.style.position="absolute",this.m_pTextCanvas.style.zIndex="1",k.appendChild(this.m_pTextCanvas),this.m_pCanvasContext=this.m_pTextCanvas.getContext("2d"),this.m_pCanvasContext.font="30px Arial",null!=t&&(this.m_pStats=t,this.m_pStats.dom.style.top="2rem",this.m_pStats.dom.style.left="2rem",this.m_pStats.dom.style.position="absolute",k.appendChild(this.m_pStats.dom)),MiaokitDC.g_pScene=this.m_pScene,this.m_pCameraCtrl=new CameraCtrl3(this.m_pTextCanvas),this.m_pProject=new Project,MiaokitDC.DC.m_pNavigator.m_pSiteData=e,MiaokitDC.DC.m_pAssetsLoader.m_pZipLoader=n,MiaokitDC.DC.m_pAssetsLoader.m_pProgressBar1=i,MiaokitDC.DC.m_pAssetsLoader.m_pProgressBar2=a,this.m_pLayerUpdate=o,this.m_pNavBack=s,this.m_pOutWorkBack=r,this.m_pSwichViweModelBack=m,this.m_pChooseLayer=l,this.m_pNoFindPath=u,this.m_pCompass=c,this.m_pSetNavPoint=p,this.m_pChickTouchMove=d,this.m_pVoicePost=C,this.m_pMoviePost=v,this.m_pShowActiveLayer=f;var S=this;S.m_pProject.InitProject("project/project.bin",function(t){g(t),y(S.m_pProject.GetBlueToothList())})}},{key:"onclick",value:function(){console.log("dianjia sd")}},{key:"Destroy",value:function(){this.m_pProject.Destroy()}},{key:"Start",value:function(){this.m_bActive||(this.m_bActive=!0,this.m_pProject.Start(),this.Update())}},{key:"Stop",value:function(){this.m_bActive=!1,this.m_pProject.Stop()}},{key:"Update",value:function(){var e=t.g_pInstance;switch(null!=e.m_pStats&&e.m_pStats.begin(),e.m_pCameraCtrl.Update(),e.m_pProject.Update(),e.CanvasUpdate(),e.m_pRenderer.render(e.m_pScene,e.m_pCameraCtrl.m_pCamera),e.m_pCameraCtrl.m_eViewMode){case 0:e.m_pCompass(MiaokitDC.DC.GetWork(MiaokitDC.DC.m_nCurWork).m_pEyejiaDC.m_pLayerMgr.m_pActiveLayer.m_nDirectionHR);break;case 1:e.m_pCompass(MiaokitDC.DC.GetWork(MiaokitDC.DC.m_nCurWork).m_pEyejiaDC.m_pLayerMgr.m_pActiveLayer.m_nDirectionHR+e.m_pCameraCtrl.m_nRotatedH)}null!=e.m_pStats&&e.m_pStats.end(),e.m_bActive&&requestAnimationFrame(e.Update)}},{key:"SetViewMode",value:function(t){this.m_pCameraCtrl.SwitchMode(t),this.m_pSwichViweModelBack(t)}},{key:"CamTracking",value:function(t){this.m_pCameraCtrl.Tracking(t)}},{key:"SetViewState",value:function(t){this.m_pCameraCtrl.SetViewState(t)}},{key:"CanvasUpdate",value:function(){this.ClearText(),this.FillText(),this.UpdateNavigate(),this.ArrowsAnimation(),this.TouchNavPoint(),this.CurPosUpdata()}},{key:"test",value:function(){this.m_pCanvasContext.fillStyle="#7c6160",this.m_pCanvasContext.font="30px Arial",this.m_pCanvasContext.fillText("实时位置 ："+this.pTestText,90,30)}},{key:"test2",value:function(){if(this.m_pCanvasContext.fillStyle="#7c6160",this.m_pCanvasContext.font="30px Arial",this.m_pCanvasContext.fillText("感应到的蓝牙个数："+this.pTestTextArr.length,90,60),this.pTestTextArr.length>0){var t=0,e=!0,n=!1,i=void 0;try{for(var a,o=this.pTestTextArr[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var s=a.value;t++,this.m_pCanvasContext.fillText("测试 ："+s,90,30*(t+3))}}catch(t){n=!0,i=t}finally{try{!e&&o.return&&o.return()}finally{if(n)throw i}}}}},{key:"ClearText",value:function(){this.m_pCanvasContext.clearRect(0,0,this.m_pTextCanvas.width,this.m_pTextCanvas.height),this.TextRectArr=[]}},{key:"UpdateNavigate",value:function(){var t=0;if(null!=this.pPath){var e=!0,n=!1,i=void 0;try{for(var a,o=this.pPath[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var s=a.value,r=0;if(s.m_nWork==MiaokitDC.DC.m_nCurWork&&s.m_nLayer==ALinerDC.DC.m_pLayerMgr.m_pActiveLayer.m_nIndex){var m=!0,l=!1,h=void 0;try{for(var _,u=s.m_aPath[Symbol.iterator]();!(m=(_=u.next()).done);m=!0){var c=_.value,p=this.m_pCameraCtrl.WorldToScenePos(c);if(0==r?(this.m_pCanvasContext.beginPath(),this.m_pCanvasContext.moveTo(p.x,p.y)):this.m_pCanvasContext.lineTo(p.x,p.y),r==s.m_aPath.length-1){this.m_pCanvasContext.lineWidth=30,this.m_pCanvasContext.strokeStyle="#13c768",this.m_pCanvasContext.stroke(),this.m_pCanvasContext.closePath();var d="";t==this.pPath.length-1?d="到达终点:"+this.pPath[t].m_pEndPoint.m_mLandmark.Object.m_pName:(0==this.pPath[t].m_nWork&&0!=this.pPath[t+1].m_nWork&&(d="从这里进入"+MiaokitDC.DC.GetWork(this.pPath[t+1].m_nWork).m_pID),0==this.pPath[t+1].m_nWork&&0!=this.pPath[t].m_nWork&&(d="从这里出到"+MiaokitDC.DC.GetWork(this.pPath[t+1].m_nWork).m_pID),d=0!=this.pPath[t+1].m_nWork&&0!=this.pPath[t].m_nWork&&this.pPath[t+1].m_nWork!=this.pPath[t].m_nWork?"从这里到达"+MiaokitDC.DC.GetWork(this.pPath[t+1].m_nWork).m_pID+":"+(this.pPath[t+1].m_nLayer+1)+"F":"从这里到达"+(this.pPath[t+1].m_nLayer+1)+"F"),this.m_pCanvasContext.strokeStyle="#13c768",this.m_pCanvasContext.lineWidth=4,this.m_pCanvasContext.beginPath(),this.m_pCanvasContext.moveTo(p.x,p.y),this.m_pCanvasContext.lineTo(p.x,p.y-25),this.m_pCanvasContext.closePath(),this.m_pCanvasContext.stroke(),this.m_pCanvasContext.lineWidth=1,this.m_pCanvasContext.beginPath(),this.m_pCanvasContext.arc(p.x,p.y,10,0,2*Math.PI,!0),this.m_pCanvasContext.closePath(),this.m_pCanvasContext.fillStyle="#00bbfa",this.m_pCanvasContext.fill(),this.m_pCanvasContext.stroke(),this.m_pCanvasContext.fillStyle="#7c6160",this.m_pCanvasContext.font="36px Arial";var y=this.m_pCanvasContext.measureText(d).width;this.m_pCanvasContext.beginPath(),this.m_pCanvasContext.moveTo(p.x-(.5*y+5),p.y-25),this.m_pCanvasContext.lineTo(p.x+(.5*y+5),p.y-25),this.m_pCanvasContext.lineTo(p.x+(.5*y+5),p.y-85),this.m_pCanvasContext.lineTo(p.x-(.5*y+5),p.y-85),this.m_pCanvasContext.lineTo(p.x-(.5*y+5),p.y-25),this.m_pCanvasContext.closePath(),this.m_pCanvasContext.fillStyle="yellow",this.m_pCanvasContext.lineWidth=1,this.m_pCanvasContext.strokeStyle="#7c6160",this.m_pCanvasContext.fill(),this.m_pCanvasContext.stroke(),this.m_pCanvasContext.fillStyle="#7c6160",this.m_pCanvasContext.fillText(d,p.x-.5*y,p.y-40)}r++}}catch(t){l=!0,h=t}finally{try{!m&&u.return&&u.return()}finally{if(l)throw h}}}t++}}catch(t){n=!0,i=t}finally{try{!e&&o.return&&o.return()}finally{if(n)throw i}}}}},{key:"ArrowsAnimation",value:function(){if(this.pPath.length>0){this.nArrowsAnimationOffet+=.005*this.m_pCameraCtrl.m_nDistance;var t=.08*this.m_pCameraCtrl.m_nDistance;this.nArrowsAnimationOffet>t&&(this.nArrowsAnimationOffet=0);var e=!0,n=!0,i=!1,a=void 0;try{for(var o,s=this.pPath[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var r=o.value,m=0;if(r.m_nWork==MiaokitDC.DC.m_nCurWork&&r.m_nLayer==ALinerDC.DC.m_pLayerMgr.m_pActiveLayer.m_nIndex)for(;e;)this.nDisPointer=t*m+this.nArrowsAnimationOffet,e=this.PosOfDistan(this.nDisPointer,r),m++;e=!0}}catch(t){i=!0,a=t}finally{try{!n&&s.return&&s.return()}finally{if(i)throw a}}}}},{key:"PosOfDistan",value:function(t,e){for(;this.index<e.m_pPathPassage.length;){var n=e.m_pPathPassage[this.index];if(this.nDisPointer>=this.distanCount&&this.nDisPointer<=this.distanCount+n.m_nDistan){var i=(this.nDisPointer-this.distanCount+.03*this.m_pCameraCtrl.m_nDistance)/n.m_nDistan;return this.FillArrows(Vector3.LerpVectors(n.m_pStarPos,n.m_pEndPos,i),n.m_pStarPos),!0}this.distanCount+=n.m_nDistan,this.index++}return this.index=0,this.distanCount=0,!1}},{key:"FillText",value:function(){var t=NavChartDC.DC.m_pLayerMgr.m_pActiveLayer,e=!0,n=!1,i=void 0;try{for(var a,o=t.m_mLandmarkList[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var s=a.value;if(s.m_nIconType<1&&null!=s.m_pName&&"位置点"!=s.m_pName){var r=s.m_pName,m=s.m_mPoint.Object.m_mPosition;this.FillTextText2(r,m)}}}catch(t){n=!0,i=t}finally{try{!e&&o.return&&o.return()}finally{if(n)throw i}}}},{key:"FillTextText2",value:function(t,e){var n=this.m_pCanvasContext.measureText(t).width,i=this.m_pCameraCtrl.WorldToScenePos(e);if(!(i.z>=1))if(0==this.m_pCameraCtrl.m_eViewMode){var a=new Rect(i.x+10,i.y-10,n,30),o=!0,s=!1,r=void 0;try{for(var m,l=this.TextRectArr[Symbol.iterator]();!(o=(m=l.next()).done);o=!0){var h=m.value;if(Rect.CrossArea(a,h)>5)return}}catch(t){s=!0,r=t}finally{try{!o&&l.return&&l.return()}finally{if(s)throw r}}this.TextRectArr.push(a),this.m_pCanvasContext.fillStyle="#7c6160",this.m_pCanvasContext.font="30px Arial",this.m_pCanvasContext.fillText(t,i.x+10,i.y-10),this.m_pCanvasContext.beginPath(),this.m_pCanvasContext.arc(i.x,i.y,6,0,360,!1),this.m_pCanvasContext.fillStyle="#00bbfa",this.m_pCanvasContext.fill(),this.m_pCanvasContext.closePath(),this.m_pCanvasContext.beginPath(),this.m_pCanvasContext.moveTo(i.x,i.y),this.m_pCanvasContext.lineTo(i.x+10+n,i.y),this.m_pCanvasContext.lineWidth=2,this.m_pCanvasContext.strokeStyle="#00bbfa",this.m_pCanvasContext.stroke(),this.m_pCanvasContext.closePath()}else if(1==this.m_pCameraCtrl.m_eViewMode){var _=new Rect(i.x+20,i.y-30,n,30),u=!0,c=!1,p=void 0;try{for(var d,y=this.TextRectArr[Symbol.iterator]();!(u=(d=y.next()).done);u=!0){var C=d.value;if(Rect.CrossArea(_,C)>5)return}}catch(t){c=!0,p=t}finally{try{!u&&y.return&&y.return()}finally{if(c)throw p}}this.TextRectArr.push(_),this.m_pCanvasContext.fillStyle="#7c6160",this.m_pCanvasContext.font="30px Arial",this.m_pCanvasContext.fillText(t,i.x+20,i.y-30),this.m_pCanvasContext.beginPath(),this.m_pCanvasContext.arc(i.x,i.y,6,0,360,!1),this.m_pCanvasContext.fillStyle="#00bbfa",this.m_pCanvasContext.fill(),this.m_pCanvasContext.closePath(),this.m_pCanvasContext.beginPath(),this.m_pCanvasContext.moveTo(i.x,i.y),this.m_pCanvasContext.lineTo(i.x+20,i.y-20),this.m_pCanvasContext.lineTo(i.x+20+n,i.y-20),this.m_pCanvasContext.lineWidth=2,this.m_pCanvasContext.strokeStyle="#00bbfa",this.m_pCanvasContext.stroke(),this.m_pCanvasContext.closePath()}}},{key:"FillArrows",value:function(t,e){var n=.02*this.m_pCameraCtrl.m_nDistance,i=1.5,a=new Vector3(0,t.y,0),o=new Vector3(0,t.y,0),s=new Vector3(0,t.y,0),r=new Vector3(0,t.y,0),m=new Vector3(0,t.y,0),l=new Vector3(0,t.y,0),h=new Vector3(0,t.y,0);if(t.x-e.x==0)t.z>e.z?(s.x=t.x,s.z=t.z-n,r.x=t.x,r.z=t.z-n*i,h.x=t.x,h.z=t.z-n-n*i):(s.x=t.x,s.z=t.z+n,r.x=t.x,r.z=t.z+n*i,h.x=t.x,h.z=t.z+n+n*i);else if(t.z-e.z==0)t.x>e.x?(s.x=t.x-n,s.z=t.z,r.x=t.x-n*i,r.z=t.z,h.x=t.x-n-n*i,h.z=t.z):(s.x=t.x+n,s.z=t.z,r.x=t.x+n*i,r.z=t.z,h.x=t.x+n+n*i,h.z=t.z);else{var _=(t.z-e.z)/(t.x-e.x),u=Math.abs(Math.pow(Math.pow(t.x-e.x,2)+Math.pow(t.z-e.z,2),.5)),c=n,p=c/u*Math.abs(t.x-e.x),d=c/u*Math.abs(t.z-e.z);t.z>e.z?_>0?(s.x=t.x-p,s.z=t.z-d,r.x=t.x-p*i,r.z=t.z-d*i,h.x=t.x-p-p*i,h.z=t.z-d-d*i):(s.x=t.x+p,s.z=t.z-d,r.x=t.x+p*i,r.z=t.z-d*i,h.x=t.x+p+p*i,h.z=t.z-d-d*i):_>0?(s.x=t.x+p,s.z=t.z+d,r.x=t.x+p*i,r.z=t.z+d*i,h.x=t.x+p+p*i,h.z=t.z+d+d*i):(s.x=t.x-p,s.z=t.z+d,r.x=t.x-p*i,r.z=t.z+d*i,h.x=t.x-p-p*i,h.z=t.z+d+d*i)}a.x=(s.x-t.x)*Math.cos(2*Math.PI/360*45)-(s.z-t.z)*Math.sin(2*Math.PI/360*45)+t.x,a.z=(s.x-t.x)*Math.sin(2*Math.PI/360*45)+(s.z-t.z)*Math.cos(2*Math.PI/360*45)+t.z,o.x=(s.x-t.x)*Math.cos(-2*Math.PI/360*45)-(s.z-t.z)*Math.sin(-2*Math.PI/360*45)+t.x,o.z=(s.x-t.x)*Math.sin(-2*Math.PI/360*45)+(s.z-t.z)*Math.cos(-2*Math.PI/360*45)+t.z,m.x=(h.x-r.x)*Math.cos(2*Math.PI/360*45)-(h.z-r.z)*Math.sin(2*Math.PI/360*45)+r.x,m.z=(h.x-r.x)*Math.sin(2*Math.PI/360*45)+(h.z-r.z)*Math.cos(2*Math.PI/360*45)+r.z,l.x=(h.x-r.x)*Math.cos(-2*Math.PI/360*45)-(h.z-r.z)*Math.sin(-2*Math.PI/360*45)+r.x,l.z=(h.x-r.x)*Math.sin(-2*Math.PI/360*45)+(h.z-r.z)*Math.cos(-2*Math.PI/360*45)+r.z;var y=this.m_pCameraCtrl.WorldToScenePos(t),C=this.m_pCameraCtrl.WorldToScenePos(a),v=this.m_pCameraCtrl.WorldToScenePos(o),f=this.m_pCameraCtrl.WorldToScenePos(r),g=this.m_pCameraCtrl.WorldToScenePos(m),T=this.m_pCameraCtrl.WorldToScenePos(l);this.m_pCameraCtrl.WorldToScenePos(s);this.m_pCanvasContext.beginPath(),this.m_pCanvasContext.moveTo(y.x,y.y),this.m_pCanvasContext.lineTo(C.x,C.y),this.m_pCanvasContext.lineTo(g.x,g.y),this.m_pCanvasContext.lineTo(f.x,f.y),this.m_pCanvasContext.lineTo(T.x,T.y),this.m_pCanvasContext.lineTo(v.x,v.y),this.m_pCanvasContext.closePath(),this.m_pCanvasContext.fillStyle="#ffffff",this.m_pCanvasContext.fill()}},{key:"TouchNavPoint",value:function(){if(null!=this.pTouchNavPoint){var t=this.m_pCameraCtrl.WorldToScenePos(this.pTouchNavPoint);this.m_pCanvasContext.beginPath(),this.m_pCanvasContext.moveTo(t.x,t.y),this.m_pCanvasContext.lineTo(t.x-25,t.y-60),this.m_pCanvasContext.lineTo(t.x,t.y-40),this.m_pCanvasContext.lineTo(t.x+25,t.y-60),this.m_pCanvasContext.closePath(),this.m_pCanvasContext.fillStyle="#53a3d8",this.m_pCanvasContext.fill()}}},{key:"CurPosUpdata",value:function(){if(null!=this.m_pBluePos&&MiaokitDC.DC.m_nCurWork==this.m_nBlueWorkID&&EyejiaDC.DC.m_pLayerMgr.m_pActiveLayer.m_nIndex==this.m_nBlueLayerID){var t=this.m_pCameraCtrl.WorldToScenePos(this.m_pBluePos);this.m_pCanvasContext.strokeStyle="black",this.m_pCanvasContext.lineWidth=1,this.m_pCanvasContext.beginPath(),this.m_pCanvasContext.arc(t.x,t.y,30,0,2*Math.PI,!0),this.m_pCanvasContext.closePath(),this.m_pCanvasContext.fillStyle="red",this.m_pCanvasContext.fill(),this.m_pCanvasContext.stroke()}}},{key:"camera",set:function(t){this.m_pCamera=t}},{key:"project",get:function(){return this.m_pProject}},{key:"domElement",get:function(){return this.m_pRenderer.domElement}}]),t}();Engine.g_pInstance=null;var CameraCtrl=function(){function t(){_classCallCheck(this,t),this.m_pCamera=null,this.m_pPerspective=null,this.m_pOrthographic=null,this.m_bEnabled=!1,this.m_eViewMode=0,this.m_mTarget=new THREE.Vector3(0,0,0),this.m_nForwardMove=20,this.m_nForwardMoved=20,this.m_nRightMove=0,this.m_nRightMoved=0,this.m_nUpMove=0,this.m_nUpMoved=0,this.m_nVRotate=45,this.m_nVRotated=40,this.m_nHRotate=30,this.m_nHRotated=30,this.m_nOrthoScale=10,this.m_nOrthoScaled=10,this.m_mOVMove=new THREE.Vector2(0,0),this.m_mOVMoved=new THREE.Vector2(0,0),this.m_nMinDis=2,this.m_nMaxDis=512,this.m_nMinVRotate=5,this.m_nMaxVRotate=85,this.m_nVRSensit=20,this.m_nHRSensit=20,this.m_nFTSensit=70,this.m_nRTSensit=1,this.m_nUTSensit=1,this.m_nOVScaleSensit=20,this.m_nOVMoveSensit=10,this.m_nMinOVSize=2,this.m_nMaxOVSize=256}return _createClass(t,[{key:"Init",value:function(){this.m_pPerspective=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,.3,1e3),this.m_pOrthographic=new THREE.OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,.3,1e3),this.m_pCamera=this.m_pPerspective,this.m_eViewMode=2,this.m_pCamera.position.set(0,0,0),this.m_pCamera.quaternion.setFromAxisAngle(new THREE.Vector3(0,1,0),0),this.m_pCamera.translateZ(this.m_nForwardMoved),this.m_pCamera.translateZ(-this.m_nForwardMoved),this.m_pCamera.rotateOnAxis(new THREE.Vector3(1,0,0),THREE.Math.degToRad(-this.m_nVRotated)),this.m_pCamera.updateMatrixWorld(!0),this.m_pCamera.rotateOnAxis(this.m_pCamera.worldToLocal(new THREE.Vector3(0,1,0,0)).normalize(),THREE.Math.degToRad(-this.m_nHRotated)),this.m_pCamera.translateZ(this.m_nForwardMoved),this.m_bEnabled=!0}},{key:"SwitchMode",value:function(){this.m_eViewMode=1,1==this.m_eViewMode||2==this.m_eViewMode&&(this.m_pCamera=this.m_pPerspective,this.m_mTarget=new THREE.Vector3(this.m_mOVMoved.x,0,this.m_mOVMoved.y),this.m_pCamera.position=this.m_mTarget.Clone(),this.m_pCamera.rotation=new THREE.Quaternion,this.m_nForwardMove=this.m_nMinDis+(this.m_nOrthoScaled-this.m_nMinOVSize)/(this.m_nMaxOVSize-this.m_nMinOVSize)*(this.m_nMaxDis-this.m_nMinDis),this.m_nForwardMoved=this.m_nForwardMove-2.5,this.m_nRightMove=0,this.m_nRightMoved=0,this.m_nUpMove=0,this.m_nUpMoved=0,this.m_nVRotate=45,this.m_nVRotated=40,this.m_nHRotate=30,this.m_nHRotated=30,this.m_nMinVRotate=5,this.m_pCamera.translateZ(this.m_nForwardMoved),this.m_pCamera.translateZ(-this.m_nForwardMoved),this.m_pCamera.rotateOnAxis(new THREE.Vector3(1,0,0),THREE.Math.degToRad(-this.m_nVRotated)),this.m_pCamera.updateMatrixWorld(!0),this.m_pCamera.rotateOnAxis(this.m_pCamera.worldToLocal(new THREE.Vector3(0,1,0,0)).normalize(),THREE.Math.degToRad(-this.m_nHRotated)),this.m_pCamera.translateZ(this.m_nForwardMoved))}},{key:"Update",value:function(){this.UpdateTransform()}},{key:"UpdateTransform",value:function(){if(1==this.m_eViewMode)this.m_nOrthoScaled=THREE.Math.lerp(this.m_nOrthoScaled,this.m_nOrthoScale,.1),this.m_mOVMoved=THREE.Vector2.lerpVectors(this.m_mOVMoved,this.m_mOVMove,.1),this.m_pCamera.setLens(this.m_nOrthoScaled),this.m_pCamera.position=new THREE.Vector3(this.m_mOVMoved.x,128,this.m_mOVMoved.y);else if(2==this.m_eViewMode){var t=.1*(this.m_nVRotate-this.m_nVRotated),e=.1*(this.m_nHRotate-this.m_nHRotated);(t>.01||t<-.01)&&(this.m_nVRotated+=t,this.m_pCamera.translateZ(-this.m_nForwardMoved),this.m_pCamera.rotateOnAxis(new THREE.Vector3(1,0,0),THREE.Math.degToRad(-t)),this.m_pCamera.translateZ(this.m_nForwardMoved)),(e>.01||e<-.01)&&(this.m_nHRotated+=e,this.m_pCamera.translateZ(-this.m_nForwardMoved),this.m_pCamera.updateMatrixWorld(!0),this.m_pCamera.rotateOnAxis(this.m_pCamera.worldToLocal(new THREE.Vector4(0,1,0,0)).normalize(),THREE.Math.degToRad(-e)),this.m_pCamera.translateZ(this.m_nForwardMoved));var n=.1*(this.m_nForwardMove-this.m_nForwardMoved);(n>.01||n<-.01)&&(this.m_nForwardMoved+=n,this.m_pCamera.translateZ(-n));var i=.1*(this.m_nRightMove-this.m_nRightMoved);(i>.01||i<-.01)&&(this.m_nRightMoved+=i,this.m_pCamera.translateX(-i));var a=.1*(this.m_nUpMove-this.m_nUpMoved);(a>.01||a<-.01)&&(this.m_nUpMoved+=a,this.m_pCamera.translateY(-a)),.5-this.m_pCamera.position.y>0&&(this.m_pCamera.position.y=.5)}}},{key:"DoPinch",value:function(t){var e=t;if(this.m_bEnabled)if(1==this.m_eViewMode);else if(2==this.m_eViewMode){var n=THREE.Math.clamp((this.m_nMaxDis-this.m_nMinDis)/(this.m_nForwardMoved-this.m_nMinDis),.1,1)*this.m_nFTSensit;this.m_nForwardMove-=e*n,this.m_nForwardMove=THREE.Math.clamp(this.m_nForwardMove,this.m_nMinDis,this.m_nMaxDis)}}},{key:"DoDrag",value:function(t){var e=t.eButton,n=t.mDelta;this.m_bEnabled&&(1==this.m_eViewMode||2==this.m_eViewMode&&(0==e?(this.m_nVRotate-=n.y*this.m_nVRSensit,this.m_nHRotate+=n.x*this.m_nHRSensit,this.m_nVRotate=this.m_nVRotate%360,this.m_nVRotate=THREE.Math.clamp(this.m_nVRotate,this.m_nMinVRotate,this.m_nMaxVRotate)):1==e&&(this.m_nRightMove+=n.x*this.m_nRTSensit,this.m_nUpMove+=n.y*this.m_nUTSensit)))}}]),t}(),CameraCtrl2=function(){function t(e){_classCallCheck(this,t),this.m_pCamera=null,this.m_nHalfWidth=0,this.m_nHalfHeight=0,this.m_nRotateH=0,this.m_nRotateV=0,this.m_nRotatedH=0,this.m_nRotatedV=0,this.m_pCamera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,1e3),this.m_pCamera.position.z=30,this.m_nHalfWidth=window.innerWidth/2,this.m_nHalfHeight=window.innerHeight/2;var n=this;e.addEventListener("touchstart",function(t){if(t.touches.length>0){t.preventDefault();var e=t.touches[0];n.m_nRotateH=(e.pageX-n.m_nHalfWidth)/n.m_nHalfWidth*30,n.m_nRotateV=(e.pageY-n.m_nHalfHeight)/n.m_nHalfHeight*30}},!1),e.addEventListener("touchmove",function(t){if(t.touches.length>0){t.preventDefault();var e=t.touches[0];n.m_nRotateH=(e.pageX-n.m_nHalfWidth)/n.m_nHalfWidth*30,n.m_nRotateV=(e.pageY-n.m_nHalfHeight)/n.m_nHalfHeight*30}},!1),e.addEventListener("touchend",function(t){t.preventDefault(),n.m_nRotateH=0,n.m_nRotateV=0},!1)}return _createClass(t,[{key:"Update",value:function(){this.m_nRotatedH+=.12*(-this.m_nRotateH-this.m_nRotatedH),this.m_nRotatedV+=.12*(this.m_nRotateV+60-this.m_nRotatedV),this.m_pCamera.position.set(0,0,0),this.m_pCamera.rotation.set(0,0,0),this.m_pCamera.rotateOnAxis(new THREE.Vector3(1,0,0),THREE.Math.degToRad(-this.m_nRotatedV)),this.m_pCamera.updateMatrixWorld(!0),this.m_pCamera.rotateOnAxis(this.m_pCamera.worldToLocal(new THREE.Vector3(0,1,0)).normalize(),THREE.Math.degToRad(this.m_nRotatedH)),this.m_pCamera.translateZ(30),this.m_pCamera.updateProjectionMatrix()}}]),t}(),CameraCtrl3=function(){function t(e){_classCallCheck(this,t),this.mCameraState=null,this.mPerspectPos=new Vector3(0,0,0),this.nRotateH=0,this.nRotateV=0,this.nForwardMoved=0,this.mOrthoPos=new Vector3(0,0,0),this.nOrthoScaled=0,this.nZRotated=0,this.m_pCamera=null,this.m_pCameraP=null,this.m_pCameraO=null,this.m_nHalfWidth=0,this.m_nHalfHeight=0,this.m_nRotateH=0,this.m_nRotateV=0,this.m_nRotatedH=0,this.m_nRotatedV=0,this.m_nZoom=0,this.m_nZoomd=0,this.m_nDistance=180,this.m_nDistanceMin=5,this.m_nDistanceMax=800,this.m_nHalfWidth=window.innerWidth/2,this.m_nHalfHeight=window.innerHeight/2,this.m_nMove=new THREE.Vector2(0,0),this.m_nMoved=new THREE.Vector2(0,0),this.m_pCameraP=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),this.m_pCameraP.updateMatrixWorld(!0),this.m_pCameraP.updateProjectionMatrix(),this.m_pTaget=new THREE.Object3D,this.m_pCameraO=new THREE.OrthographicCamera(-this.m_nHalfWidth/50,this.m_nHalfWidth/50,this.m_nHalfHeight/50,-this.m_nHalfHeight/50,.1,1e3),this.m_pCameraO.rotation.set(THREE.Math.degToRad(-90),0,0),this.SwitchMode(1);var n=this,i=void 0,a=void 0,o=void 0,s=void 0,r=void 0,m=void 0,l=void 0,h=void 0;e.addEventListener("touchstart",function(t){if(1==t.touches.length){var e=new Date;l=e.getTime(),h=t.touches[0]}if(t.touches.length>0){if(t.preventDefault(),1==t.touches.length){o=!1,r=new THREE.Vector2(0,0);var _=t.touches[0];switch(n.m_eViewMode){case 0:i=new THREE.Vector2(_.pageX,_.pageY),n.m_nMove=new THREE.Vector2(0,0),n.m_nMoved=new THREE.Vector2(0,0);break;case 1:i=new THREE.Vector2(_.pageX,_.pageY),m=i}}if(2==t.touches.length){o=!0,i=new THREE.Vector2((t.touches[0].pageX+t.touches[1].pageX)/2,(t.touches[0].pageY+t.touches[1].pageY)/2),s=i,n.m_nMove=new THREE.Vector2(0,0),n.m_nMoved=new THREE.Vector2(0,0);var u=new THREE.Vector2(t.touches[0].pageX,t.touches[0].pageY),c=new THREE.Vector2(t.touches[1].pageX,t.touches[1].pageY);a=u.distanceTo(c)}}},!1),e.addEventListener("touchmove",function(t){if(1==t.touches.length){t.preventDefault();var e=t.touches[0];switch(n.m_eViewMode){case 0:o&&(r=new THREE.Vector2(e.pageX-s.x,e.pageY-s.y),o=!1),n.m_nMove=new THREE.Vector2(e.pageX-i.x-r.x,e.pageY-i.y-r.y);break;case 1:o||(n.nRotateH=.6*(e.pageX-m.x),n.nRotateV=.6*(e.pageY-m.y),m=new THREE.Vector2(e.pageX,e.pageY))}}if(2==t.touches.length){n.nRotateH=0,n.nRotateV=0,t.preventDefault();var l=new THREE.Vector2((t.touches[0].pageX+t.touches[1].pageX)/2,(t.touches[0].pageY+t.touches[1].pageY)/2);s=l,n.m_nMove=new THREE.Vector2(l.x-i.x,l.y-i.y);var h=new THREE.Vector2(t.touches[0].pageX,t.touches[0].pageY),_=new THREE.Vector2(t.touches[1].pageX,t.touches[1].pageY),u=h.distanceTo(_);n.m_nZoom=a-u}Engine.g_pInstance.m_pChickTouchMove()},!1),e.addEventListener("touchend",function(t){(t.preventDefault(),0==t.touches.length)&&((new Date).getTime()-l<250&&(console.log("单击"),n.ray(h)));n.nRotateH=0,n.nRotateV=0,n.m_nZoomd=0,n.m_nZoom=0},!1)}return _createClass(t,[{key:"Update",value:function(){switch(this.m_eViewMode){case 0:this.m_nMoved.x+=.12*(this.m_nMove.x-this.m_nMoved.x),this.m_nMoved.y+=.12*(this.m_nMove.y-this.m_nMoved.y);var t=new THREE.Vector2(this.m_nMoved.x-this.m_nMove.x,this.m_nMoved.y-this.m_nMove.y);this.m_pTaget.translateOnAxis(this.m_pTaget.worldToLocal(new THREE.Vector3(1,0,0)),t.x/200*this.m_nDistance*.1),this.m_pTaget.translateOnAxis(this.m_pTaget.worldToLocal(new THREE.Vector3(0,0,1)),t.y/200*this.m_nDistance*.1),this.m_pCameraO.position.set(this.m_pTaget.position.x,200,this.m_pTaget.position.z),this.m_nZoomd+=.12*(this.m_nZoom-this.m_nZoomd),this.m_nDistance+=.01*(this.m_nZoom-this.m_nZoomd)*this.m_nDistance*.1,this.m_nDistance=Math.abs(this.m_nDistance),this.m_nDistance<=this.m_nDistanceMin&&(this.m_nDistance=this.m_nDistanceMin),this.m_nDistance>=this.m_nDistanceMax&&(this.m_nDistance=this.m_nDistanceMax),this.m_pCameraO.left=-this.m_nHalfWidth/50*this.m_nDistance*.13,this.m_pCameraO.right=this.m_nHalfWidth/50*this.m_nDistance*.13,this.m_pCameraO.top=this.m_nHalfHeight/50*this.m_nDistance*.13,this.m_pCameraO.bottom=-this.m_nHalfHeight/50*this.m_nDistance*.13,this.m_pCameraO.updateMatrixWorld(!0),this.m_pCameraO.updateProjectionMatrix();break;case 1:this.m_nRotateH-=this.nRotateH,this.m_nRotateV+=this.nRotateV,this.m_nRotateV>=80&&(this.m_nRotateV=80),this.m_nRotateV<=0&&(this.m_nRotateV=0),this.m_nRotatedH+=.12*(this.m_nRotateH-this.m_nRotatedH),this.m_nRotatedV+=.1*(this.m_nRotateV-this.m_nRotatedV),this.m_pCameraP.rotation.set(0,0,0),this.m_pCameraP.position.set(0,0,0),this.m_pCameraP.rotateOnAxis(new THREE.Vector3(1,0,0),THREE.Math.degToRad(-this.m_nRotatedV)),this.m_pCameraP.updateMatrixWorld(!0),this.m_pCameraP.rotateOnAxis(this.m_pCameraP.worldToLocal(new THREE.Vector3(0,1,0)),THREE.Math.degToRad(this.m_nRotatedH)),this.m_pCameraP.updateMatrixWorld(!0),this.m_pCameraP.position.set(this.m_pTaget.position.x+this.m_pCameraP.position.x,this.m_pTaget.position.y+this.m_pCameraP.position.y,this.m_pTaget.position.z+this.m_pCameraP.position.z),this.m_pCameraP.updateMatrixWorld(!0),this.m_pTaget.rotation.set(0,0,0),this.m_pTaget.rotateOnAxis(this.m_pTaget.worldToLocal(new THREE.Vector3(0,1,0)),THREE.Math.degToRad(this.m_nRotatedH)),this.m_nMoved.x+=.12*(this.m_nMove.x-this.m_nMoved.x),this.m_nMoved.y+=.12*(this.m_nMove.y-this.m_nMoved.y);var e=new THREE.Vector2(this.m_nMoved.x-this.m_nMove.x,this.m_nMoved.y-this.m_nMove.y);this.m_pTaget.translateOnAxis(this.m_pTaget.worldToLocal(new THREE.Vector3(1,0,0)),.01*e.x*this.m_nDistance*.1),this.m_pTaget.translateOnAxis(this.m_pTaget.worldToLocal(new THREE.Vector3(0,0,1)),.01*e.y*this.m_nDistance*.1),this.m_nZoomd+=.12*(this.m_nZoom-this.m_nZoomd),this.m_nDistance+=.01*(this.m_nZoom-this.m_nZoomd)*this.m_nDistance*.1,this.m_nDistance=Math.abs(this.m_nDistance),this.m_nDistance<=this.m_nDistanceMin&&(this.m_nDistance=this.m_nDistanceMin),this.m_nDistance>=this.m_nDistanceMax&&(this.m_nDistance=this.m_nDistanceMax),this.m_pCameraP.translateZ(this.m_nDistance),this.m_pCameraP.updateMatrixWorld(!0),this.m_pCameraP.updateProjectionMatrix()}}},{key:"Reset",value:function(){null==this.mCameraState?console.error("this.mCameraState == null"):this.SetViewState(this.mCameraState)}},{key:"ResetViwe",value:function(){switch(this.m_eViewMode){case 0:this.m_pTaget.position.set(this.mOrthoPos.x,this.m_pTaget.position.y,this.mOrthoPos.z),this.m_pTaget.rotation.set(0,0,0),this.m_pTaget.rotateOnAxis(this.m_pTaget.worldToLocal(new THREE.Vector3(0,1,0)),THREE.Math.degToRad(this.nZRotated)),this.m_nDistance=this.nOrthoScaled,this.m_pCameraO.rotation.set(THREE.Math.degToRad(-90),0,THREE.Math.degToRad(this.nZRotated));break;case 1:this.m_pTaget.position.set(this.mPerspectPos.x,this.m_pTaget.position.y,this.mPerspectPos.z),this.m_nDistance=this.nForwardMoved}}},{key:"Tracking",value:function(t){this.m_pTaget.position.set(t.x,this.m_pTaget.position.y,-t.z)}},{key:"SwitchMode",value:function(t){switch(this.m_eViewMode=t,t){case 0:this.m_pCamera=this.m_pCameraO;break;case 1:this.m_pCamera=this.m_pCameraP}this.ResetViwe()}},{key:"SetViewState",value:function(t){this.mCameraState=t,this.mPerspectPos.z=t.m_mPerspectPos.z,this.mPerspectPos.x=t.m_mPerspectPos.x,this.m_nRotateV=t.m_nVRotated,0==this.m_nRotateV&&(this.m_nRotateV=60),this.m_nRotateH=t.m_nHRotated,this.nForwardMoved=1.4*t.m_nForwardMoved,0==this.nForwardMoved&&(this.nForwardMoved=50),Math.abs(this.m_nRotatedH-this.m_nRotateH)>60&&(this.m_nRotatedH=this.m_nRotateH-10),this.mOrthoPos.z=t.m_mOrthoPos.z,this.mOrthoPos.x=t.m_mOrthoPos.x,this.nOrthoScaled=2*t.m_nOrthoScaled,0==this.nOrthoScaled&&(this.nOrthoScaled=50),this.nZRotated=t.m_nZRotated,this.ResetViwe()}},{key:"WorldToScenePos",value:function(t){var e=.5*Engine.g_pInstance.m_pTextCanvas.width,n=.5*Engine.g_pInstance.m_pTextCanvas.height,i=new THREE.Vector3(t.x,t.y,-t.z);i.project(this.m_pCamera);return i.z,{x:Math.round(i.x*e+e),y:Math.round(-i.y*n+n),z:i.z}}},{key:"ray",value:function(t){var e=t.pageX/Engine.g_pInstance.m_nCavasScale.x,n=t.pageY/Engine.g_pInstance.m_nCavasScale.y;if(0==this.m_eViewMode){var i=e/Engine.g_pInstance.m_pTextCanvas.width*2-1,a=-n/Engine.g_pInstance.m_pTextCanvas.height*2+1,o=Math.abs(this.m_pCameraO.left),s=Math.abs(this.m_pCameraO.bottom),r=this.m_pCameraO.position,m=new Vector3(i*o+r.x,0,a*s-r.z);Engine.g_pInstance.project.SetPos(new Vector3(m.x,0,m.z),t)}else{var l=e/Engine.g_pInstance.m_pTextCanvas.width*2-1,h=-n/Engine.g_pInstance.m_pTextCanvas.height*2+1,_=new THREE.Vector3(l,h,.5).unproject(this.m_pCamera);_.z=-_.z;new THREE.Vector3;var u=(0-_.y)/(this.m_pCamera.position.y-_.y),c=(this.m_pCamera.position.x-_.x)*u+_.x,p=(-this.m_pCamera.position.z-_.z)*u+_.z;Engine.g_pInstance.project.SetPos(new Vector3(c,0,p),t)}}}]),t}(),TextBtn=function(){function t(){_classCallCheck(this,t),this.Btn=document.createElement("input"),this.Btn.type="button",this.Btn.onclick=this.OnClick,this.Btn.style.height=35*Engine.g_pInstance.m_nCavasScale.y+"px",this.Btn.style.position="absolute",this.Btn.style.background="rgba(255, 255, 255, 1)",this.Btn.style.border="0",this.Btn.style.visibility="visible",this.Btn.style.zIndex="2",t.Parent.appendChild(this.Btn),t.TextBtnArr.push(this)}return _createClass(t,[{key:"OnClick",value:function(){console.log(this.m_pData.m_pName)}},{key:"SetData",value:function(t){this.m_pData=t,this.Btn.value=this.m_pData.m_pName,this.m_pPosition=this.m_pData.m_mPoint.Object.m_mPosition}},{key:"UpdatePos",value:function(){var t=Engine.g_pInstance.m_pCameraCtrl.WorldToScenePos(this.m_pPosition);this.Btn.style.left=t.x*Engine.g_pInstance.m_nCavasScale.x+"px",this.Btn.style.top=t.y*Engine.g_pInstance.m_nCavasScale.y+"px"}}],[{key:"Init",value:function(e){t.Parent=e}},{key:"UpdateData",value:function(e){for(var n=(null==e?0:e.Count)-t.TextBtnArr.length,i=0;i<n;i++)new t}}]),t}();TextBtn.TextBtnArr=[];var BindAttriType,Project=function(){function t(){_classCallCheck(this,t),this.m_aWorkData=null,this.m_pNPaths=[],this.m_nMotion=0,this.m_nSample=.1,this.m_nSampleFactor=1,this.m_nSampleLength=0,this.m_nNpointIndex=0,this.m_bWaitVoice=!1,this.m_pVoiceEnd=!0,this.m_bWaitTime=!1,this.m_nVoiceSpeed=400,this.m_bRealTimeNavi=!1,this.m_nRealTimeTab=0,this.m_bAutoMotion=!1,this.m_pBluePos=null,MiaokitDC.DC=new MiaokitDC,MiaokitDC.DC.DescriptorFactory=this.DescriptorFactory,MiaokitDC.DC.GroupFactory=this.GroupFactory,MiaokitDC.DC.CollectionFactory=this.CollectionFactory,MiaokitDC.DC.ComponentFactory=this.ComponentFactory}return _createClass(t,[{key:"version",value:function(){return 1e3}},{key:"InitProject",value:function(t,e){var n=this;MiaokitDC.DC.m_pAssetsLoader.LoadProject(t,function(t){if(null!=t){var i=new BinaryReader(t);n.m_aWorkData=new Array(256),n.UnSerialize(i),MiaokitDC.DC.InitWorks(n.m_aWorkData,function(t){MiaokitDC.DC.SwitchWork(0),MiaokitDC.DC.ActiveLayer(0),MiaokitDC.DC.m_pAssetsLoader.Load(),e(t)})}else e("Project.InitProject(): pBuffer != null.")})}},{key:"Start",value:function(){}},{key:"Stop",value:function(){}},{key:"Update",value:function(){MiaokitDC.DC.Update(),this.VoiceNavi(),this.RealTimeVoiceNavi()}},{key:"Destroy",value:function(){console.info("Project.Destroy():...")}},{key:"ActiveLayer",value:function(t){console.log("切换楼层-------弃用的方法")}},{key:"DescriptorFactory",value:function(t){var e=null;switch(t){case CollectionType.ATexture:e=new ATextureDesc;break;case CollectionType.AHoleModel:e=new AHoleModelDesc;break;case CollectionType.EFurnitureModel:e=new EFurnitureModelDesc;break;default:alert("Project.DescriptorFactory(): !eType, "+t)}return e}},{key:"GroupFactory",value:function(t){return new ECollectionGroup(t)}},{key:"CollectionFactory",value:function(t,e){var n=null;switch(t){case CollectionType.ATexture:n=new ATexture(e);break;case CollectionType.AHoleModel:n=new AHoleModel(e);break;case CollectionType.EFurnitureModel:n=new EFurnitureModel(e);break;case CollectionType.EBuildingModel:n=new EBuildingModel(e);break;default:alert("Project.CollectionFactory(): !eType, "+t)}return n}},{key:"ComponentFactory",value:function(t){switch(t){case ComponentType.Panel:case ComponentType.Edge:case ComponentType.AreaBottom:case ComponentType.AreaTop:default:alert("Project.ComponentFactory(): !eType, "+t)}return null}},{key:"UnSerialize",value:function(t){for(var e=t.ReadUInt32(),n=t.ReadInt32();n>-1;){var i=t.ReadInt32();this.m_aWorkData[n]=t.ReadBytes(i),19890430!=t.ReadInt32()&&alert("Project.UnSerialize(): nDataEnd != 19890430."),n=t.ReadInt32()}if(e>1e3)t.ReadInt32();else;501347081!=t.ReadInt32()&&alert("Project.UnSerialize(): Bad end!")}},{key:"GetFloorCount",value:function(){return MiaokitDC.DC.GetWork(MiaokitDC.DC.m_nCurWork).m_pALinerDC.m_pLayerMgr.GetLayersLenth()}},{key:"ActiveFloor",value:function(t){Engine.g_pInstance.pTouchNavPoint=null,MiaokitDC.DC.ActiveLayer(t),Engine.g_pInstance.m_pChooseLayer(t);var e=new NavBackData(MiaokitDC.DC.m_nCurWork,MiaokitDC.DC.GetWork(MiaokitDC.DC.m_nCurWork).m_pID,t);console.log("Active:"+e.PId),Engine.g_pInstance.m_pShowActiveLayer(e);var n=MiaokitDC.DC.GetWork(MiaokitDC.DC.m_nCurWork).m_pEyejiaDC.m_pLayerMgr.GetLayer(t).m_pViewState;null!=n&&Engine.g_pInstance.SetViewState(n)}},{key:"SwitchViewMode",value:function(t){switch(MiaokitDC.DC.viewMode){case ViewMode.Invalid:MiaokitDC.DC.viewMode=ViewMode.View2D;break;case ViewMode.View2D:MiaokitDC.DC.viewMode=ViewMode.View3D;break;case ViewMode.View3D:MiaokitDC.DC.viewMode=ViewMode.View2D}}},{key:"Navigate",value:function(t,e,n){if(console.log("起点编号",t,"终点编号",e,"优先通道类型",n),Engine.g_pInstance.pTouchNavPoint=null,this.m_pNPaths=MiaokitDC.DC.m_pNavigator.FindPath(t,e,0),null!=this.m_pNPaths){if(0==this.m_pNPaths.length)return console.log("找不到路线"),void Engine.g_pInstance.m_pNoFindPath();for(var i=0;i<this.m_pNPaths.length;)console.log("线路起点",this.m_pNPaths[i].m_pStartPoint.m_mLandmark.Object.m_pName,"线路终点",this.m_pNPaths[i].m_pEndPoint.m_mLandmark.Object.m_pName),this.m_pNPaths[i].m_aPath.length<=1&&(this.m_pNPaths.splice(i,1),i--),i++;console.log("线路数量",this.m_pNPaths.length),this.SwitchViewMode(0),this.NavigateEnd()}else this.m_pNPaths=[],console.log("找不到路线"),Engine.g_pInstance.m_pNoFindPath();Engine.g_pInstance.pPath=this.m_pNPaths}},{key:"NavigateEnd",value:function(){for(var t=[],e=0;e<this.m_pNPaths.length;e++)this.m_pNPaths[e].m_aPath.length>1&&t.push(new NavBackData(this.m_pNPaths[e].m_nWork,MiaokitDC.DC.GetWork(this.m_pNPaths[e].m_nWork).m_pID,this.m_pNPaths[e].m_nLayer));Engine.g_pInstance.m_pNavBack(t),this.SwitchWorkForIndex(t[0].HousId),this.ActiveFloor(0),this.m_bAutoMotion=!0,this.m_nMotion=0}},{key:"NavBack",value:function(t){console.log(t.HousId+"回看"+t.LayerId),this.m_bAutoMotion=!1,t.HousId!=MiaokitDC.DC.m_nCurWork&&this.SwitchWorkForIndex(t.HousId),this.ActiveFloor(t.LayerId),this.m_nMotion=0}},{key:"CloseNavBack",value:function(){console.log("退出回放."),this.m_pNPaths=[],Engine.g_pInstance.pPath=[],this.m_bAutoMotion=!1}},{key:"SwitchWork",value:function(t){console.log("场景编辑编号"+t);var e=!0,n=!1,i=void 0;try{for(var a,o=MiaokitDC.DC.m_aWork[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var s=a.value;if(null!=s&&(console.log("遍历场景"+s.m_pID),s.m_pID==t)){console.log("找到对应场景"),s.m_nIndex!=MiaokitDC.DC.m_nCurWork&&MiaokitDC.DC.SwitchWork(s.m_nIndex),this.ActiveFloor(0);var r=MiaokitDC.DC.GetWork(MiaokitDC.DC.m_nCurWork).m_pALinerDC.m_pLayerMgr.GetLayersLenth();console.log("返回当前楼层数："+r+"Work.m_nIndex"+s.m_nIndex),Engine.g_pInstance.m_pLayerUpdate(r,s.m_nIndex),0==s.m_nIndex?(console.log("通知H5是外景"),Engine.g_pInstance.m_pOutWorkBack(!0)):(console.log("通知H5不是外景"),Engine.g_pInstance.m_pOutWorkBack(!1))}}}catch(t){n=!0,i=t}finally{try{!e&&o.return&&o.return()}finally{if(n)throw i}}}},{key:"SwitchWorkForIndex",value:function(t){t!=MiaokitDC.DC.m_nCurWork&&MiaokitDC.DC.SwitchWork(t);var e=MiaokitDC.DC.GetWork(MiaokitDC.DC.m_nCurWork).m_pALinerDC.m_pLayerMgr.GetLayersLenth();console.log("返回当前楼层数："+e+"Work.m_nIndex"+t),Engine.g_pInstance.m_pLayerUpdate(e,t),0==t?(console.log("通知H5是外景"),Engine.g_pInstance.m_pOutWorkBack(!0)):(console.log("通知H5不是外景"),Engine.g_pInstance.m_pOutWorkBack(!1))}},{key:"GoOutWork",value:function(){console.log("切换到外景"),this.SwitchWorkForIndex(0),this.ActiveFloor(0),Engine.g_pInstance.m_pOutWorkBack(!0)}},{key:"Reset",value:function(){Engine.g_pInstance.m_pCameraCtrl.Reset(),Engine.g_pInstance.pTouchNavPoint=null}},{key:"SetPos",value:function(t,e){console.log("点击的世界坐标",t);var n=null,i=NavChartDC.DC.m_pLayerMgr.m_pActiveLayer.m_mLandmarkList,a=ALinerDC.DC.m_pLayerMgr.m_pActiveLayer.m_pLabelList,o=!0,s=!1,r=void 0;try{for(var m,l=a[Symbol.iterator]();!(o=(m=l.next()).done);o=!0){var h=m.value;null!=h.m_pArea&&h.m_pArea.CollideBottom(t)&&(n=h)}}catch(t){s=!0,r=t}finally{try{!o&&l.return&&l.return()}finally{if(s)throw r}}var _=null,u=!0,c=!1,p=void 0;try{for(var d,y=i[Symbol.iterator]();!(u=(d=y.next()).done);u=!0){var C=d.value;if(null==n)break;null!=C.m_pAAreaLabel&&null!=C.m_pName&&n==C.m_pAAreaLabel&&(null==_&&(_=C),_=this.GetNearest(t,_,C))}}catch(t){c=!0,p=t}finally{try{!u&&y.return&&y.return()}finally{if(c)throw p}}null!=_?(Engine.g_pInstance.pTouchNavPoint=t,console.log("找到房间",_.m_pName,_.m_pSerial),Engine.g_pInstance.m_pSetNavPoint(_.m_pSerial,_.m_pName,e)):(console.log("找不到房间"),Engine.g_pInstance.pTouchNavPoint=null)}},{key:"GetNearest",value:function(t,e,n){return Vector3.Distance(t,e.m_mPoint.Object.m_mPosition)<Vector3.Distance(t,n.m_mPoint.Object.m_mPosition)?e:n}},{key:"GetBlueToothList",value:function(){var t=new Array,e=!0,n=!1,i=void 0;try{for(var a,o=MiaokitDC.DC.m_aWork[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var s=a.value;if(null!=s){var r=!0,m=!1,l=void 0;try{for(var h,_=s.m_pEyejiaDC.m_pLayerMgr.m_pLayerList[Symbol.iterator]();!(r=(h=_.next()).done);r=!0){var u=h.value;t=t.concat(u.GetBlueToothStation())}}catch(t){m=!0,l=t}finally{try{!r&&_.return&&_.return()}finally{if(m)throw l}}}}}catch(t){n=!0,i=t}finally{try{!e&&o.return&&o.return()}finally{if(n)throw i}}var c=!0,p=!1,d=void 0;try{for(var y,C=t[Symbol.iterator]();!(c=(y=C.next()).done);c=!0){var v=y.value;console.log(v.m_pMajorid,"蓝牙:",v.m_pPosition.x,v.m_pPosition.y,v.m_pPosition.z)}}catch(t){p=!0,d=t}finally{try{!c&&C.return&&C.return()}finally{if(p)throw d}}return t}},{key:"CurrentPosition",value:function(t,e,n){Engine.g_pInstance.m_nBlueWorkID=t,Engine.g_pInstance.m_nBlueLayerID=e,Engine.g_pInstance.m_pBluePos=new Vector3(n.x,1.5,n.y),this.m_pBluePos=new Vector3(n.x,1.5,n.y),this.TestText("X"+n.x.toFixed(3)+",Y"+n.y.toFixed(3)+",Z"+n.z.toFixed(3))}},{key:"TestText",value:function(t){Engine.g_pInstance.pTestText=t}},{key:"TestText2",value:function(t){var e=[],n=0,i=!0,a=!1,o=void 0;try{for(var s,r=t[Symbol.iterator]();!(i=(s=r.next()).done);i=!0){var m=s.value;e[n]="Rssi:"+m.m_nRssi+"Position:"+m.m_mPosition.x.toFixed(2)+","+m.m_mPosition.y.toFixed(2)+","+m.m_mPosition.z.toFixed(2),n++}}catch(t){a=!0,o=t}finally{try{!i&&r.return&&r.return()}finally{if(a)throw o}}Engine.g_pInstance.pTestTextArr=e}},{key:"VoiceNavi",value:function(){if(!this.m_bRealTimeNavi){var t=EyejiaDC.DC.m_pLayerMgr.m_pActiveLayer.m_nIndex,e=MiaokitDC.DC.m_nCurWork;if(null!=this.m_pNPaths){if(0==this.m_pNPaths.length)return;if(this.m_pNPaths[0].m_nWork==e&&this.m_pNPaths[0].m_nLayer==t){if(1==this.m_pNPaths.length){if(this.m_nMotion<1&&(this.m_nMotion++,this.VoicePost(["从",this.m_pNPaths[0].m_pStartPoint.m_mLandmark.Object.m_pName,"出发"]),Engine.g_pInstance.CamTracking(this.m_pNPaths[0].m_pStartPoint.m_mPosition)),this.m_nMotion<2&&this.m_pVoiceEnd&&this.m_nMotion++,this.m_nMotion>=2)if(this.m_nMotion<3&&(this.m_nMotion++,this.VoicePost(["沿着标识路线行走",this.m_pNPaths[0].m_nDistance.toFixed(0).toString(),"米"]),this.m_nNpointIndex=0,this.m_nSample=this.m_pNPaths[0].m_nDistance/(this.m_nVoiceSpeed*(9+this.m_pNPaths[0].m_nDistance.toFixed(0).length)/1e3)/45,this.m_nSampleFactor=1,this.m_nSampleLength=0,console.log("采样",this.m_nSample)),!this.m_bWaitVoice&&this.m_nMotion<4&&this.m_nMotion++,this.m_nMotion>=5)this.m_nMotion<6&&(this.m_nMotion++,this.VoicePost(["到达目的地",this.m_pNPaths[0].m_pEndPoint.m_mLandmark.Object.m_pName]));else if(4==this.m_nMotion)if(0==this.m_nNpointIndex&&this.m_nNpointIndex++,this.m_nNpointIndex<this.m_pNPaths[0].m_aPath.length){var n=void 0,i=this.m_nSample*this.m_nSampleFactor;for(this.m_nSampleFactor++;this.m_nSampleLength<i;){if(this.m_nNpointIndex++,this.m_nNpointIndex>=this.m_pNPaths[0].m_aPath.length){i=this.m_nSampleLength,Engine.g_pInstance.CamTracking(this.m_pNPaths[0].m_pEndPoint.m_mPosition);break}this.m_nSampleLength+=Vector3.Distance(this.m_pNPaths[0].m_aPath[this.m_nNpointIndex-1],this.m_pNPaths[0].m_aPath[this.m_nNpointIndex])}if(this.m_nNpointIndex<this.m_pNPaths[0].m_aPath.length){var a=Vector3.Distance(this.m_pNPaths[0].m_aPath[this.m_nNpointIndex-1],this.m_pNPaths[0].m_aPath[this.m_nNpointIndex]),o=(a-(this.m_nSampleLength-i))/a;n=Vector3.LerpVectors(this.m_pNPaths[0].m_aPath[this.m_nNpointIndex-1],this.m_pNPaths[0].m_aPath[this.m_nNpointIndex],o),Engine.g_pInstance.CamTracking(n)}}else this.m_pVoiceEnd&&(console.log("第二段语音读完"),this.m_nMotion++)}else if(this.m_nMotion<1&&(this.m_nMotion++,this.VoicePost(["从",this.m_pNPaths[0].m_pStartPoint.m_mLandmark.Object.m_pName,"出发"]),Engine.g_pInstance.CamTracking(this.m_pNPaths[0].m_pStartPoint.m_mPosition)),this.m_nMotion<2&&this.m_pVoiceEnd&&this.m_nMotion++,this.m_nMotion>=2)if(this.m_nMotion<3&&(this.m_nMotion++,this.VoicePost(["沿着标识路线行走",this.m_pNPaths[0].m_nDistance.toFixed(0),"米"]),this.m_nNpointIndex=0,this.m_nSample=this.m_pNPaths[0].m_nDistance/(this.m_nVoiceSpeed*(9+this.m_pNPaths[0].m_nDistance.toFixed(0).length)/1e3)/45,this.m_nSampleFactor=1,this.m_nSampleLength=0,console.log("采样",this.m_nSample)),!this.m_bWaitVoice&&this.m_nMotion<4&&this.m_nMotion++,this.m_nMotion>=5)if(this.m_nMotion<6){switch(this.m_nMotion++,0==this.m_pNPaths[0].m_nWork?this.m_pNPaths[0].m_nWork==this.m_pNPaths[1].m_nWork?this.VoicePost(["从",this.m_pNPaths[0].m_pEndPoint.m_mLandmark.Object.TypeName(),"到达",this.m_pNPaths[1].m_nLayer+1+"楼"]):0!=this.m_pNPaths[1].m_nWork?this.VoicePost(["从",this.m_pNPaths[0].m_pEndPoint.m_mLandmark.Object.TypeName(),"进入",MiaokitDC.DC.GetWork(this.m_pNPaths[1].m_nWork).m_pID+(this.m_pNPaths[1].m_nLayer+1)+"楼"]):this.VoicePost(["从",this.m_pNPaths[0].m_pEndPoint.m_mLandmark.Object.TypeName(),"到达",MiaokitDC.DC.GetWork(this.m_pNPaths[1].m_nWork).m_pID+(this.m_pNPaths[1].m_nLayer+1)+"楼"]):this.m_pNPaths[0].m_nWork==this.m_pNPaths[1].m_nWork?this.VoicePost(["从",this.m_pNPaths[0].m_pEndPoint.m_mLandmark.Object.TypeName(),"到达",this.m_pNPaths[1].m_nLayer+1+"楼"]):0!=this.m_pNPaths[1].m_nWork?this.VoicePost(["从",this.m_pNPaths[0].m_pEndPoint.m_mLandmark.Object.TypeName(),"到达",MiaokitDC.DC.GetWork(this.m_pNPaths[1].m_nWork).m_pID+(this.m_pNPaths[1].m_nLayer+1)+"楼"]):this.VoicePost(["从",this.m_pNPaths[0].m_pEndPoint.m_mLandmark.Object.TypeName(),"出到",MiaokitDC.DC.GetWork(this.m_pNPaths[1].m_nWork).m_pID]),console.log("动画类型:",this.m_pNPaths[0].m_pStartPoint.m_mLandmark.Object.m_nType),this.m_pNPaths[0].m_pStartPoint.m_mLandmark.Object.m_nType){case 0:console.log("无设置动画，默认调用上楼梯"),this.MoveClip(0);break;case 1:this.m_pNPaths[0].m_nLayer<this.m_pNPaths[1].m_nLayer?this.MoveClip(0):this.MoveClip(1);break;case 2:this.m_pNPaths[0].m_nLayer<this.m_pNPaths[1].m_nLayer?this.MoveClip(6):this.MoveClip(7);break;case 3:this.m_pNPaths[0].m_nLayer<this.m_pNPaths[1].m_nLayer?this.MoveClip(4):this.MoveClip(5);break;case 5:this.MoveClip(3);break;case 6:this.MoveClip(2)}this.m_nStarTime=(new Date).getTime()+4e3}else this.m_bAutoMotion&&this.m_pVoiceEnd&&(new Date).getTime()>this.m_nStarTime&&(this.m_pNPaths[1].m_nWork!=MiaokitDC.DC.m_nCurWork&&this.SwitchWorkForIndex(this.m_pNPaths[1].m_nWork),this.ActiveFloor(this.m_pNPaths[1].m_nLayer),this.m_nMotion=0);else if(4==this.m_nMotion)if(0==this.m_nNpointIndex&&this.m_nNpointIndex++,this.m_nNpointIndex<this.m_pNPaths[0].m_aPath.length){var s=void 0,r=this.m_nSample*this.m_nSampleFactor;for(this.m_nSampleFactor++;this.m_nSampleLength<r;){if(this.m_nNpointIndex++,this.m_nNpointIndex>=this.m_pNPaths[0].m_aPath.length){r=this.m_nSampleLength,Engine.g_pInstance.CamTracking(this.m_pNPaths[0].m_pEndPoint.m_mPosition);break}this.m_nSampleLength+=Vector3.Distance(this.m_pNPaths[0].m_aPath[this.m_nNpointIndex-1],this.m_pNPaths[0].m_aPath[this.m_nNpointIndex])}if(this.m_nNpointIndex<this.m_pNPaths[0].m_aPath.length){var m=Vector3.Distance(this.m_pNPaths[0].m_aPath[this.m_nNpointIndex-1],this.m_pNPaths[0].m_aPath[this.m_nNpointIndex]),l=(m-(this.m_nSampleLength-r))/m;s=Vector3.LerpVectors(this.m_pNPaths[0].m_aPath[this.m_nNpointIndex-1],this.m_pNPaths[0].m_aPath[this.m_nNpointIndex],l),Engine.g_pInstance.CamTracking(s)}}else this.m_pVoiceEnd&&this.m_nMotion++}else if(this.m_pNPaths[this.m_pNPaths.length-1].m_nWork==e&&this.m_pNPaths[this.m_pNPaths.length-1].m_nLayer==t){var h=this.m_pNPaths[this.m_pNPaths.length-1];if(this.m_nMotion<1&&(this.m_nMotion++,this.VoicePost(["从",h.m_pStartPoint.m_mLandmark.Object.m_pName,"出发"]),Engine.g_pInstance.CamTracking(h.m_pStartPoint.m_mPosition)),this.m_nMotion<2&&this.m_pVoiceEnd&&this.m_nMotion++,this.m_nMotion>=2)if(this.m_nMotion<3&&(this.m_nMotion++,this.VoicePost(["沿着标识路线行走",h.m_nDistance.toFixed(0),"米"]),this.m_nNpointIndex=0,this.m_nSample=h.m_nDistance/(this.m_nVoiceSpeed*(9+h.m_nDistance.toFixed(0).length)/1e3)/45,this.m_nSampleFactor=1,this.m_nSampleLength=0,console.log("采样",this.m_nSample)),!this.m_bWaitVoice&&this.m_nMotion<4&&this.m_nMotion++,this.m_nMotion>=5)this.m_nMotion<6&&(this.m_nMotion++,this.VoicePost(["到达目的地",h.m_pEndPoint.m_mLandmark.Object.m_pName]));else if(4==this.m_nMotion)if(0==this.m_nNpointIndex&&this.m_nNpointIndex++,this.m_nNpointIndex<h.m_aPath.length){var _=void 0,u=this.m_nSample*this.m_nSampleFactor;for(this.m_nSampleFactor++;this.m_nSampleLength<u;){if(this.m_nNpointIndex++,this.m_nNpointIndex>=h.m_aPath.length){u=this.m_nSampleLength,Engine.g_pInstance.CamTracking(h.m_pEndPoint.m_mPosition);break}this.m_nSampleLength+=Vector3.Distance(h.m_aPath[this.m_nNpointIndex-1],h.m_aPath[this.m_nNpointIndex])}if(this.m_nNpointIndex<h.m_aPath.length){var c=Vector3.Distance(h.m_aPath[this.m_nNpointIndex-1],h.m_aPath[this.m_nNpointIndex]),p=(c-(this.m_nSampleLength-u))/c;_=Vector3.LerpVectors(h.m_aPath[this.m_nNpointIndex-1],h.m_aPath[this.m_nNpointIndex],p),Engine.g_pInstance.CamTracking(_)}}else this.m_pVoiceEnd&&this.m_nMotion++}else{var d=0,y=!0,C=!1,v=void 0;try{for(var f,g=this.m_pNPaths[Symbol.iterator]();!(y=(f=g.next()).done);y=!0){var T=f.value;if(T.m_nWork==e&&T.m_nLayer==t){var k=this.m_pNPaths[d+1];if(this.m_nMotion<1&&(this.m_nMotion++,this.VoicePost(["从",T.m_pStartPoint.m_mLandmark.Object.m_pName,"出发"]),Engine.g_pInstance.CamTracking(T.m_pStartPoint.m_mPosition)),this.m_nMotion<2&&this.m_pVoiceEnd&&this.m_nMotion++,this.m_nMotion>=2)if(this.m_nMotion<3&&(this.m_nMotion++,this.VoicePost(["沿着标识路线行走",T.m_nDistance.toFixed(0),"米"]),this.m_nNpointIndex=0,this.m_nSample=T.m_nDistance/(this.m_nVoiceSpeed*(9+T.m_nDistance.toFixed(0).length)/1e3)/45,this.m_nSampleFactor=1,this.m_nSampleLength=0,console.log("采样",this.m_nSample)),!this.m_bWaitVoice&&this.m_nMotion<4&&this.m_nMotion++,this.m_nMotion>=5)if(this.m_nMotion<6){switch(this.m_nMotion++,0==T.m_nWork?T.m_nWork==k.m_nWork?this.VoicePost(["从",T.m_pEndPoint.m_mLandmark.Object.TypeName(),"到达",k.m_nLayer+1+"楼"]):0!=k.m_nWork?this.VoicePost(["从",T.m_pEndPoint.m_mLandmark.Object.TypeName(),"进入",MiaokitDC.DC.GetWork(k.m_nWork).m_pID+(k.m_nLayer+1)+"楼"]):this.VoicePost(["从",T.m_pEndPoint.m_mLandmark.Object.TypeName(),"到达",MiaokitDC.DC.GetWork(k.m_nWork).m_pID+(k.m_nLayer+1)+"楼"]):T.m_nWork==k.m_nWork?this.VoicePost(["从",T.m_pEndPoint.m_mLandmark.Object.TypeName(),"到达",k.m_nLayer+1+"楼"]):0!=k.m_nWork?this.VoicePost(["从",T.m_pEndPoint.m_mLandmark.Object.TypeName(),"到达",MiaokitDC.DC.GetWork(k.m_nWork).m_pID+(k.m_nLayer+1)+"楼"]):this.VoicePost(["从",T.m_pEndPoint.m_mLandmark.Object.TypeName(),"出到",MiaokitDC.DC.GetWork(k.m_nWork).m_pID]),console.log("动画类型:",T.m_pStartPoint.m_mLandmark.Object.m_nType),T.m_pStartPoint.m_mLandmark.Object.m_nType){case 0:console.log("无设置动画，默认调用上楼梯"),this.MoveClip(0);break;case 1:T.m_nLayer<k.m_nLayer?this.MoveClip(0):this.MoveClip(1);break;case 2:T.m_nLayer<k.m_nLayer?this.MoveClip(6):this.MoveClip(7);break;case 3:T.m_nLayer<k.m_nLayer?this.MoveClip(4):this.MoveClip(5);break;case 5:this.MoveClip(3);break;case 6:this.MoveClip(2)}this.m_nStarTime=(new Date).getTime()+4e3}else this.m_bAutoMotion&&this.m_pVoiceEnd&&(new Date).getTime()>this.m_nStarTime&&(k.m_nWork!=MiaokitDC.DC.m_nCurWork&&this.SwitchWorkForIndex(k.m_nWork),this.ActiveFloor(k.m_nLayer),this.m_nMotion=0);else if(4==this.m_nMotion)if(0==this.m_nNpointIndex&&this.m_nNpointIndex++,this.m_nNpointIndex<T.m_aPath.length){var S=void 0,x=this.m_nSample*this.m_nSampleFactor;for(this.m_nSampleFactor++;this.m_nSampleLength<x;){if(this.m_nNpointIndex++,this.m_nNpointIndex>=T.m_aPath.length){x=this.m_nSampleLength,Engine.g_pInstance.CamTracking(T.m_pEndPoint.m_mPosition);break}this.m_nSampleLength+=Vector3.Distance(T.m_aPath[this.m_nNpointIndex-1],T.m_aPath[this.m_nNpointIndex])}if(this.m_nNpointIndex<T.m_aPath.length){var M=Vector3.Distance(T.m_aPath[this.m_nNpointIndex-1],T.m_aPath[this.m_nNpointIndex]),D=(M-(this.m_nSampleLength-x))/M;S=Vector3.LerpVectors(T.m_aPath[this.m_nNpointIndex-1],T.m_aPath[this.m_nNpointIndex],D),Engine.g_pInstance.CamTracking(S)}}else this.m_pVoiceEnd&&this.m_nMotion++}d++}}catch(t){C=!0,v=t}finally{try{!y&&g.return&&g.return()}finally{if(C)throw v}}}}}}},{key:"RealTimeVoiceNavi",value:function(){if(this.m_bRealTimeNavi){var t=EyejiaDC.DC.m_pLayerMgr.m_pActiveLayer.m_nIndex,e=MiaokitDC.DC.m_nCurWork;if(Engine.g_pInstance.m_nBlueWorkID==e&&Engine.g_pInstance.m_nBlueLayerID==t&&this.m_pNPaths!=[]){var n=!0,i=!1,a=void 0;try{for(var o,s=this.m_pNPaths[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var r=o.value;if(r.m_nWork==e&&r.m_nLayer==t){var m=null,l=0,h=!0,_=!1,u=void 0;try{for(var c,p=r.m_pPathPassage[Symbol.iterator]();!(h=(c=p.next()).done);h=!0){var d=c.value;m=null==m?d:this.NearPathPassage(this.m_pBluePos,m,d),l++}}catch(t){_=!0,u=t}finally{try{!h&&p.return&&p.return()}finally{if(_)throw u}}if(5<this.DisPathPassage(this.m_pBluePos,m))0!=this.m_nRealTimeTab?(this.m_nRealTimeTab=0,this.VoicePost(["您已经偏离航线"])):(this.m_bWaitVoice||this.m_bWaitTime||(this.m_nStarTime=(new Date).getTime()+7*this.m_nVoiceSpeed+4e3,this.m_bWaitTime=!0),this.m_bWaitTime&&(new Date).getTime()>this.m_nStarTime&&(this.VoicePost(["您已经偏离航线"]),this.m_bWaitTime=!1));else{var y=Vector3.Distance(this.m_pBluePos,m.m_pEndPos);if(Vector3.Distance(this.m_pBluePos,m.m_pStarPos)<2)if(y<2){var C=m.m_pNextAngle;C<110?1!=this.m_nRealTimeTab?(this.m_nRealTimeTab=1,this.VoicePost(["向左方行走"])):(this.m_bWaitVoice||this.m_bWaitTime||(this.m_nStarTime=(new Date).getTime()+5*this.m_nVoiceSpeed+4e3,this.m_bWaitTime=!0),this.m_bWaitTime&&(new Date).getTime()>this.m_nStarTime&&(this.VoicePost(["向左方行走"]),this.m_bWaitTime=!1)):C<150?2!=this.m_nRealTimeTab?(this.m_nRealTimeTab=2,this.VoicePost(["向左前方行走"])):(this.m_bWaitVoice||this.m_bWaitTime||(this.m_nStarTime=(new Date).getTime()+6*this.m_nVoiceSpeed+4e3,this.m_bWaitTime=!0),this.m_bWaitTime&&(new Date).getTime()>this.m_nStarTime&&(this.VoicePost(["向左前方行走"]),this.m_bWaitTime=!1)):C<210?3!=this.m_nRealTimeTab?(this.m_nRealTimeTab=3,this.VoicePost(["向右前方行走"])):(this.m_bWaitVoice||this.m_bWaitTime||(this.m_nStarTime=(new Date).getTime()+6*this.m_nVoiceSpeed+4e3,this.m_bWaitTime=!0),this.m_bWaitTime&&(new Date).getTime()>this.m_nStarTime&&(this.VoicePost(["向右前方行走"]),this.m_bWaitTime=!1)):C<250&&(4!=this.m_nRealTimeTab?(this.m_nRealTimeTab=4,this.VoicePost(["向右方行走"])):(this.m_bWaitVoice||this.m_bWaitTime||(this.m_nStarTime=(new Date).getTime()+5*this.m_nVoiceSpeed+4e3,this.m_bWaitTime=!0),this.m_bWaitTime&&(new Date).getTime()>this.m_nStarTime&&(this.VoicePost(["向右方行走"]),this.m_bWaitTime=!1)))}else if(l>0){var v=r.m_pPathPassage[l-1].m_pNextAngle;v<110?5!=this.m_nRealTimeTab?(this.m_nRealTimeTab=5,this.VoicePost(["向左方行走"])):(this.m_bWaitVoice||this.m_bWaitTime||(this.m_nStarTime=(new Date).getTime()+5*this.m_nVoiceSpeed+4e3,this.m_bWaitTime=!0),this.m_bWaitTime&&(new Date).getTime()>this.m_nStarTime&&(this.VoicePost(["向左方行走"]),this.m_bWaitTime=!1)):v<150?6!=this.m_nRealTimeTab?(this.m_nRealTimeTab=6,this.VoicePost(["向左前方行走"])):(this.m_bWaitVoice||this.m_bWaitTime||(this.m_nStarTime=(new Date).getTime()+6*this.m_nVoiceSpeed+4e3,this.m_bWaitTime=!0),this.m_bWaitTime&&(new Date).getTime()>this.m_nStarTime&&(this.VoicePost(["向左前方行走"]),this.m_bWaitTime=!1)):v<210?7!=this.m_nRealTimeTab?(this.m_nRealTimeTab=7,this.VoicePost(["向右前方行走"])):(this.m_bWaitVoice||this.m_bWaitTime||(this.m_nStarTime=(new Date).getTime()+6*this.m_nVoiceSpeed+4e3,this.m_bWaitTime=!0),this.m_bWaitTime&&(new Date).getTime()>this.m_nStarTime&&(this.VoicePost(["向右前方行走"]),this.m_bWaitTime=!1)):v<250&&(8!=this.m_nRealTimeTab?(this.m_nRealTimeTab=8,this.VoicePost(["向右方行走"])):(this.m_bWaitVoice||this.m_bWaitTime||(this.m_nStarTime=(new Date).getTime()+5*this.m_nVoiceSpeed+4e3,this.m_bWaitTime=!0),this.m_bWaitTime&&(new Date).getTime()>this.m_nStarTime&&(this.VoicePost(["向右方行走"]),this.m_bWaitTime=!1)))}else if(y<10){var f=m.m_pNextAngle;0==f?9!=this.m_nRealTimeTab?(this.m_nRealTimeTab=9,this.VoicePost(["前方行走",y.toString(),"米","到达目的地"])):(this.m_bWaitVoice||this.m_bWaitTime||(this.m_nStarTime=(new Date).getTime()+11*this.m_nVoiceSpeed+4e3,this.m_bWaitTime=!0),this.m_bWaitTime&&(new Date).getTime()>this.m_nStarTime&&(this.VoicePost(["前方行走",y.toString(),"米","到达目的地"]),this.m_bWaitTime=!1)):f<110?10!=this.m_nRealTimeTab?(this.m_nRealTimeTab=10,this.VoicePost(["前方",y.toString(),"米","向左行走"])):(this.m_bWaitVoice||this.m_bWaitTime||(this.m_nStarTime=(new Date).getTime()+8*this.m_nVoiceSpeed+4e3,this.m_bWaitTime=!0),this.m_bWaitTime&&(new Date).getTime()>this.m_nStarTime&&(this.VoicePost(["前方",y.toString(),"米","向左行走"]),this.m_bWaitTime=!1)):f<150?11!=this.m_nRealTimeTab?(this.m_nRealTimeTab=11,this.VoicePost(["前方",y.toString(),"米","向左前方行走"])):(this.m_bWaitVoice||this.m_bWaitTime||(this.m_nStarTime=(new Date).getTime()+10*this.m_nVoiceSpeed+4e3,this.m_bWaitTime=!0),this.m_bWaitTime&&(new Date).getTime()>this.m_nStarTime&&(this.VoicePost(["前方",y.toString(),"米","向左前方行走"]),this.m_bWaitTime=!1)):f<210?12!=this.m_nRealTimeTab?(this.m_nRealTimeTab=12,this.VoicePost(["前方",y.toString(),"米","向右前方行走"])):(this.m_bWaitVoice||this.m_bWaitTime||(this.m_nStarTime=(new Date).getTime()+10*this.m_nVoiceSpeed+4e3,this.m_bWaitTime=!0),this.m_bWaitTime&&(new Date).getTime()>this.m_nStarTime&&(this.VoicePost(["前方",y.toString(),"米","向右前方行走"]),this.m_bWaitTime=!1)):f<250&&(13!=this.m_nRealTimeTab?(this.m_nRealTimeTab=13,this.VoicePost(["前方",y.toString(),"米","向右行走"])):(this.m_bWaitVoice||this.m_bWaitTime||(this.m_nStarTime=(new Date).getTime()+8*this.m_nVoiceSpeed+4e3,this.m_bWaitTime=!0),this.m_bWaitTime&&(new Date).getTime()>this.m_nStarTime&&(this.VoicePost(["前方",y.toString(),"米","向右行走"]),this.m_bWaitTime=!1)))}else 14!=this.m_nRealTimeTab?(this.m_nRealTimeTab=14,this.VoicePost(["沿着当前路线直行"])):(this.m_bWaitVoice||this.m_bWaitTime||(this.m_nStarTime=(new Date).getTime()+8*this.m_nVoiceSpeed+4e3,this.m_bWaitTime=!0),this.m_bWaitTime&&(new Date).getTime()>this.m_nStarTime&&(this.VoicePost(["沿着当前路线直行"]),this.m_bWaitTime=!1));else if(y>10)15!=this.m_nRealTimeTab?(this.m_nRealTimeTab=15,this.VoicePost(["沿着当前路线直行"])):(this.m_bWaitVoice||this.m_bWaitTime||(this.m_nStarTime=(new Date).getTime()+8*this.m_nVoiceSpeed+4e3,this.m_bWaitTime=!0),this.m_bWaitTime&&(new Date).getTime()>this.m_nStarTime&&(this.VoicePost(["沿着当前路线直行"]),this.m_bWaitTime=!1));else{var g=m.m_pNextAngle;0==g?16!=this.m_nRealTimeTab?(this.m_nRealTimeTab=16,this.VoicePost(["前方直行",y.toString(),"米","到达目的地"])):(this.m_bWaitVoice||this.m_bWaitTime||(this.m_nStarTime=(new Date).getTime()+11*this.m_nVoiceSpeed+4e3,this.m_bWaitTime=!0),this.m_bWaitTime&&(new Date).getTime()>this.m_nStarTime&&(this.VoicePost(["前方直行",y.toString(),"米","到达目的地"]),this.m_bWaitTime=!1)):g<110?17!=this.m_nRealTimeTab?(this.m_nRealTimeTab=17,this.VoicePost(["前方",y.toString(),"米","向左行走"])):(this.m_bWaitVoice||this.m_bWaitTime||(this.m_nStarTime=(new Date).getTime()+8*this.m_nVoiceSpeed+4e3,this.m_bWaitTime=!0),this.m_bWaitTime&&(new Date).getTime()>this.m_nStarTime&&(this.VoicePost(["前方",y.toString(),"米","向左行走"]),this.m_bWaitTime=!1)):g<150?18!=this.m_nRealTimeTab?(this.m_nRealTimeTab=18,this.VoicePost(["前方",y.toString(),"米","向左前方行走"])):(this.m_bWaitVoice||this.m_bWaitTime||(this.m_nStarTime=(new Date).getTime()+10*this.m_nVoiceSpeed+4e3,this.m_bWaitTime=!0),this.m_bWaitTime&&(new Date).getTime()>this.m_nStarTime&&(this.VoicePost(["前方",y.toString(),"米","向左前方行走"]),this.m_bWaitTime=!1)):g<210?19!=this.m_nRealTimeTab?(this.m_nRealTimeTab=19,this.VoicePost(["前方",y.toString(),"米","向右前方行走"])):(this.m_bWaitVoice||this.m_bWaitTime||(this.m_nStarTime=(new Date).getTime()+10*this.m_nVoiceSpeed+4e3,this.m_bWaitTime=!0),this.m_bWaitTime&&(new Date).getTime()>this.m_nStarTime&&(this.VoicePost(["前方",y.toString(),"米","向右前方行走"]),this.m_bWaitTime=!1)):g<250&&(20!=this.m_nRealTimeTab?(this.m_nRealTimeTab=20,this.VoicePost(["前方",y.toString(),"米","向右行走"])):(this.m_bWaitVoice||this.m_bWaitTime||(this.m_nStarTime=(new Date).getTime()+8*this.m_nVoiceSpeed+4e3,this.m_bWaitTime=!0),this.m_bWaitTime&&(new Date).getTime()>this.m_nStarTime&&(this.VoicePost(["前方",y.toString(),"米","向右行走"]),this.m_bWaitTime=!1)))}}}}}catch(t){i=!0,a=t}finally{try{!n&&s.return&&s.return()}finally{if(i)throw a}}}}}},{key:"DisPathPassage",value:function(t,e){return this.PointToSegDist(t.x,t.z,e.m_pStarPos.x,e.m_pStarPos.z,e.m_pEndPos.x,e.m_pEndPos.z)}},{key:"NearPathPassage",value:function(t,e,n){return this.PointToSegDist(t.x,t.z,e.m_pStarPos.x,e.m_pStarPos.z,e.m_pEndPos.x,e.m_pEndPos.z)<this.PointToSegDist(t.x,t.z,n.m_pStarPos.x,n.m_pStarPos.z,n.m_pEndPos.x,n.m_pEndPos.z)?e:n}},{key:"PointToSegDist",value:function(t,e,n,i,a,o){var s=(a-n)*(t-n)+(o-i)*(e-i);if(s<=0)return Math.sqrt((t-n)*(t-n)+(e-i)*(e-i));var r=(a-n)*(a-n)+(o-i)*(o-i);if(s>=r)return Math.sqrt((t-a)*(t-a)+(e-o)*(e-o));var m=s/r,l=n+(a-n)*m,h=i+(o-i)*m;return Math.sqrt((t-l)*(t-l)+(h-i)*(h-i))}},{key:"VoicePost",value:function(t){console.log("提交语音--",t),this.m_bWaitVoice=!0,this.m_bWaitTime=!1,this.m_pVoiceEnd=!1,Engine.g_pInstance.m_pVoicePost(t)}},{key:"VoicePuse",value:function(){console.log("终止当前语音播放"),this.m_bWaitVoice=!1,this.m_pVoiceEnd=!1}},{key:"MoveClip",value:function(t){console.log("当前段动画播放:",t),Engine.g_pInstance.m_pMoviePost(t)}},{key:"VoiceStart",value:function(){console.log("当前段语音开始播放"),this.m_bWaitVoice=!1}},{key:"VoiceEnd",value:function(){console.log("当前段语音播放完毕"),this.m_pVoiceEnd=!0}},{key:"StopAutoMotion",value:function(){this.m_bAutoMotion=!1,this.m_nMotion=10}}]),t}(),NavBackData=function t(e,n,i){_classCallCheck(this,t),this.HousId=e,this.LayerId=i,this.PId=n},EFurnitureModel=function(){function t(e){_classCallCheck(this,t),this.m_mAttachment=new Handle(Attachment,0),this.m_pModel=null,this.m_pDesc=null,this.m_bUpdated=!1,this.m_aInitData=null,this.m_pBindAtrri=null,this.desc=e}return _createClass(t,[{key:"Remap",value:function(t){this.m_mAttachment.Heap=t}},{key:"Apply",value:function(){if(this.m_bUpdated){var t=null!=this.attachment&&this.attachment.active;null!=this.model&&this.model.SetActive(t),this.m_bUpdated=!1}}},{key:"Destroy",value:function(){this.m_bUpdated=!1,this.m_pDesc=null,this.m_pModel=null}},{key:"Clear",value:function(){}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){t.ReadUInt32();this.m_aInitData=[new Vector3(0,0,0),new Vector3(0,0,0),new Vector3(0,0,0)],this.m_mAttachment.Number=t.ReadUInt32(),this.m_aInitData[0].x=t.ReadSingle(),this.m_aInitData[0].y=t.ReadSingle(),this.m_aInitData[0].z=t.ReadSingle(),this.m_aInitData[1].x=t.ReadSingle(),this.m_aInitData[1].y=t.ReadSingle(),this.m_aInitData[1].z=t.ReadSingle(),this.m_aInitData[2].x=t.ReadSingle(),this.m_aInitData[2].y=t.ReadSingle(),this.m_aInitData[2].z=t.ReadSingle();var e=t.ReadInt64();if(8==t.ReadUInt32()){t.ReadUInt32();var n=t.ReadString(),i=t.ReadString(),a=t.ReadString();this.m_pBindAtrri=new EBlueTooth(this.m_aInitData[0],n,i,a)}t.Position=e,501347081!=t.ReadInt32()&&alert("EFurnitureModel.UnSerialize(): Bad end!"),this.m_bUpdated=!0}},{key:"Inherit",value:function(t){return!0}},{key:"version",get:function(){return 1e3}},{key:"type",get:function(){return EntityType.Collection}},{key:"attachment",get:function(){return this.m_mAttachment.Object},set:function(t){this.m_mAttachment.Number=t.handle.Number,this.m_bUpdated=!0}},{key:"displayType",get:function(){return DisplayType.Normal},set:function(t){}},{key:"resource",get:function(){return this.model}},{key:"collectionType",get:function(){return CollectionType.EFurnitureModel}},{key:"desc",set:function(t){null==this.m_pDesc&&(this.m_pDesc=t,null!=this.m_pDesc&&(null!=this.m_pDesc.m_pModelUrl&&""!=this.m_pDesc.m_pModelUrl?this.m_pModel=this.m_pDesc.m_pModel.CloneModel():(console.log(this.m_pDesc.name+"URL为"+this.m_pDesc.m_pModelUrl),alert(this.m_pDesc.name+"URL为"+this.m_pDesc.m_pModelUrl)),null!=this.m_pModel&&null!=this.m_aInitData&&(this.position=this.m_aInitData[0],this.eulerAngles=this.m_aInitData[1],this.localScale=this.m_aInitData[2],this.m_aInitData=null)),this.m_bUpdated=!0)}},{key:"position",get:function(){return null!=this.m_pModel?this.m_pModel.position:null!=this.m_aInitData?Vector3.Clone(this.m_aInitData[0]):new Vector3(0,0,0)},set:function(t){null!=this.model&&(this.model.position=t),this.m_bUpdated=!0}},{key:"eulerAngles",get:function(){return null!=this.m_pModel?this.m_pModel.eulerAngles:null!=this.m_aInitData?Vector3.Clone(this.m_aInitData[1]):new Vector3(0,0,0)},set:function(t){null!=this.model&&(this.model.eulerAngles=t),this.m_bUpdated=!0}},{key:"localScale",get:function(){return null!=this.m_pModel?this.m_pModel.localScale:null!=this.m_aInitData?Vector3.Clone(this.m_aInitData[2]):new Vector3(0,0,0)},set:function(t){null!=this.model&&(this.model.localScale=t),this.m_bUpdated=!0}},{key:"model",get:function(){return this.m_pModel}}]),t}(),EFurnitureModelDesc=function(){function t(){_classCallCheck(this,t),this.m_nID=0,this.m_nCategoryID=0,this.m_pName=null,this.m_nDefaultHeight=0,this.m_mSize=new Vector3(0,0,0),this.m_pDeviceType=null,this.m_pModelUrl=null,this.m_pModelUrlH5=null,this.m_pIconUrl=null,this.m_pModel=null,this.m_pModelType=null,this.m_bEnableScale=!1}return _createClass(t,[{key:"Init",value:function(t){}},{key:"Destory",value:function(){this.m_pModel=null}},{key:"Load",value:function(t,e){if(null==this.m_pModelUrl||this.m_pModelUrl.length<1)e(null);else{var n=this;MiaokitDC.DC.m_pAssetsLoader.LoadModel(this.m_pModelUrl,function(t){null!=t?(n.m_pModel=t,n.m_pModel.m_pName=n.m_pName):console.log("模型加载失败",n.m_pModelUrl),e()})}}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){var e=t.ReadUInt32();if(this.m_nID=t.ReadInt32(),this.m_nCategoryID=t.ReadInt32(),this.m_pName=t.ReadString(),this.m_nDefaultHeight=t.ReadSingle(),this.m_mSize.x=t.ReadSingle(),this.m_mSize.y=t.ReadSingle(),this.m_mSize.z=t.ReadSingle(),this.m_pModelUrl=t.ReadString(),this.m_pIconUrl=t.ReadString(),this.m_bEnableScale=t.ReadBoolean(),this.m_pModelType=t.ReadString(),this.m_pDeviceType=t.ReadString(),e>1e3&&(this.m_pModelUrl=t.ReadString()),e>1001)t.ReadString();else;501347081!=t.ReadInt32()&&alert("AHoleModel.Desc.UnSerialize(): Bad end!")}},{key:"version",get:function(){return 1001}},{key:"id",get:function(){return this.m_nID}},{key:"typeId",get:function(){return this.m_nCategoryID}},{key:"name",get:function(){return this.m_pName}},{key:"desc",get:function(){return""}},{key:"iconUrl",get:function(){return this.m_pIconUrl}},{key:"resource",get:function(){return this.m_pModel}}]),t}(),EBuildingModel=function(){function t(e){_classCallCheck(this,t),this.m_mAttachment=new Handle(Attachment,0),this.m_nWorkID=0,this.m_pModel=null,this.m_pDesc=null,this.m_bUpdated=!1,this.m_aInitData=null,this.desc=e}return _createClass(t,[{key:"Remap",value:function(t){this.m_mAttachment.Heap=t}},{key:"Apply",value:function(){if(this.m_bUpdated){var t=null!=this.attachment&&this.attachment.active;null!=this.model&&this.model.SetActive(t),this.m_bUpdated=!1}}},{key:"Destroy",value:function(){this.m_bUpdated=!1,this.m_pDesc=null,this.m_pModel=null,this.m_nWorkID=0}},{key:"Clear",value:function(){}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){t.ReadUInt32();this.m_aInitData=[new Vector3(0,0,0),new Vector3(0,0,0),new Vector3(0,0,0)],this.m_mAttachment.Number=t.ReadUInt32(),this.m_nWorkID=t.ReadInt32(),this.m_aInitData[0].x=t.ReadSingle(),this.m_aInitData[0].y=t.ReadSingle(),this.m_aInitData[0].z=t.ReadSingle(),this.m_aInitData[1].x=t.ReadSingle(),this.m_aInitData[1].y=t.ReadSingle(),this.m_aInitData[1].z=t.ReadSingle(),this.m_aInitData[2].x=t.ReadSingle(),this.m_aInitData[2].y=t.ReadSingle(),this.m_aInitData[2].z=t.ReadSingle(),501347081!=t.ReadInt32()&&alert("EBuildingModel.UnSerialize(): Bad end!"),this.m_bUpdated=!0}},{key:"Inherit",value:function(t){return!0}},{key:"version",get:function(){return 1e3}},{key:"type",get:function(){return EntityType.Collection}},{key:"attachment",get:function(){return this.m_mAttachment.Object},set:function(t){this.m_mAttachment.Number=t.handle.Number,this.m_bUpdated=!0}},{key:"displayType",get:function(){return DisplayType.Normal},set:function(t){}},{key:"resource",get:function(){return this.model}},{key:"collectionType",get:function(){return CollectionType.EBuildingModel}},{key:"desc",set:function(t){null==this.m_pDesc&&(this.m_pDesc=t,null!=this.m_pDesc&&(null!=this.m_pDesc.m_pModelUrl?this.m_pModel=this.m_pDesc.m_pModel.CloneModel():this.m_pModel=this.m_pDesc.m_pModel,null!=this.m_pModel&&null!=this.m_aInitData&&(this.m_aInitData=null)),this.m_bUpdated=!0)}},{key:"workID",get:function(){return this.m_nWorkID},set:function(t){this.m_nWorkID=t}},{key:"position",get:function(){return null!=this.m_pModel?this.m_pModel.position:null!=this.m_aInitData?Vector3.Clone(this.m_aInitData[0]):new Vector3(0,0,0)},set:function(t){null!=this.model&&(this.model.position=t),this.m_bUpdated=!0}},{key:"eulerAngles",get:function(){return null!=this.m_pModel?this.m_pModel.eulerAngles:null!=this.m_aInitData?Vector3.Clone(this.m_aInitData[1]):new Vector3(0,0,0)},set:function(t){null!=this.model&&(this.model.eulerAngles=t),this.m_bUpdated=!0}},{key:"localScale",get:function(){return null!=this.m_pModel?this.m_pModel.localScale:null!=this.m_aInitData?Vector3.Clone(this.m_aInitData[2]):new Vector3(0,0,0)},set:function(t){null!=this.model&&(this.model.localScale=t),this.m_bUpdated=!0}},{key:"model",get:function(){return this.m_pModel}}]),t}(),EBuildingModelDesc=function(){function t(){_classCallCheck(this,t),this.m_nID=0,this.m_nCategoryID=0,this.m_pName=null,this.m_nDefaultHeight=0,this.m_mSize=new Vector3(0,0,0),this.m_pModelUrl=null,this.m_pModelUrlH5=null,this.m_pIconUrl=null,this.m_pModel=null,this.m_pModelType=null}return _createClass(t,[{key:"Init",value:function(t){}},{key:"InitByObject",value:function(t){this.m_nID=-1,this.m_nCategoryID=-1,this.m_pName=t.name,this.m_nDefaultHeight=0,this.m_mSize=new Vector3(1,1,1),this.m_pModelUrl=null,this.m_pModelUrlH5=null,this.m_pIconUrl=null,this.m_pModel=t,this.m_pModelType=null}},{key:"Destory",value:function(){this.m_pModel=null}},{key:"Load",value:function(t,e){if(null==this.m_pModelUrl||this.m_pModelUrl.length<1)e(null);else{var n=this;MiaokitDC.DC.m_pAssetsLoader.LoadModel(this.m_pModelUrl,function(t){n.m_pModel=t,n.m_pModel.m_pName=n.m_pName,e()})}}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){var e=t.ReadUInt32();if(this.m_nID=t.ReadInt32(),this.m_nCategoryID=t.ReadInt32(),this.m_pName=t.ReadString(),this.m_nDefaultHeight=t.ReadSingle(),this.m_mSize.x=t.ReadSingle(),this.m_mSize.y=t.ReadSingle(),this.m_mSize.z=t.ReadSingle(),this.m_pModelUrl=t.ReadString(),this.m_pIconUrl=t.ReadString(),this.m_pModelType=t.ReadString(),e>1e3&&(this.m_pModelUrlH5=t.ReadString()),e>1001)t.ReadString();else;501347081!=t.ReadInt32()&&alert("EBuildingModel.Desc.UnSerialize(): Bad end!")}},{key:"version",get:function(){return 1001}},{key:"id",get:function(){return this.m_nID}},{key:"typeId",get:function(){return this.m_nCategoryID}},{key:"name",get:function(){return this.m_pName}},{key:"desc",get:function(){return""}},{key:"iconUrl",get:function(){return this.m_pIconUrl}},{key:"resource",get:function(){return this.m_pModel}}]),t}(),ECollectionGroup=function(){function t(e){_classCallCheck(this,t),this.m_mAttachment=new Handle(Attachment,0),this.m_pObject=null,this.m_mPosition=new Vector3(0,0,0),this.m_pName=null,this.m_eType=GroupType.Invalid,this.m_pName="",this.m_eType=e}return _createClass(t,[{key:"Remap",value:function(t){this.m_mAttachment.Heap=t}},{key:"Apply",value:function(){}},{key:"Destroy",value:function(){this.m_pObject.Destroy(),this.m_pObject=null}},{key:"Clear",value:function(){}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){t.ReadUInt32();this.m_mAttachment.Number=t.ReadUInt32();var e=new Vector3(0,0,0);e.x=t.ReadSingle(),e.y=t.ReadSingle(),e.z=t.ReadSingle(),this.m_pName=t.ReadString(),501347081!=t.ReadInt32()&&alert("ECollectionGroup.UnSerialize(): Bad end!"),this.position=e}},{key:"version",get:function(){return 1e3}},{key:"type",get:function(){return EntityType.Group}},{key:"attachment",get:function(){return this.m_mAttachment.Object},set:function(t){this.m_mAttachment.Number=t.handle.Number}},{key:"displayType",get:function(){return DisplayType.Normal},set:function(t){}},{key:"resource",get:function(){return null}},{key:"groupType",get:function(){return this.m_eType}},{key:"gameObject",get:function(){return null==this.m_pObject&&(this.m_pObject=new GameObject("Group",GameObjectType.Empty),this.m_pObject.layer=Hook.LayerEnumToLayer(LayerType.EGroup),this.m_pObject.position=this.m_mPosition),this.m_pObject}},{key:"position",get:function(){return null==this.m_pObject?Vector3.Clone(this.m_mPosition):this.m_pObject.position},set:function(t){this.m_mPosition.x=t.x,this.m_mPosition.y=t.y,this.m_mPosition.z=t.z,null!=this.m_pObject&&(this.m_pObject.position=this.m_mPosition)}}]),t}();!function(t){t[t.Normal=0]="Normal",t[t.EBlueTooth=1]="EBlueTooth"}(BindAttriType||(BindAttriType={}));var EBlueTooth=function(){function t(e,n,i,a){_classCallCheck(this,t),this.m_pPosition=null,this.m_pPosition=e,this.bindType=BindAttriType.EBlueTooth,this.m_pUuid=n,this.m_pMajorid=i,this.m_pMinorid=a}return _createClass(t,[{key:"SetPosition",value:function(t,e){this.m_pWorkID=t,this.m_pLayerID=e}}]),t}(),EyejiaDC=function(){function t(e,n){if(_classCallCheck(this,t),this.m_pLayerMgr=null,this.m_pLayerMgr=new EyejiaMgr(e),null!=n){var i=t.DC;t.DC=this,this.UnSerialize(n),t.DC=i}}return _createClass(t,[{key:"Update",value:function(){}},{key:"OnGUI",value:function(){}},{key:"OnViewModeChange",value:function(){}},{key:"ActiveLayer",value:function(t){this.m_pLayerMgr.ActiveLayer(t)}},{key:"version",value:function(){return 1e3}},{key:"Active",value:function(t){this.m_pLayerMgr.Active(t)}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){t.ReadUInt32();this.m_pLayerMgr.UnSerialize(t),501347081!=t.ReadInt32()&&alert("EyejiaDC.UnSerialize(): Bad end!")}}]),t}();EyejiaDC.DC=null;var EyejiaMgr=function(){function t(e){_classCallCheck(this,t),this.m_nWork=0,this.m_pActiveLayer=null,this.m_pSceneRoot=null,this.m_pLayerList=null,this.m_nWork=e,this.m_pActiveLayer=null,this.m_pSceneRoot=null,this.m_pLayerList=new Array}return _createClass(t,[{key:"version",value:function(){return 1e3}},{key:"Active",value:function(t){null!=this.m_pSceneRoot&&this.m_pSceneRoot.SetActive(t)}},{key:"ActiveLayer",value:function(t){var e=this.m_pLayerList[t];null!=this.m_pActiveLayer&&this.m_pActiveLayer.root.SetActive(!1),this.m_pActiveLayer=e,null!=this.m_pSceneRoot&&this.m_pActiveLayer.root.SetActive(!0)}},{key:"GetLayer",value:function(t){return t<this.m_pLayerList.length?this.m_pLayerList[t]:null}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){this.m_pSceneRoot=new GameObject("-Eyejia Root",GameObjectType.Empty),this.m_pSceneRoot.parent=MiaokitDC.DC.GetWork(this.m_nWork).m_pWorkRoot;t.ReadUInt32();for(var e=t.ReadInt32(),n=0;n<e;n++){var i=Eyejia.Create(t);i.m_nWork=this.m_nWork,i.m_nIndex=n,i.Rebuild(this.m_pSceneRoot),this.m_pLayerList.push(i)}501347081!=t.ReadInt32()&&alert("EyejiaMgr.UnSerialize(): Bad end!")}}]),t}(),Eyejia=function(){function t(){_classCallCheck(this,t),this.m_mMenuItemHeap=new HeapHandle(MenuItem,0),this.m_mAttachmentHeap=new HeapHandle(Attachment,0),this.m_mLayerRoot=new Handle(Attachment,0),this.m_pViewState=new CameraState,this.m_nRefPicID=-1,this.m_mRefPicSize=new Vector2(0,0),this.m_nDirectionHR=0,this.m_nWork=0,this.m_nIndex=0}return _createClass(t,[{key:"version",value:function(){return 1e3}},{key:"Rebuild",value:function(t){this.LoadGroup(this.m_mLayerRoot.Object);var e=this.root;e.parent=t,e.SetActive(!1),this.Rebuild1()}},{key:"Rebuild1",value:function(){var t=this,e=!0,n=!1,i=void 0;try{for(var a,o=t.m_mMenuItemHeap[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var s=a.value;MiaokitDC.DC.BindMenuType(s)?s.type.Add(s,t):(s.type=MiaokitDC.DC.m_pCategories,s.type.Add(s,this)),MiaokitDC.DC.m_pAssetsLoader.PushItem(s)}}catch(t){n=!0,i=t}finally{try{!e&&o.return&&o.return()}finally{if(n)throw i}}MiaokitDC.DC.m_pAssetsLoader.PushDelegate(t.m_nWork,function(){t.Rebuild2()})}},{key:"Rebuild2",value:function(){var t=new Array,e=!0,n=!1,i=void 0;try{for(var a,o=this.m_mAttachmentHeap[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var s=a.value;t.push(s);var r=s.menuItem.Object;null!=r&&r.refCount++}}catch(t){n=!0,i=t}finally{try{!e&&o.return&&o.return()}finally{if(n)throw i}}t.length>0?(this.Rebuild3(t),this.Rebuild5(t)):console.info("Eyejia.Rebuild2(): pAttachmentList.Count == 0.")}},{key:"Rebuild3",value:function(t){var e=!0,n=!1,i=void 0;try{for(var a,o=t[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var s=a.value;null==s.hook&&this.Rebuild4(s)}}catch(t){n=!0,i=t}finally{try{!e&&o.return&&o.return()}finally{if(n)throw i}}}},{key:"Rebuild4",value:function(e){if(null!=e.hook)return!0;if(e.builtin){var n=e.parent.Object;if(null!=n){if(this.Rebuild4(n)){var i=n.hook.gameObject.FindChild(e.binding);if(e.entityType==EntityType.Collection){var a=e.entity;a.desc=t.GetDefaultDesc(a.collectionType,i)}var o=i.AddHook();return e.hook=o,o.attachment=e,o.SetLayer(),!0}return alert("Eyejia.Rebuild4(): Parent rebuild error: "+n.name),!1}return alert("Eyejia.Rebuild4(): pParent == null."),!1}switch(e.entityType){case EntityType.Group:return this.LoadGroup(e),!0;case EntityType.Collection:return this.LoadCollection(e),!0;default:e.valid=!1,alert("Eyejia.Rebuild4(): Entity type invalid. "+e.entityType)}return!1}},{key:"Rebuild5",value:function(t){var e=!0,n=!1,i=void 0;try{for(var a,o=t[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var s=a.value;if(s.entityType!=EntityType.Component&&0==s.builtin){var r=s.parent.Object;null!=r&&(s.hook.gameObject.parent=r.hook.gameObject)}}}catch(t){n=!0,i=t}finally{try{!e&&o.return&&o.return()}finally{if(n)throw i}}var m=!0,l=!1,h=void 0;try{for(var _,u=t[Symbol.iterator]();!(m=(_=u.next()).done);m=!0){var c=_.value;null!=c.entity&&c.entity.Apply()}}catch(t){l=!0,h=t}finally{try{!m&&u.return&&u.return()}finally{if(l)throw h}}}},{key:"LoadGroup",value:function(t){var e=t.entity.gameObject.AddHook();t.hook=e,e.attachment=t}},{key:"LoadCollection",value:function(t){this.Init(t.menuItem.Object,function(e){if(null!=e){var n=t.entity,i=null;switch(n.collectionType){case CollectionType.ETexture:n.desc=e.collectionDesc;break;case CollectionType.EFurnitureModel:n.desc=e.collectionDesc;var a=n.model;null!=a&&(i=a.AddHook(),a.SetActive(!0)),t.hook=i,i.attachment=t,i.SetLayer();break;case CollectionType.EBuildingModel:n.desc=e.collectionDesc;var o=n.model;null!=o&&(i=o.AddHook(),o.SetActive(!0)),t.hook=i,i.attachment=t,i.SetLayer();break;default:alert("Eyejia.LoadCollection(): Invalid collection type.")}}else t.valid=!1})}},{key:"Init",value:function(t,e){var n=t.type;if(null!=n){var i=n.Search(t,this);null==i?(i=this.m_mMenuItemHeap.CreateData(0,t).Object,n.Add(i,this),i.LoadAndSet(null,e)):i.LoadAndSet(null,e)}else alert("Eyejia.Init(): pType == null."),e(null)}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){var e=t.ReadUInt32();this.m_mMenuItemHeap.Number=t.ReadUInt32(),this.m_mAttachmentHeap.Number=t.ReadUInt32(),this.m_mLayerRoot.Number=t.ReadUInt32(),this.m_mMenuItemHeap.InitHeap(t),this.m_mAttachmentHeap.InitHeap(t),this.m_pViewState.UnSerialize(t),this.m_nRefPicID=t.ReadInt32(),this.m_mRefPicSize.x=t.ReadSingle(),this.m_mRefPicSize.y=t.ReadSingle(),e>1e3&&(this.m_nDirectionHR=t.ReadSingle()),501347081!=t.ReadInt32()&&alert("Eyejia.UnSerialize(): Bad end!")}},{key:"GetBlueToothStation",value:function(){var t=new Array,e=!0,n=!1,i=void 0;try{for(var a,o=this.m_mAttachmentHeap[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var s=a.value;if(s.entityType==EntityType.Collection){var r=s.entity;if(r.collectionType==CollectionType.EFurnitureModel){var m=r;if(null==m.m_pBindAtrri)continue;m.m_pBindAtrri.bindType==BindAttriType.EBlueTooth&&(m.m_pBindAtrri.SetPosition(this.m_nWork,this.m_nIndex),t.push(m.m_pBindAtrri))}}}}catch(t){n=!0,i=t}finally{try{!e&&o.return&&o.return()}finally{if(n)throw i}}return t}},{key:"root",get:function(){return this.m_mLayerRoot.Object.hook.gameObject}}],[{key:"Create",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=new t;return null!=e?n.UnSerialize(e):(n.m_mMenuItemHeap=new HeapHandle(MenuItem,0),n.m_mAttachmentHeap=new HeapHandle(Attachment,0),n.m_mMenuItemHeap.InitHeap(),n.m_mAttachmentHeap.InitHeap()),n}},{key:"GetDefaultDesc",value:function(t,e){switch(t){case CollectionType.EBuildingModel:var n=new EBuildingModelDesc;return n.InitByObject(e),n;default:alert("Eyejia.GetDefaultDesc(): Invalid type.")}return null}}]),t}(),NavChartDC=function(){function t(e,n){if(_classCallCheck(this,t),this.m_pLayerMgr=null,this.m_pLayerMgr=new NavChartMgr(e),null!=n){var i=t.DC;t.DC=this,this.UnSerialize(n),t.DC=i}}return _createClass(t,[{key:"Update",value:function(){}},{key:"OnGUI",value:function(){}},{key:"ActiveLayer",value:function(t){this.m_pLayerMgr.ActiveLayer(t)}},{key:"version",value:function(){return 1e3}},{key:"Active",value:function(t){this.m_pLayerMgr.Active(t)}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){t.ReadUInt32();this.m_pLayerMgr.UnSerialize(t),501347081!=t.ReadInt32()&&alert("NavChartDC.UnSerialize(): Bad end!")}}]),t}();NavChartDC.DC=null;var NUsageType,NavChartMgr=function(){function t(e){_classCallCheck(this,t),this.m_nWork=0,this.m_mPointHeap=null,this.m_mAdjoinHeap=null,this.m_mEdgeHeap=null,this.m_mLandmarkHeap=null,this.m_mLayerHeap=null,this.m_pActiveLayer=null,this.m_pSceneRoot=null,this.m_pLayerList=null,this.m_aTempAdjoin=null;var n=(e+1|4294967040)>>>0;this.m_nWork=e,this.m_mPointHeap=new HeapHandle(NPoint,n),this.m_mAdjoinHeap=new HeapHandle(NAdjoin,n),this.m_mEdgeHeap=new HeapHandle(NEdge,n),this.m_mLandmarkHeap=new HeapHandle(NLandmark,n),this.m_mLayerHeap=new HeapHandle(NavChart,n),this.m_mPointHeap.InitHeap(),this.m_mAdjoinHeap.InitHeap(),this.m_mEdgeHeap.InitHeap(),this.m_mLandmarkHeap.InitHeap(),this.m_mLayerHeap.InitHeap(),this.m_pActiveLayer=null,this.m_pSceneRoot=null,this.m_pLayerList=new Array,this.m_aTempAdjoin=[null,null]}return _createClass(t,[{key:"version",value:function(){return 1e3}},{key:"Active",value:function(t){null!=this.m_pSceneRoot&&this.m_pSceneRoot.SetActive(t)}},{key:"ActiveLayer",value:function(t){var e=this.m_pLayerList[t];null!=this.m_pActiveLayer&&null!=this.m_pActiveLayer.m_pLayerRoot&&this.m_pActiveLayer.m_pLayerRoot.SetActive(!1),this.m_pActiveLayer=e,null!=this.m_pSceneRoot&&null!=this.m_pActiveLayer.m_pLayerRoot&&this.m_pActiveLayer.m_pLayerRoot.SetActive(!0)}},{key:"GetLayer",value:function(t){return this.m_pLayerList[t]}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){this.m_pSceneRoot=new GameObject("-NavChart Root",GameObjectType.Empty),this.m_pSceneRoot.parent=MiaokitDC.DC.GetWork(this.m_nWork).m_pWorkRoot;t.ReadUInt32();var e=t.ReadInt32();if(t.ReadUInt32(),t.ReadUInt32(),t.ReadUInt32(),t.ReadUInt32(),t.ReadUInt32(),this.m_mPointHeap.InitHeap(t),this.m_mAdjoinHeap.InitHeap(t),this.m_mEdgeHeap.InitHeap(t),this.m_mLandmarkHeap.InitHeap(t),this.m_mLayerHeap.InitHeap(t),e!=this.m_nWork){var n=!0,i=!1,a=void 0;try{for(var o,s=this.m_mPointHeap[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var r=o.value;r.m_mHandle.Heap=this.m_mPointHeap,r.m_mLayer.Heap=this.m_mLayerHeap,r.m_mAdjoinList.Heap=this.m_mAdjoinHeap,r.m_mLandmark.Heap=this.m_mLandmarkHeap}}catch(t){i=!0,a=t}finally{try{!n&&s.return&&s.return()}finally{if(i)throw a}}var m=!0,l=!1,h=void 0;try{for(var _,u=this.m_mAdjoinHeap[Symbol.iterator]();!(m=(_=u.next()).done);m=!0){var c=_.value;c.m_mHandle.Heap=this.m_mAdjoinHeap,c.m_mAdjPoint.Heap=this.m_mPointHeap,c.m_mEdge.Heap=this.m_mEdgeHeap}}catch(t){l=!0,h=t}finally{try{!m&&u.return&&u.return()}finally{if(l)throw h}}var p=!0,d=!1,y=void 0;try{for(var C,v=this.m_mEdgeHeap[Symbol.iterator]();!(p=(C=v.next()).done);p=!0){var f=C.value;f.m_mHandle.Heap=this.m_mEdgeHeap,f.m_mLeftPoint.Heap=this.m_mPointHeap,f.m_mRightPoint.Heap=this.m_mPointHeap}}catch(t){d=!0,y=t}finally{try{!p&&v.return&&v.return()}finally{if(d)throw y}}var g=!0,T=!1,k=void 0;try{for(var S,x=this.m_mLandmarkHeap[Symbol.iterator]();!(g=(S=x.next()).done);g=!0){var M=S.value;M.m_mHandle.Heap=this.m_mLandmarkHeap,M.m_mPoint.Heap=this.m_mPointHeap}}catch(t){T=!0,k=t}finally{try{!g&&x.return&&x.return()}finally{if(T)throw k}}var D=!0,b=!1,P=void 0;try{for(var R,E=this.m_mLayerHeap[Symbol.iterator]();!(D=(R=E.next()).done);D=!0){var w=R.value;w.m_mHandle.Heap=this.m_mLayerHeap,w.m_mPointList.Heap=this.m_mPointHeap,w.m_mEdgeList.Heap=this.m_mEdgeHeap,w.m_mLandmarkList.Heap=this.m_mLandmarkHeap,w.m_mAdjoinHeap=this.m_mAdjoinHeap}}catch(t){b=!0,P=t}finally{try{!D&&E.return&&E.return()}finally{if(b)throw P}}}var I=!0,V=!1,L=void 0;try{for(var A,H=this.m_mLayerHeap.GetDefaultList()[Symbol.iterator]();!(I=(A=H.next()).done);I=!0){var N=A.value;N.m_mAdjoinHeap=this.m_mAdjoinHeap,N.m_nWork=this.m_nWork,N.BuildScene(this.m_pSceneRoot),this.m_pLayerList.push(N)}}catch(t){V=!0,L=t}finally{try{!I&&H.return&&H.return()}finally{if(V)throw L}}this.m_pLayerList.sort(function(t,e){return t.m_nIndex<e.m_nIndex?-1:t.m_nIndex>e.m_nIndex?1:0}),501347081!=t.ReadInt32()&&alert("NavChartMgr.UnSerialize(): Bad end!")}},{key:"LinkLayers",value:function(t,e,n){var i=this.m_aTempAdjoin[t];if(null==i){i=new Array,this.m_aTempAdjoin[t]=i;var a=new Array,o=new Array(this.m_pLayerList.length),s=!0,r=!1,m=void 0;try{for(var l,h=this.m_mLandmarkHeap[Symbol.iterator]();!(s=(l=h.next()).done);s=!0){var _=l.value,u=_.m_mPoint.Object;if(u.m_eUsage==t){if(_.m_nType>0&&_.m_nType<4){var c=u.m_mLayer.Object.m_nIndex,p=1024*c+ ++o[c];a.push({m_nIndex:p,m_pWellhole:_})}_.m_nType>4&&_.m_nType<8&&e.push(_),n.push(_)}}}catch(t){r=!0,m=t}finally{try{!s&&h.return&&h.return()}finally{if(r)throw m}}a.sort(function(t,e){return t.m_nIndex<e.m_nIndex?-1:t.m_nIndex>e.m_nIndex?1:0});for(var d=0;d<a.length;d++)for(var y=a[d].m_pWellhole,C=d+1;C<a.length;C++){var v=a[C].m_pWellhole;if(y.m_nType==v.m_nType&&y.m_nNumber==v.m_nNumber){var f=y.m_mPoint.Object,g=v.m_mPoint.Object,T=f.m_mAdjoinList.CreateData().Object,k=g.m_mAdjoinList.CreateData().Object;i.push(T),i.push(k),T.m_mAdjPoint.Number=g.m_mHandle.Number,T.m_nLength=-1,T.m_mEdge.Number=0,k.m_mAdjPoint.Number=f.m_mHandle.Number,k.m_nLength=-1,k.m_mEdge.Number=0;break}}}else console.error("NavChartMgr.LinkLayers(): pAdjoinList != null.")}},{key:"DelinkLayers",value:function(t){var e=this.m_aTempAdjoin[t];if(null!=e){var n=!0,i=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){o.value.m_mHandle.Destroy()}}catch(t){i=!0,a=t}finally{try{!n&&s.return&&s.return()}finally{if(i)throw a}}this.m_aTempAdjoin[t]=null}}},{key:"CollectPoint",value:function(t,e){var n=!0,i=!1,a=void 0;try{for(var o,s=this.m_mPointHeap[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var r=o.value;if(r.m_eUsage==t){var m=!0,l=!1,h=void 0;try{for(var _,u=r.m_mAdjoinList[Symbol.iterator]();!(m=(_=u.next()).done);m=!0){var c=_.value;c.m_nLength>=0?c.m_nLength=c.m_mEdge.Object.m_nLength:c.m_nLength<-1&&(c.m_nLength=-c.m_nLength)}}catch(t){l=!0,h=t}finally{try{!m&&u.return&&u.return()}finally{if(l)throw h}}r.m_nIndex=e.length,e.push(r)}}}catch(t){i=!0,a=t}finally{try{!n&&s.return&&s.return()}finally{if(i)throw a}}}}]),t}(),NavChart=function(){function t(){_classCallCheck(this,t),this.m_mHandle=new Handle(t,0),this.m_mPointList=new ListHandle(NPoint,0),this.m_mEdgeList=new ListHandle(NEdge,0),this.m_mLandmarkList=new ListHandle(NLandmark,0),this.m_nIndex=0,this.m_nWork=0,this.m_mAdjoinHeap=null,this.m_pLayerRoot=null,this.m_pIconMgr=null,this.m_pIconMgr=new NIconMgr}return _createClass(t,[{key:"OnCreate",value:function(t){}},{key:"OnEmploy",value:function(e){this.m_mHandle=new Handle(t,e)}},{key:"OnUnemploy",value:function(){}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){t.ReadUInt32();this.m_mHandle.Number=t.ReadUInt32(),this.m_mPointList.Number=t.ReadUInt32(),this.m_mEdgeList.Number=t.ReadUInt32(),this.m_mLandmarkList.Number=t.ReadUInt32(),this.m_nIndex=t.ReadInt32(),501347081!=t.ReadInt32()&&alert("NLayer.UnSerialize(): Bad end!")}},{key:"BuildScene",value:function(t){if(null!=t){this.m_pLayerRoot=new GameObject("NavChartLayer",GameObjectType.Empty),this.m_pLayerRoot.parent=t;var e=!0,n=!1,i=void 0;try{for(var a,o=this.m_mLandmarkList[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){a.value.CreateObject(this.m_pLayerRoot,this.m_pIconMgr)}}catch(t){n=!0,i=t}finally{try{!e&&o.return&&o.return()}finally{if(n)throw i}}this.m_pLayerRoot.SetActive(!1)}}},{key:"version",get:function(){return 1e3}}]),t}();NavChart.g_pContext=new HeapContext(NavChart),function(t){t[t.Navigation=0]="Navigation",t[t.Routing=1]="Routing"}(NUsageType||(NUsageType={}));var NPoint=function(){function t(){_classCallCheck(this,t),this.m_mHandle=new Handle(t,0),this.m_mLayer=new Handle(NavChart,0),this.m_mAdjoinList=new ListHandle(NAdjoin,0),this.m_mLandmark=new Handle(NLandmark,0),this.m_mPosition=new Vector3(0,0,0),this.m_nDegrees=0,this.m_eUsage=NUsageType.Navigation,this.m_nIndex=0,this.m_mClone=null}return _createClass(t,[{key:"OnCreate",value:function(t){}},{key:"OnEmploy",value:function(e){this.m_mHandle=new Handle(t,e)}},{key:"OnUnemploy",value:function(){}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){t.ReadUInt32();this.m_mHandle.Number=t.ReadUInt32(),this.m_mLayer.Number=t.ReadUInt32(),this.m_mAdjoinList.Number=t.ReadUInt32(),this.m_mLandmark.Number=t.ReadUInt32(),this.m_mPosition.x=t.ReadSingle(),this.m_mPosition.y=t.ReadSingle(),this.m_mPosition.z=t.ReadSingle(),this.m_nDegrees=t.ReadInt32(),this.m_eUsage=t.ReadInt32(),501347081!=t.ReadInt32()&&alert("NPoint.UnSerialize(): Bad end!")}},{key:"version",get:function(){return 1e3}}]),t}();NPoint.g_pContext=new HeapContext(NPoint);var NAdjoin=function(){function t(){_classCallCheck(this,t),this.m_mHandle=new Handle(t,0),this.m_mAdjPoint=new Handle(NPoint,0),this.m_mEdge=new Handle(NEdge,0),this.m_nLength=0}return _createClass(t,[{key:"OnCreate",value:function(t){}},{key:"OnEmploy",value:function(e){this.m_mHandle=new Handle(t,e)}},{key:"OnUnemploy",value:function(){}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){t.ReadUInt32();this.m_mHandle.Number=t.ReadUInt32(),this.m_mAdjPoint.Number=t.ReadUInt32(),this.m_mEdge.Number=t.ReadUInt32(),501347081!=t.ReadInt32()&&alert("NAdjoin.UnSerialize(): Bad end!")}},{key:"version",get:function(){return 1e3}}]),t}();NAdjoin.g_pContext=new HeapContext(NAdjoin);var NEdge=function(){function t(){_classCallCheck(this,t),this.m_mHandle=new Handle(t,0),this.m_mLeftPoint=new Handle(NPoint,0),this.m_mRightPoint=new Handle(NPoint,0),this.m_nLength=0,this.m_eUsage=NUsageType.Navigation}return _createClass(t,[{key:"OnCreate",value:function(t){}},{key:"OnEmploy",value:function(e){this.m_mHandle=new Handle(t,e)}},{key:"OnUnemploy",value:function(){}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){t.ReadUInt32();this.m_mHandle.Number=t.ReadUInt32(),this.m_mLeftPoint.Number=t.ReadUInt32(),this.m_mRightPoint.Number=t.ReadUInt32(),this.m_nLength=t.ReadSingle(),this.m_eUsage=t.ReadInt32(),501347081!=t.ReadInt32()&&alert("NEdge.UnSerialize(): Bad end!")}},{key:"version",get:function(){return 1e3}}]),t}();NEdge.g_pContext=new HeapContext(NEdge);var NLandmark=function(){function t(){_classCallCheck(this,t),this.m_mHandle=new Handle(t,0),this.m_mPoint=new Handle(NPoint,0),this.m_pAAreaLabel=null,this.m_pObject=null,this.m_pName="位置点",this.m_pIconUrl=null,this.m_nIconType=0}return _createClass(t,[{key:"OnCreate",value:function(t){}},{key:"OnEmploy",value:function(e){this.m_mHandle=new Handle(t,e)}},{key:"OnUnemploy",value:function(){}},{key:"Serialize",value:function(t){}},{key:"UnSerialize",value:function(t){t.ReadUInt32();this.m_mHandle.Number=t.ReadUInt32(),this.m_mPoint.Number=t.ReadUInt32(),this.m_pSerial=t.ReadString(),this.m_nType=t.ReadInt32(),this.m_nNumber=t.ReadInt32(),501347081!=t.ReadInt32()&&alert("NLandmark.UnSerialize(): Bad end!")}},{key:"CreateObject",value:function(t,e){if(null!=t&&MiaokitDC.DC.m_pNavigator.BindSiteData(this)&&this.m_nIconType>1){var n=Vector3.Clone(this.m_mPoint.Object.m_mPosition);n.y=.05,e.Add(n,this.m_pIconUrl,this.m_nIconType,t)}}},{key:"TypeName",value:function(){var t="";switch(this.m_nType){case 1:t="楼梯";break;case 2:t="电梯";break;case 3:t="手扶梯";break;case 5:t="出口";case 6:t="入口";break;case 7:t="出入口"}return t}},{key:"version",get:function(){return 1e3}}]),t}();NLandmark.g_pContext=new HeapContext(NLandmark);var NNavigator=function(){function t(){_classCallCheck(this,t),this.m_eUsage=NUsageType.Navigation,this.m_bLinked=!1,this.m_bFixedStart=!1,this.m_pStart=null,this.m_aRouting=null,this.m_aPoint=null,this.m_aGateType=null,this.m_pSiteList=null,this.m_pGateList=null,this.m_pTempAdjoin=null,this.m_pSiteData=null,this.m_aCurPath=null}return _createClass(t,[{key:"FindPath",value:function(t,e,n){if(null!=this.m_aCurPath){var i=!0,a=!1,o=void 0;try{for(var s,r=this.m_aCurPath[Symbol.iterator]();!(i=(s=r.next()).done);i=!0){s.value.DestoryObject()}}catch(t){a=!0,o=t}finally{try{!i&&r.return&&r.return()}finally{if(a)throw o}}this.m_aCurPath=null}if(this.InitPath(t,!1,n),null==this.m_pStart||this.m_pStart.m_mLandmark.Object.m_pSerial!=t)return null;var m=null,l=!0,h=!1,_=void 0;try{for(var u,c=this.m_pSiteList[Symbol.iterator]();!(l=(u=c.next()).done);l=!0){var p=u.value;if(e==p.m_pSerial&&null!=(m=p.m_mPoint.Object))break}}catch(t){h=!0,_=t}finally{try{!l&&c.return&&c.return()}finally{if(h)throw _}}if(null!=m){if(0==n&&(n=this.m_aGateType[m.m_nIndex]),this.m_aCurPath=this.FindPath2(m.m_nIndex,n),null==this.m_aCurPath)return null;for(var d=0;d<this.m_aCurPath.length;d++)for(var y=this.m_aCurPath[d],C=null,v=0;v<y.m_aPath.length-1;v++){var f=new PathPassage;if(f.m_pStarPos=y.m_aPath[v],f.m_pEndPos=y.m_aPath[v+1],f.m_pV3Lines=Vector3.Sub(f.m_pEndPos,f.m_pStarPos),f.m_pV2Lines=Vector2.Sub(new Vector2(f.m_pEndPos.x,f.m_pEndPos.z),new Vector2(f.m_pStarPos.x,f.m_pStarPos.z)),f.m_nDistan=Vector3.Distance(f.m_pEndPos,f.m_pStarPos),null!=C){var g=Vector2.AngleTo(C.m_pV2Lines,f.m_pV2Lines);g<10||g>350?(f.m_pStarPos=C.m_pStarPos,f.m_pV3Lines=Vector3.Sub(f.m_pEndPos,f.m_pStarPos),f.m_pV2Lines=Vector2.Sub(new Vector2(f.m_pEndPos.x,f.m_pEndPos.z),new Vector2(f.m_pStarPos.x,f.m_pStarPos.z)),f.m_nDistan=Vector3.Distance(f.m_pEndPos,f.m_pStarPos)):(C.m_pNextAngle=g,y.m_nDistance+=C.m_nDistan,y.m_pPathPassage.push(C))}C=f,v+1==y.m_aPath.length-1&&(y.m_nDistance+=C.m_nDistan,y.m_pPathPassage.push(C))}return this.m_aCurPath}return null}},{key:"FindPath2",value:function(t,e){if(null==this.m_aPoint||null==this.m_aRouting)return null;if(null==this.m_aRouting[e]){if(null==this.m_aRouting[0])return null;e=0}var n=this.m_aRouting[e];if(n[t]>=268435455)return null;for(var i=this.m_pStart.m_nIndex,a=new Array;t!=i;)a.push(this.m_aPoint[t]),t=n[t];a.push(this.m_aPoint[i]);for(var o=new Array,s=null,r=null,m=-1,l=0,h=a.length,_=0;_<h;_++){var u=a.pop(),c=u.m_mLayer.Object.m_nIndex,p=u.m_mLayer.Object.m_nWork;p==l&&c==m||(null!=r&&null!=s&&(r.m_aPath=s),m=c,l=p,r=new NPath,s=new Array,o.push(r),r.m_nWork=p,r.m_nLayer=m,r.m_pStartPoint=u),s.push(Vector3.Clone(u.m_mPosition)),r.m_pEndPoint=u}return null!=r&&null!=s&&(r.m_aPath=s),o}},{key:"InitPath",value:function(t,e,n){if(null!=t){if(this.m_bLinked&&!e||(this.Delink(),this.Link(),this.m_pStart=null,this.m_aRouting=null,this.m_bLinked=!0),!this.m_bFixedStart||null==this.m_pStart){this.m_pStart=null,this.m_aRouting=null;var i=!0,a=!1,o=void 0;try{for(var s,r=this.m_pSiteList[Symbol.iterator]();!(i=(s=r.next()).done);i=!0){var m=s.value;if(m.m_pSerial==t){this.m_pStart=m.m_mPoint.Object;break}}}catch(t){a=!0,o=t}finally{try{!i&&r.return&&r.return()}finally{if(a)throw o}}if(null!=this.m_pStart){var l=this.m_pStart.m_nIndex;this.m_eUsage==NUsageType.Navigation?(this.m_aRouting=[null,null,null,null],this.m_aRouting[0]=this.InitPath2(l,0),0!=n&&(this.m_aRouting[n]=this.InitPath2(l,n))):(this.m_aRouting=[null],this.m_aRouting[0]=this.InitPath2(l,0))}}this.m_bFixedStart&&this.Delink()}else console.error("NNavigator.InitPath(): pStartSerial == null.")}},{key:"InitPath2",value:function(t,e){var n=this.m_aPoint.length,i=new Array(n),a=new Array(n),o=new Array(n),s=new Array(n),r=new Array(n);0==e&&(this.m_aGateType=a);for(var m=0;m<n;m++)r[m]=4294967295,i[m]=268435455,s[m]=!1,a[m]=0,o[m]=0;s[t]=!0,r[t]=0,i[t]=t,a[t]=e,o[t]=268435455;var l=this.m_aPoint[t],h=!0,_=!1,u=void 0;try{for(var c,p=l.m_mAdjoinList[Symbol.iterator]();!(h=(c=p.next()).done);h=!0){var d=c.value,y=d.m_nLength,C=a[t],v=o[t];if(y<0){var f=l.m_mLandmark.Object;0==C?y=1e3:f.m_nType==C?(y=1e3,f.m_nNumber!=v&&(y+=100)):y=1e4,C=f.m_nType,v=f.m_nNumber}var g=d.m_mAdjPoint.Object;r[g.m_nIndex]=y,i[g.m_nIndex]=t,a[g.m_nIndex]=C,o[g.m_nIndex]=v}}catch(t){_=!0,u=t}finally{try{!h&&p.return&&p.return()}finally{if(_)throw u}}for(var T=1;T<n;T++){for(var k=4294967295,S=0,x=0;x<n;x++)0==s[x]&&r[x]<=k&&(k=r[x],S=x);s[S]=!0;var M=this.m_aPoint[S],D=!0,b=!1,P=void 0;try{for(var R,E=M.m_mAdjoinList[Symbol.iterator]();!(D=(R=E.next()).done);D=!0){var w=R.value,I=w.m_nLength,V=a[S],L=o[S];if(I<0){var A=M.m_mLandmark.Object;0==V?I=1e3:A.m_nType==V?(I=1e3,A.m_nNumber!=L&&(I+=100)):I=1e4,V=A.m_nType,L=A.m_nNumber}var H=w.m_mAdjPoint.Object;I+=k,0==s[H.m_nIndex]&&r[H.m_nIndex]>I&&(r[H.m_nIndex]=I,i[H.m_nIndex]=S,a[H.m_nIndex]=V,o[H.m_nIndex]=L)}}catch(t){b=!0,P=t}finally{try{!D&&E.return&&E.return()}finally{if(b)throw P}}}return i}},{key:"Link",value:function(){this.m_pSiteList=new Array,this.m_pGateList=new Array;var t=new Array,e=!0,n=!1,i=void 0;try{for(var a,o=MiaokitDC.DC.m_aWork[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var s=a.value;null!=s&&(s.m_pNavChartDC.m_pLayerMgr.LinkLayers(this.m_eUsage,this.m_pGateList,this.m_pSiteList),s.m_pNavChartDC.m_pLayerMgr.CollectPoint(this.m_eUsage,t))}}catch(t){n=!0,i=t}finally{try{!e&&o.return&&o.return()}finally{if(n)throw i}}this.m_aPoint=t,this.LinkWorks()}},{key:"Delink",value:function(){var t=!0,e=!1,n=void 0;try{for(var i,a=MiaokitDC.DC.m_aWork[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;null!=o&&o.m_pNavChartDC.m_pLayerMgr.DelinkLayers(this.m_eUsage)}}catch(t){e=!0,n=t}finally{try{!t&&a.return&&a.return()}finally{if(e)throw n}}this.DelinkWorks()}},{key:"LinkWorks",value:function(){this.m_pTempAdjoin=new Array;for(var t=0;t<this.m_pGateList.length;t++)for(var e=this.m_pGateList[t],n=t+1;n<this.m_pGateList.length;n++){var i=this.m_pGateList[n];if(e.m_nNumber==i.m_nNumber){var a=1,o=1;if(7==e.m_nType&&7==i.m_nType?(a=-1e3,o=-1e3):5==e.m_nType&&6==i.m_nType?(a=-1e3,o=-1e5):6==e.m_nType&&5==i.m_nType&&(a=-1e5,o=-1e3),a<0&&o<0){var s=e.m_mPoint.Object,r=i.m_mPoint.Object,m=s.m_mAdjoinList.CreateData().Object,l=r.m_mAdjoinList.CreateData().Object;this.m_pTempAdjoin.push(m),this.m_pTempAdjoin.push(l),m.m_mAdjPoint=r.m_mHandle,m.m_nLength=a,m.m_mEdge.Number=0,l.m_mAdjPoint=s.m_mHandle,l.m_nLength=o,l.m_mEdge.Number=0}break}}}},{key:"DelinkWorks",value:function(){if(null!=this.m_pTempAdjoin){var t=!0,e=!1,n=void 0;try{for(var i,a=this.m_pTempAdjoin[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){i.value.m_mHandle.Destroy()}}catch(t){e=!0,n=t}finally{try{!t&&a.return&&a.return()}finally{if(e)throw n}}this.m_pTempAdjoin=null}}},{key:"BindSiteData",value:function(t){if(null!=this.m_pSiteData){var e=!0,n=!1,i=void 0;try{for(var a,o=this.m_pSiteData[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var s=a.value;if(s.roomID==t.m_pSerial)return t.m_pName=s.companyName,t.m_pIconUrl=s.iconUrl,t.m_nIconType=s.HyID,!0}}catch(t){n=!0,i=t}finally{try{!e&&o.return&&o.return()}finally{if(n)throw i}}}return!1}}]),t}(),NPath=function(){function t(){_classCallCheck(this,t),this.m_aPath=null,this.m_pStartPoint=null,this.m_pEndPoint=null,this.m_pObject=null,this.m_nDistance=0,this.m_pPathPassage=[]}return _createClass(t,[{key:"CreateObject",value:function(){var t=MiaokitDC.DC.GetWork(this.m_nWork).m_pNavChartDC.m_pLayerMgr.GetLayer(this.m_nLayer).m_pLayerRoot,e=new GameObject("Path",GameObjectType.Line);e.SetLine(this.m_aPath),e.parent=t,this.m_pObject=e}},{key:"DestoryObject",value:function(){this.m_pObject=null}}]),t}(),PathPassage=function t(){_classCallCheck(this,t),this.m_nDistan=0,this.m_pNextAngle=0},NIconMgr=function(){function t(){_classCallCheck(this,t),this.m_pIconList=null,this.m_pIconList=new Array}return _createClass(t,[{key:"Add",value:function(t,e,n,i){var a=this.m_pIconList[n];null==a&&((a=this.m_pIconList[n]=new NIcon).m_pIconUrl=e,a.m_pObject=new GameObject("",GameObjectType.Point),a.m_pObject.parent=i,MiaokitDC.DC.m_pAssetsLoader.PushIcon(a)),a.m_pPointList.push(new THREE.Vector3(t.x,4,t.z))}}]),t}(),NIcon=function(){function t(){_classCallCheck(this,t),this.m_pIconUrl=null,this.m_pObject=null,this.m_pPointList=[]}return _createClass(t,[{key:"Load",value:function(t){var e=this;MiaokitDC.DC.m_pAssetsLoader.LoadIcon(e.m_pIconUrl,function(n){null!=n&&e.m_pObject.SetPoint(e.m_pPointList,n),t()})}}]),t}(),NMatrix=function(){function t(e,n){_classCallCheck(this,t),this.m=0,this.n=0,this.p=null,this.m=e,this.n=n,this.p=[]}return _createClass(t,null,[{key:"Multiply",value:function(e,n){if(e.n!=n.m)return null;var i=new t(e.m,n.n),a=0,o=0,s=0;for(a=0;a<e.m;a++)for(o=0;o<n.n;o++)for(i.p[a*i.n+o]=0,s=0;s<e.n;s++)i.p[a*i.n+o]+=e.p[a*e.n+s]*n.p[s*n.n+o];return i}},{key:"Transpose",value:function(e){for(var n=new t(e.n,e.m),i=0;i<e.m;i++)for(var a=0;a<e.n;a++)n.p[a*e.m+i]=e.p[i*e.n+a];return n}},{key:"Inverse",value:function(e){var n=new t(e.m,e.n);if(e.m!=e.n)return null;var i=t.Determinant(e);if(0==i)return null;for(var a=0;a<n.m;a++)for(var o=0;o<n.n;o++)if((a+o)%2==0){var s=t.Adjunct(e,a,o);n.p[a*n.m+o]=t.Determinant(s)/i}else{var r=t.Adjunct(e,a,o);n.p[a*n.m+o]=-t.Determinant(r)/i}return t.Transpose(n)}},{key:"Determinant",value:function(e){var n=0;if(e.m!=e.n)return 0;if(1==e.n)return n=e.p[0];for(var i=0;i<e.n;i++)if(i%2==0){var a=t.Adjunct(e,i,0);n+=e.p[i*e.n]*t.Determinant(a)}else{var o=t.Adjunct(e,i,0);n-=e.p[i*e.n]*t.Determinant(o)}return n}},{key:"Adjunct",value:function(e,n,i){for(var a=new t(e.n-1,e.n-1),o=0;o<n;o++){for(var s=0;s<i;s++)a.p[o*(e.n-1)+s]=e.p[o*e.n+s];for(var r=i+1;r<e.n;r++)a.p[o*(e.n-1)+r-1]=e.p[o*e.n+r]}for(var m=n+1;m<e.n;m++){for(var l=0;l<e.n-1;l++)a.p[(m-1)*(e.n-1)+l]=e.p[m*e.n+l];for(var h=i+1;h<e.n;h++)a.p[(m-1)*(e.n-1)+h-1]=e.p[m*e.n+h]}return a}}]),t}(),NLocalization=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"GetLocation",value:function(t){if(null!=Engine.g_pInstance&&null!=Engine.g_pInstance.project&&Engine.g_pInstance.project.TestText2(t),t.length<3)return console.error("NLocalization.GetLocation(): aStation.length < 3."),null;if(3==t.length)return this.Trilateral(t);t.sort(function(t,e){return t.m_nRssi<e.m_nRssi?-1:t.m_nRssi>e.m_nRssi?1:0});for(var e=new Vector3(0,0,0),n=[],i=[0,1,2,0,1,2,0,2,3,1,2,3],a=0;a<4;a++){var o=i[3*a+1],s=i[3*a+2],r=[t[i[3*a]],t[o],t[s]];n[a]=this.Trilateral(r)}return e.x=(8*n[0].x+7*n[1].x+6*n[2].x+5*n[3].x)/26,e.y=(8*n[0].y+7*n[1].y+6*n[2].y+5*n[3].y)/26,e}},{key:"Trilateral",value:function(t){for(var e=new NMatrix(2,2),n=0;n<2;n++)e.p[2*n]=2*(t[n].m_mPosition.x-t[2].m_mPosition.x),e.p[2*n+1]=2*(t[n].m_mPosition.y-t[2].m_mPosition.y);for(var i=new NMatrix(2,1),a=0;a<2;a++)i.p[a]=Math.pow(t[a].m_mPosition.x,2)-Math.pow(t[2].m_mPosition.x,2)+Math.pow(t[a].m_mPosition.y,2)-Math.pow(t[2].m_mPosition.y,2)+Math.pow(t[2].Distance(),2)-Math.pow(t[a].Distance(),2);var o=e,s=NMatrix.Transpose(o),r=NMatrix.Multiply(s,o),m=NMatrix.Inverse(r);if(null!=m){var l=NMatrix.Multiply(m,s),h=NMatrix.Multiply(l,i);return new Vector3(h.p[0],h.p[1],0)}return null}}]),t}(),NBaseStation=function(){function t(){_classCallCheck(this,t),this.m_mPosition=new Vector3(0,0,0),this.m_nRssi=0,this.m_nBase=70,this.m_nFactor=2}return _createClass(t,[{key:"Distance",value:function(){var t=Math.pow(10,(Math.abs(this.m_nRssi)-this.m_nBase)/(10*this.m_nFactor));return t>1.5?(console.info("distance: ",this.m_nRssi,Math.sqrt(t*t-2.25)),Math.sqrt(t*t-2.25)):(console.info("distance_: ",this.m_nRssi,t),0)}}]),t}();